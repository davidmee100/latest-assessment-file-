<html lang="en"><head>
<!-- ZIP.JS LIBRARY (zip-full.min.js) -->
<script>
/* START OF ZIP.JS */
((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).zip={})})(this,function(e){"use strict";const{Array:t,Object:n,String:r,Number:i,BigInt:s,Math:a,Date:o,Map:l,Set:c,Response:d,URL:u,Error:f,Uint8Array:w,Uint16Array:h,Uint32Array:p,DataView:g,Blob:m,Promise:_,TextEncoder:b,TextDecoder:y,document:x,crypto:S,btoa:k,TransformStream:z,ReadableStream:v,WritableStream:A,CompressionStream:C,DecompressionStream:E,navigator:F,Worker:D}="undefined"!=typeof globalThis?globalThis:this||self;var R=void 0!==x?x.currentScript:null;const I=-2;function W(e){return T(e.map(([e,n])=>new t(e).fill(n,0,e)))}function T(e){return e.reduce((e,n)=>e.concat(t.isArray(n)?T(n):n),[])}const L=[0,1,2,3].concat(...W([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function N(){const e=this;function t(e,t){let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}e.build_tree=n=>{const r=e.dyn_tree,i=e.stat_desc.static_tree,s=e.stat_desc.elems;let o,l,c,d=-1;for(n.heap_len=0,n.heap_max=573,o=0;s>o;o++)0!==r[2*o]?(n.heap[++n.heap_len]=d=o,n.depth[o]=0):r[2*o+1]=0;for(;2>n.heap_len;)c=n.heap[++n.heap_len]=2>d?++d:0,r[2*c]=1,n.depth[c]=0,n.opt_len--,i&&(n.static_len-=i[2*c+1]);for(e.max_code=d,o=a.floor(n.heap_len/2);o>=1;o--)n.pqdownheap(r,o);c=s;do{o=n.heap[1],n.heap[1]=n.heap[n.heap_len--],n.pqdownheap(r,1),l=n.heap[1],n.heap[--n.heap_max]=o,n.heap[--n.heap_max]=l,r[2*c]=r[2*o]+r[2*l],n.depth[c]=a.max(n.depth[o],n.depth[l])+1,r[2*o+1]=r[2*l+1]=c,n.heap[1]=c++,n.pqdownheap(r,1)}while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],(t=>{const n=e.dyn_tree,r=e.stat_desc.static_tree,i=e.stat_desc.extra_bits,s=e.stat_desc.extra_base,a=e.stat_desc.max_length;let o,l,c,d,u,f,w=0;for(d=0;15>=d;d++)t.bl_count[d]=0;for(n[2*t.heap[t.heap_max]+1]=0,o=t.heap_max+1;573>o;o++)l=t.heap[o],d=n[2*n[2*l+1]+1]+1,d>a&&(d=a,w++),n[2*l+1]=d,l>e.max_code||(t.bl_count[d]++,u=0,s>l||(u=i[l-s]),f=n[2*l],t.opt_len+=f*(d+u),r&&(t.static_len+=f*(r[2*l+1]+u)));if(0!==w){do{for(d=a-1;0===t.bl_count[d];)d--;t.bl_count[d]--,t.bl_count[d+1]+=2,t.bl_count[a]--,w-=2}while(w>0);for(d=a;0!==d;d--)for(l=t.bl_count[d];0!==l;)c=t.heap[--o],c>e.max_code||(n[2*c+1]!=d&&(t.opt_len+=(d-n[2*c+1])*n[2*c],n[2*c+1]=d),l--)}})(n),((e,n,r)=>{const i=[];let s,a,o,l=0;for(s=1;15>=s;s++)i[s]=l=l+r[s-1]<<1;for(a=0;n>=a;a++)o=e[2*a+1],0!==o&&(e[2*a]=t(i[o]++,o))})(r,e.max_code,n.bl_count)}}function U(e,t,n,r,i){const s=this;s.static_tree=e,s.extra_bits=t,s.extra_base=n,s.elems=r,s.max_length=i}N._length_code=[0,1,2,3,4,5,6,7].concat(...W([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]])),N.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],N.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],N.d_code=e=>256>e?L[e]:L[256+(e>>>7)],N.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],N.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],N.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],N.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];const q=W([[144,8],[112,9],[24,7],[8,8]]);U.static_ltree=T([12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227].map((e,t)=>[e,q[t]]));const O=W([[30,5]]);function P(e,t,n,r,i){const s=this;s.good_length=e,s.max_lazy=t,s.nice_length=n,s.max_chain=r,s.func=i}U.static_dtree=T([0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23].map((e,t)=>[e,O[t]])),U.static_l_desc=new U(U.static_ltree,N.extra_lbits,257,286,15),U.static_d_desc=new U(U.static_dtree,N.extra_dbits,0,30,15),U.static_bl_desc=new U(null,N.extra_blbits,0,19,7);const M=[new P(0,0,0,0,0),new P(4,4,8,4,1),new P(4,5,16,8,1),new P(4,6,32,32,1),new P(4,4,16,16,2),new P(8,16,32,32,2),new P(8,16,128,128,2),new P(8,32,128,256,2),new P(32,128,258,1024,2),new P(32,258,258,4096,2)],H=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],V=113,B=666,j=262;function Z(e,t,n,r){const i=e[2*t],s=e[2*n];return s>i||i==s&&r[t]<=r[n]}function G(){const e=this;let t,n,r,i,s,o,l,c,d,u,f,p,g,m,_,b,y,x,S,k,z,v,A,C,E,F,D,R,W,T,L,q,O;const P=new N,G=new N,Y=new N;let K,X,Q,J,$,ee;function te(){let t;for(t=0;286>t;t++)L[2*t]=0;for(t=0;30>t;t++)q[2*t]=0;for(t=0;19>t;t++)O[2*t]=0;L[512]=1,e.opt_len=e.static_len=0,X=Q=0}function ne(e,t){let n,r=-1,i=e[1],s=0,a=7,o=4;0===i&&(a=138,o=3),e[2*(t+1)+1]=65535;for(let l=0;t>=l;l++)n=i,i=e[2*(l+1)+1],++s<a&&n==i||(o>s?O[2*n]+=s:0!==n?(n!=r&&O[2*n]++,O[32]++):s>10?O[36]++:O[34]++,s=0,r=n,0===i?(a=138,o=3):n==i?(a=6,o=3):(a=7,o=4))}function re(t){e.pending_buf[e.pending++]=t}function ie(e){re(255&e),re(e>>>8&255)}function se(e,t){let n;const r=t;ee>16-r?(n=e,$|=n<<ee&65535,ie($),$=n>>>16-ee,ee+=r-16):($|=e<<ee&65535,ee+=r)}function ae(e,t){const n=2*e;se(65535&t[n],65535&t[n+1])}function oe(e,t){let n,r,i=-1,s=e[1],a=0,o=7,l=4;for(0===s&&(o=138,l=3),n=0;t>=n;n++)if(r=s,s=e[2*(n+1)+1],++a>=o||r!=s){if(l>a)do{ae(r,O)}while(0!==--a);else 0!==r?(r!=i&&(ae(r,O),a--),ae(16,O),se(a-3,2)):a>10?(ae(18,O),se(a-11,7)):(ae(17,O),se(a-3,3));a=0,i=r,0===s?(o=138,l=3):r==s?(o=6,l=3):(o=7,l=4)}}function le(){16==ee?(ie($),$=0,ee=0):8>ee||(re(255&$),$>>>=8,ee-=8)}function ce(t,n){let r,i,s;if(e.dist_buf[X]=t,e.lc_buf[X]=255&n,X++,0===t?L[2*n]++:(Q++,t--,L[2*(N._length_code[n]+256+1)]++,q[2*N.d_code(t)]++),!(8191&X)&&D>2){for(r=8*X,i=z-y,s=0;30>s;s++)r+=q[2*s]*(5+N.extra_dbits[s]);if(r>>>=3,Q<a.floor(X/2)&&r<a.floor(i/2))return!0}return X==K-1}function de(t,n){let r,i,s,a,o=0;if(0!==X)do{r=e.dist_buf[o],i=e.lc_buf[o],o++,0===r?ae(i,t):(s=N._length_code[i],ae(s+256+1,t),a=N.extra_lbits[s],0!==a&&(i-=N.base_length[s],se(i,a)),r--,s=N.d_code(r),ae(s,n),a=N.extra_dbits[s],0!==a&&(r-=N.base_dist[s],se(r,a)))}while(X>o);ae(256,t),J=t[513]}function ue(){ee>8?ie($):ee>0&&re(255&$),$=0,ee=0}function fe(t,n,r){se(0+(r?1:0),3),((t,n)=>{ue(),J=8,ie(n),ie(~n),e.pending_buf.set(c.subarray(t,t+n),e.pending),e.pending+=n})(t,n)}function we(n){((t,n,r)=>{let i,s,a=0;D>0?(P.build_tree(e),G.build_tree(e),a=(()=>{let t;for(ne(L,P.max_code),ne(q,G.max_code),Y.build_tree(e),t=18;t>=3&&0===O[2*N.bl_order[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(),i=e.opt_len+3+7>>>3,s=e.static_len+3+7>>>3,s>i||(i=s)):i=s=n+5,n+4>i||-1==t?s==i?(se(2+(r?1:0),3),de(U.static_ltree,U.static_dtree)):(se(4+(r?1:0),3),((e,t,n)=>{let r;for(se(e-257,5),se(t-1,5),se(n-4,4),r=0;n>r;r++)se(O[2*N.bl_order[r]+1],3);oe(L,e-1),oe(q,t-1)})(P.max_code+1,G.max_code+1,a+1),de(L,q)):fe(t,n,r),te(),r&&ue()})(0>y?-1:y,z-y,n),y=z,t.flush_pending()}function he(){let e,n,r,i;do{if(i=d-A-z,0===i&&0===z&&0===A)i=s;else if(-1==i)i--;else if(z>=s+s-j){c.set(c.subarray(s,s+s),0),v-=s,z-=s,y-=s,e=g,r=e;do{n=65535&f[--r],f[r]=s>n?0:n-s}while(0!==--e);e=s,r=e;do{n=65535&u[--r],u[r]=s>n?0:n-s}while(0!==--e);i+=s}if(0===t.avail_in)return;e=t.read_buf(c,z+A,i),A+=e,3>A||(p=255&c[z],p=(p<<b^255&c[z+1])&_)}while(j>A&&0!==t.avail_in)}function pe(e){let t,n,r=E,i=z,a=C;const o=z>s-j?z-(s-j):0;let d=T;const f=l,w=z+258;let h=c[i+a-1],p=c[i+a];W>C||(r>>=2),d>A&&(d=A);do{if(t=e,c[t+a]==p&&c[t+a-1]==h&&c[t]==c[i]&&c[++t]==c[i+1]){i+=2,t++;do{}while(c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&c[++i]==c[++t]&&w>i);if(n=258-(w-i),i=w-258,n>a){if(v=e,a=n,n>=d)break;h=c[i+a-1],p=c[i+a]}}}while((e=65535&u[e&f])>o&&0!==--r);return a>A?A:a}e.depth=[],e.bl_count=[],e.heap=[],L=[],q=[],O=[],e.pqdownheap=(t,n)=>{const r=e.heap,i=r[n];let s=n<<1;for(;s<=e.heap_len&&(s<e.heap_len&&Z(t,r[s+1],r[s],e.depth)&&s++,!Z(t,i,r[s],e.depth));)r[n]=r[s],n=s,s<<=1;r[n]=i},e.deflateInit=(t,S,v,N,H,B)=>(N||(N=8),H||(H=8),B||(B=0),t.msg=null,-1==S&&(S=6),1>H||H>9||8!=N||9>v||v>15||0>S||S>9||0>B||B>2?I:(t.dstate=e,o=v,s=1<<o,l=s-1,m=H+7,g=1<<m,_=g-1,b=a.floor((m+3-1)/3),c=new w(2*s),u=[],f=[],K=1<<H+6,e.pending_buf=new w(4*K),r=4*K,e.dist_buf=new h(K),e.lc_buf=new w(K),D=S,R=B,(t=>(t.total_in=t.total_out=0,t.msg=null,e.pending=0,e.pending_out=0,n=V,i=0,P.dyn_tree=L,P.stat_desc=U.static_l_desc,G.dyn_tree=q,G.stat_desc=U.static_d_desc,Y.dyn_tree=O,Y.stat_desc=U.static_bl_desc,$=0,ee=0,J=8,te(),(()=>{d=2*s,f[g-1]=0;for(let e=0;g-1>e;e++)f[e]=0;F=M[D].max_lazy,W=M[D].good_length,T=M[D].nice_length,E=M[D].max_chain,z=0,y=0,A=0,x=C=2,k=0,p=0})(),0))(t))),e.deflateEnd=()=>42!=n&&n!=V&&n!=B?I:(e.lc_buf=null,e.dist_buf=null,e.pending_buf=null,f=null,u=null,c=null,e.dstate=null,n==V?-3:0),e.deflateParams=(e,t,n)=>{let r=0;return-1==t&&(t=6),0>t||t>9||0>n||n>2?I:(M[D].func!=M[t].func&&0!==e.total_in&&(r=e.deflate(1)),D!=t&&(D=t,F=M[D].max_lazy,W=M[D].good_length,T=M[D].nice_length,E=M[D].max_chain),R=n,r)},e.deflateSetDictionary=(e,t,r)=>{let i,a=r,o=0;if(!t||42!=n)return I;if(3>a)return 0;for(a>s-j&&(a=s-j,o=r-a),c.set(t.subarray(o,o+a),0),z=a,y=a,p=255&c[0],p=(p<<b^255&c[1])&_,i=0;a-3>=i;i++)p=(p<<b^255&c[i+2])&_,u[i&l]=f[p],f[p]=i;return 0},e.deflate=(a,d)=>{let w,h,m,E,W;if(d>4||0>d)return I;if(!a.next_out||!a.next_in&&0!==a.avail_in||n==B&&4!=d)return a.msg=H[4],I;if(0===a.avail_out)return a.msg=H[7],-5;var T;if(t=a,E=i,i=d,42==n&&(h=8+(o-8<<4)<<8,m=(D-1&255)>>1,m>3&&(m=3),h|=m<<6,0!==z&&(h|=32),h+=31-h%31,n=V,re((T=h)>>8&255),re(255&T)),0!==e.pending){if(t.flush_pending(),0===t.avail_out)return i=-1,0}else if(0===t.avail_in&&E>=d&&4!=d)return t.msg=H[7],-5;if(n==B&&0!==t.avail_in)return a.msg=H[7],-5;if(0!==t.avail_in||0!==A||0!=d&&n!=B){switch(W=-1,M[D].func){case 0:W=(e=>{let n,i=65535;for(i>r-5&&(i=r-5);;){if(1>=A){if(he(),0===A&&0==e)return 0;if(0===A)break}if(z+=A,A=0,n=y+i,(0===z||z>=n)&&(A=z-n,z=n,we(!1),0===t.avail_out))return 0;if(z-y>=s-j&&(we(!1),0===t.avail_out))return 0}return we(4==e),0===t.avail_out?4==e?2:0:4==e?3:1})(d);break;case 1:W=(e=>{let n,r=0;for(;;){if(j>A){if(he(),j>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<b^255&c[z+2])&_,r=65535&f[p],u[z&l]=f[p],f[p]=z),0===r||(z-r&65535)>s-j||2!=R&&(x=pe(r)),3>x)n=ce(0,255&c[z]),A--,z++;else if(n=ce(z-v,x-3),A-=x,x>F||3>A)z+=x,x=0,p=255&c[z],p=(p<<b^255&c[z+1])&_;else{x--;do{z++,p=(p<<b^255&c[z+2])&_,r=65535&f[p],u[z&l]=f[p],f[p]=z}while(0!==--x);z++}if(n&&(we(!1),0===t.avail_out))return 0}return we(4==e),0===t.avail_out?4==e?2:0:4==e?3:1})(d);break;case 2:W=(e=>{let n,r,i=0;for(;;){if(j>A){if(he(),j>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<b^255&c[z+2])&_,i=65535&f[p],u[z&l]=f[p],f[p]=z),C=x,S=v,x=2,0!==i&&F>C&&s-j>=(z-i&65535)&&(2!=R&&(x=pe(i)),5>=x&&(1==R||3==x&&z-v>4096)&&(x=2)),3>C||x>C)if(0!==k){if(n=ce(0,255&c[z-1]),n&&we(!1),z++,A--,0===t.avail_out)return 0}else k=1,z++,A--;else{r=z+A-3,n=ce(z-1-S,C-3),A-=C-1,C-=2;do{++z>r||(p=(p<<b^255&c[z+2])&_,i=65535&f[p],u[z&l]=f[p],f[p]=z)}while(0!==--C);if(k=0,x=2,z++,n&&(we(!1),0===t.avail_out))return 0}}return 0!==k&&(n=ce(0,255&c[z-1]),k=0),we(4==e),0===t.avail_out?4==e?2:0:4==e?3:1})(d)}if(2!=W&&3!=W||(n=B),0==W||2==W)return 0===t.avail_out&&(i=-1),0;if(1==W){if(1==d)se(2,3),ae(256,U.static_ltree),le(),9>1+J+10-ee&&(se(2,3),ae(256,U.static_ltree),le()),J=7;else if(fe(0,0,!1),3==d)for(w=0;g>w;w++)f[w]=0;if(t.flush_pending(),0===t.avail_out)return i=-1,0}}return 4!=d?0:1}}function Y(){const e=this;e.next_in_index=0,e.next_out_index=0,e.avail_in=0,e.total_in=0,e.avail_out=0,e.total_out=0}Y.prototype={deflateInit(e,t){const n=this;return n.dstate=new G,t||(t=15),n.dstate.deflateInit(n,e,t)},deflate(e){const t=this;return t.dstate?t.dstate.deflate(t,e):I},deflateEnd(){const e=this;if(!e.dstate)return I;const t=e.dstate.deflateEnd();return e.dstate=null,t},deflateParams(e,t){const n=this;return n.dstate?n.dstate.deflateParams(n,e,t):I},deflateSetDictionary(e,t){const n=this;return n.dstate?n.dstate.deflateSetDictionary(n,e,t):I},read_buf(e,t,n){const r=this;let i=r.avail_in;return i>n&&(i=n),0===i?0:(r.avail_in-=i,e.set(r.next_in.subarray(r.next_in_index,r.next_in_index+i),t),r.next_in_index+=i,r.total_in+=i,i)},flush_pending(){const e=this;let t=e.dstate.pending;t>e.avail_out&&(t=e.avail_out),0!==t&&(e.next_out.set(e.dstate.pending_buf.subarray(e.dstate.pending_out,e.dstate.pending_out+t),e.next_out_index),e.next_out_index+=t,e.dstate.pending_out+=t,e.total_out+=t,e.avail_out-=t,e.dstate.pending-=t,0===e.dstate.pending&&(e.dstate.pending_out=0))}};const K=-2,X=-3,Q=-5,J=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],$=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],ee=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],te=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],ne=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],re=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ie=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function se(){let e,t,n,r,i,s;function a(e,t,a,o,l,c,d,u,f,w,h){let p,g,m,_,b,y,x,S,k,z,v,A,C,E,F;z=0,b=a;do{n[e[t+z]]++,z++,b--}while(0!==b);if(n[0]==a)return d[0]=-1,u[0]=0,0;for(S=u[0],y=1;15>=y&&0===n[y];y++);for(x=y,y>S&&(S=y),b=15;0!==b&&0===n[b];b--);for(m=b,S>b&&(S=b),u[0]=S,E=1<<y;b>y;y++,E<<=1)if(0>(E-=n[y]))return X;if(0>(E-=n[b]))return X;for(n[b]+=E,s[1]=y=0,z=1,C=2;0!==--b;)s[C]=y+=n[z],C++,z++;b=0,z=0;do{0!==(y=e[t+z])&&(h[s[y]++]=b),z++}while(++b<a);for(a=s[m],s[0]=b=0,z=0,_=-1,A=-S,i[0]=0,v=0,F=0;m>=x;x++)for(p=n[x];0!==p--;){for(;x>A+S;){if(_++,A+=S,F=m-A,F=F>S?S:F,(g=1<<(y=x-A))>p+1&&(g-=p+1,C=x,F>y))for(;++y<F&&(g<<=1)>n[++C];)g-=n[C];if(F=1<<y,w[0]+F>1440)return X;i[_]=v=w[0],w[0]+=F,0!==_?(s[_]=b,r[0]=y,r[1]=S,y=b>>>A-S,r[2]=v-i[_-1]-y,f.set(r,3*(i[_-1]+y))):d[0]=v}for(r[1]=x-A,a>z?h[z]<o?(r[0]=256>h[z]?0:96,r[2]=h[z++]):(r[0]=c[h[z]-o]+16+64,r[2]=l[h[z++]-o]):r[0]=192,g=1<<x-A,y=b>>>A;F>y;y+=g)f.set(r,3*(v+y));for(y=1<<x-1;0!==(b&y);y>>>=1)b^=y;for(b^=y,k=(1<<A)-1;(b&k)!=s[_];)_--,A-=S,k=(1<<A)-1}return 0!==E&&1!=m?Q:0}function o(a){let o;for(e||(e=[],t=[],n=new Int32Array(16),r=[],i=new Int32Array(15),s=new Int32Array(16)),t.length<a&&(t=[]),o=0;a>o;o++)t[o]=0;for(o=0;16>o;o++)n[o]=0;for(o=0;3>o;o++)r[o]=0;i.set(n.subarray(0,15),0),s.set(n.subarray(0,16),0)}this.inflate_trees_bits=(n,r,i,s,l)=>{let c;return o(19),e[0]=0,c=a(n,0,19,19,null,null,i,r,s,e,t),c==X?l.msg="oversubscribed dynamic bit lengths tree":c!=Q&&0!==r[0]||(l.msg="incomplete dynamic bit lengths tree",c=X),c},this.inflate_trees_dynamic=(n,r,i,s,l,c,d,u,f)=>{let w;return o(288),e[0]=0,w=a(i,0,n,257,te,ne,c,s,u,e,t),0!=w||0===s[0]?(w==X?f.msg="oversubscribed literal/length tree":-4!=w&&(f.msg="incomplete literal/length tree",w=X),w):(o(288),w=a(i,n,r,0,re,ie,d,l,u,e,t),0!=w||0===l[0]&&n>257?(w==X?f.msg="oversubscribed distance tree":w==Q?(f.msg="incomplete distance tree",w=X):-4!=w&&(f.msg="empty distance tree with lengths",w=X),w):0)}}function ae(){const e=this;let t,n,r,i,s=0,a=0,o=0,l=0,c=0,d=0,u=0,f=0,w=0,h=0;function p(e,t,n,r,i,s,a,o){let l,c,d,u,f,w,h,p,g,m,_,b,y,x,S,k;h=o.next_in_index,p=o.avail_in,f=a.bitb,w=a.bitk,g=a.write,m=g<a.read?a.read-g-1:a.end-g,_=J[e],b=J[t];do{for(;20>w;)p--,f|=(255&o.read_byte(h++))<<w,w+=8;if(l=f&_,c=n,d=r,k=3*(d+l),0!==(u=c[k]))for(;;){if(f>>=c[k+1],w-=c[k+1],16&u){for(u&=15,y=c[k+2]+(f&J[u]),f>>=u,w-=u;15>w;)p--,f|=(255&o.read_byte(h++))<<w,w+=8;for(l=f&b,c=i,d=s,k=3*(d+l),u=c[k];;){if(f>>=c[k+1],w-=c[k+1],16&u){for(u&=15;u>w;)p--,f|=(255&o.read_byte(h++))<<w,w+=8;if(x=c[k+2]+(f&J[u]),f>>=u,w-=u,m-=y,x>g){S=g-x;do{S+=a.end}while(0>S);if(u=a.end-S,y>u){if(y-=u,g-S>0&&u>g-S)do{a.win[g++]=a.win[S++]}while(0!==--u);else a.win.set(a.win.subarray(S,S+u),g),g+=u,S+=u,u=0;S=0}}else S=g-x,g-S>0&&2>g-S?(a.win[g++]=a.win[S++],a.win[g++]=a.win[S++],y-=2):(a.win.set(a.win.subarray(S,S+2),g),g+=2,S+=2,y-=2);if(g-S>0&&y>g-S)do{a.win[g++]=a.win[S++]}while(0!==--y);else a.win.set(a.win.subarray(S,S+y),g),g+=y,S+=y,y=0;break}if(64&u)return o.msg="invalid distance code",y=o.avail_in-p,y=y>w>>3?w>>3:y,p+=y,h-=y,w-=y<<3,a.bitb=f,a.bitk=w,o.avail_in=p,o.total_in+=h-o.next_in_index,o.next_in_index=h,a.write=g,X;l+=c[k+2],l+=f&J[u],k=3*(d+l),u=c[k]}break}if(64&u)return 32&u?(y=o.avail_in-p,y=y>w>>3?w>>3:y,p+=y,h-=y,w-=y<<3,a.bitb=f,a.bitk=w,o.avail_in=p,o.total_in+=h-o.next_in_index,o.next_in_index=h,a.write=g,1):(o.msg="invalid literal/length code",y=o.avail_in-p,y=y>w>>3?w>>3:y,p+=y,h-=y,w-=y<<3,a.bitb=f,a.bitk=w,o.avail_in=p,o.total_in+=h-o.next_in_index,o.next_in_index=h,a.write=g,X);if(l+=c[k+2],l+=f&J[u],k=3*(d+l),0===(u=c[k])){f>>=c[k+1],w-=c[k+1],a.win[g++]=c[k+2],m--;break}}else f>>=c[k+1],w-=c[k+1],a.win[g++]=c[k+2],m--}while(m>=258&&p>=10);return y=o.avail_in-p,y=y>w>>3?w>>3:y,p+=y,h-=y,w-=y<<3,a.bitb=f,a.bitk=w,o.avail_in=p,o.total_in+=h-o.next_in_index,o.next_in_index=h,a.write=g,0}e.init=(e,s,a,o,l,c)=>{t=0,u=e,f=s,r=a,w=o,i=l,h=c,n=null},e.proc=(e,g,m)=>{let _,b,y,x,S,k,z,v=0,A=0,C=0;for(C=g.next_in_index,x=g.avail_in,v=e.bitb,A=e.bitk,S=e.write,k=S<e.read?e.read-S-1:e.end-S;;)switch(t){case 0:if(k>=258&&x>=10&&(e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,m=p(u,f,r,w,i,h,e,g),C=g.next_in_index,x=g.avail_in,v=e.bitb,A=e.bitk,S=e.write,k=S<e.read?e.read-S-1:e.end-S,0!=m)){t=1==m?7:9;break}o=u,n=r,a=w,t=1;case 1:for(_=o;_>A;){if(0===x)return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);m=0,x--,v|=(255&g.read_byte(C++))<<A,A+=8}if(b=3*(a+(v&J[_])),v>>>=n[b+1],A-=n[b+1],y=n[b],0===y){l=n[b+2],t=6;break}if(16&y){c=15&y,s=n[b+2],t=2;break}if(!(64&y)){o=y,a=b/3+n[b+2];break}if(32&y){t=7;break}return t=9,g.msg="invalid literal/length code",m=X,e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);case 2:for(_=c;_>A;){if(0===x)return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);m=0,x--,v|=(255&g.read_byte(C++))<<A,A+=8}s+=v&J[_],v>>=_,A-=_,o=f,n=i,a=h,t=3;case 3:for(_=o;_>A;){if(0===x)return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);m=0,x--,v|=(255&g.read_byte(C++))<<A,A+=8}if(b=3*(a+(v&J[_])),v>>=n[b+1],A-=n[b+1],y=n[b],16&y){c=15&y,d=n[b+2],t=4;break}if(!(64&y)){o=y,a=b/3+n[b+2];break}return t=9,g.msg="invalid distance code",m=X,e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);case 4:for(_=c;_>A;){if(0===x)return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);m=0,x--,v|=(255&g.read_byte(C++))<<A,A+=8}d+=v&J[_],v>>=_,A-=_,t=5;case 5:for(z=S-d;0>z;)z+=e.end;for(;0!==s;){if(0===k&&(S==e.end&&0!==e.read&&(S=0,k=S<e.read?e.read-S-1:e.end-S),0===k&&(e.write=S,m=e.inflate_flush(g,m),S=e.write,k=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,k=S<e.read?e.read-S-1:e.end-S),0===k)))return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);e.win[S++]=e.win[z++],k--,z==e.end&&(z=0),s--}t=0;break;case 6:if(0===k&&(S==e.end&&0!==e.read&&(S=0,k=S<e.read?e.read-S-1:e.end-S),0===k&&(e.write=S,m=e.inflate_flush(g,m),S=e.write,k=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,k=S<e.read?e.read-S-1:e.end-S),0===k)))return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);m=0,e.win[S++]=l,k--,t=0;break;case 7:if(A>7&&(A-=8,x++,C--),e.write=S,m=e.inflate_flush(g,m),S=e.write,k=S<e.read?e.read-S-1:e.end-S,e.read!=e.write)return e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);t=8;case 8:return m=1,e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);case 9:return m=X,e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m);default:return m=K,e.bitb=v,e.bitk=A,g.avail_in=x,g.total_in+=C-g.next_in_index,g.next_in_index=C,e.write=S,e.inflate_flush(g,m)}},e.free=()=>{}}se.inflate_trees_fixed=(e,t,n,r)=>(e[0]=9,t[0]=5,n[0]=$,r[0]=ee,0);const oe=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function le(e,t){const n=this;let r,i=0,s=0,a=0,o=0;const l=[0],c=[0],d=new ae;let u=0,f=new Int32Array(4320);const h=new se;n.bitk=0,n.bitb=0,n.win=new w(t),n.end=t,n.read=0,n.write=0,n.reset=(e,t)=>{t&&(t[0]=0),6==i&&d.free(e),i=0,n.bitk=0,n.bitb=0,n.read=n.write=0},n.reset(e,null),n.inflate_flush=(e,t)=>{let r,i,s;return i=e.next_out_index,s=n.read,r=(s>n.write?n.end:n.write)-s,r>e.avail_out&&(r=e.avail_out),0!==r&&t==Q&&(t=0),e.avail_out-=r,e.total_out+=r,e.next_out.set(n.win.subarray(s,s+r),i),i+=r,s+=r,s==n.end&&(s=0,n.write==n.end&&(n.write=0),r=n.write-s,r>e.avail_out&&(r=e.avail_out),0!==r&&t==Q&&(t=0),e.avail_out-=r,e.total_out+=r,e.next_out.set(n.win.subarray(s,s+r),i),i+=r,s+=r),e.next_out_index=i,n.read=s,t},n.proc=(e,t)=>{let w,p,g,m,_,b,y,x;for(m=e.next_in_index,_=e.avail_in,p=n.bitb,g=n.bitk,b=n.write,y=b<n.read?n.read-b-1:n.end-b;;){let S,k,z,v,A,C,E,F;switch(i){case 0:for(;3>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}switch(w=7&p,u=1&w,w>>>1){case 0:p>>>=3,g-=3,w=7&g,p>>>=w,g-=w,i=1;break;case 1:S=[],k=[],z=[[]],v=[[]],se.inflate_trees_fixed(S,k,z,v),d.init(S[0],k[0],z[0],0,v[0],0),p>>>=3,g-=3,i=6;break;case 2:p>>>=3,g-=3,i=3;break;case 3:return p>>>=3,g-=3,i=9,e.msg="invalid block type",t=X,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t)}break;case 1:for(;32>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}if((~p>>>16&65535)!=(65535&p))return i=9,e.msg="invalid stored block lengths",t=X,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);s=65535&p,p=g=0,i=0!==s?2:0!==u?7:0;break;case 2:if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);if(0===y&&(b==n.end&&0!==n.read&&(b=0,y=b<n.read?n.read-b-1:n.end-b),0===y&&(n.write=b,t=n.inflate_flush(e,t),b=n.write,y=b<n.read?n.read-b-1:n.end-b,b==n.end&&0!==n.read&&(b=0,y=b<n.read?n.read-b-1:n.end-b),0===y)))return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);if(t=0,w=s,w>_&&(w=_),w>y&&(w=y),n.win.set(e.read_buf(m,w),b),m+=w,_-=w,b+=w,y-=w,0!==(s-=w))break;i=0!==u?7:0;break;case 3:for(;14>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}if(a=w=16383&p,(31&w)>29||(w>>5&31)>29)return i=9,e.msg="too many length or distance symbols",t=X,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);if(w=258+(31&w)+(w>>5&31),!r||r.length<w)r=[];else for(x=0;w>x;x++)r[x]=0;p>>>=14,g-=14,o=0,i=4;case 4:for(;4+(a>>>10)>o;){for(;3>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}r[oe[o++]]=7&p,p>>>=3,g-=3}for(;19>o;)r[oe[o++]]=0;if(l[0]=7,w=h.inflate_trees_bits(r,l,c,f,e),0!=w)return(t=w)==X&&(r=null,i=9),n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);o=0,i=5;case 5:for(;w=a,258+(31&w)+(w>>5&31)>o;){let s,d;for(w=l[0];w>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}if(w=f[3*(c[0]+(p&J[w]))+1],d=f[3*(c[0]+(p&J[w]))+2],16>d)p>>>=w,g-=w,r[o++]=d;else{for(x=18==d?7:d-14,s=18==d?11:3;w+x>g;){if(0===_)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);t=0,_--,p|=(255&e.read_byte(m++))<<g,g+=8}if(p>>>=w,g-=w,s+=p&J[x],p>>>=x,g-=x,x=o,w=a,x+s>258+(31&w)+(w>>5&31)||16==d&&1>x)return r=null,i=9,e.msg="invalid bit length repeat",t=X,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);d=16==d?r[x-1]:0;do{r[x++]=d}while(0!==--s);o=x}}if(c[0]=-1,A=[],C=[],E=[],F=[],A[0]=9,C[0]=6,w=a,w=h.inflate_trees_dynamic(257+(31&w),1+(w>>5&31),r,A,C,E,F,f,e),0!=w)return w==X&&(r=null,i=9),t=w,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);d.init(A[0],C[0],f,E[0],f,F[0]),i=6;case 6:if(n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,1!=(t=d.proc(n,e,t)))return n.inflate_flush(e,t);if(t=0,d.free(e),m=e.next_in_index,_=e.avail_in,p=n.bitb,g=n.bitk,b=n.write,y=b<n.read?n.read-b-1:n.end-b,0===u){i=0;break}i=7;case 7:if(n.write=b,t=n.inflate_flush(e,t),b=n.write,y=b<n.read?n.read-b-1:n.end-b,n.read!=n.write)return n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);i=8;case 8:return t=1,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);case 9:return t=X,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t);default:return t=K,n.bitb=p,n.bitk=g,e.avail_in=_,e.total_in+=m-e.next_in_index,e.next_in_index=m,n.write=b,n.inflate_flush(e,t)}}},n.free=e=>{n.reset(e,null),n.win=null,f=null},n.set_dictionary=(e,t,r)=>{n.win.set(e.subarray(t,t+r),0),n.read=n.write=r},n.sync_point=()=>1==i?1:0}const ce=13,de=[0,0,255,255];function ue(){const e=this;function t(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=7,e.istate.blocks.reset(e,null),0):K}e.mode=0,e.method=0,e.was=[0],e.need=0,e.marker=0,e.wbits=0,e.inflateEnd=t=>(e.blocks&&e.blocks.free(t),e.blocks=null,0),e.inflateInit=(n,r)=>(n.msg=null,e.blocks=null,8>r||r>15?(e.inflateEnd(n),K):(e.wbits=r,n.istate.blocks=new le(n,1<<r),t(n),0)),e.inflate=(e,t)=>{let n,r;if(!e||!e.istate||!e.next_in)return K;const i=e.istate;for(t=4==t?Q:0,n=Q;;)switch(i.mode){case 0:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,8!=(15&(i.method=e.read_byte(e.next_in_index++)))){i.mode=ce,e.msg="unknown compression method",i.marker=5;break}if(8+(i.method>>4)>i.wbits){i.mode=ce,e.msg="invalid win size",i.marker=5;break}i.mode=1;case 1:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,r=255&e.read_byte(e.next_in_index++),((i.method<<8)+r)%31!=0){i.mode=ce,e.msg="incorrect header check",i.marker=5;break}if(!(32&r)){i.mode=7;break}i.mode=2;case 2:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,i.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,i.mode=3;case 3:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,i.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,i.mode=4;case 4:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,i.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,i.mode=5;case 5:return 0===e.avail_in?n:(n=t,e.avail_in--,e.total_in++,i.need+=255&e.read_byte(e.next_in_index++),i.mode=6,2);case 6:return i.mode=ce,e.msg="need dictionary",i.marker=0,K;case 7:if(n=i.blocks.proc(e,n),n==X){i.mode=ce,i.marker=0;break}if(0==n&&(n=t),1!=n)return n;n=t,i.blocks.reset(e,i.was),i.mode=12;case 12:return e.avail_in=0,1;case ce:return X;default:return K}},e.inflateSetDictionary=(e,t,n)=>{let r=0,i=n;if(!e||!e.istate||6!=e.istate.mode)return K;const s=e.istate;return i<1<<s.wbits||(i=(1<<s.wbits)-1,r=n-i),s.blocks.set_dictionary(t,r,i),s.mode=7,0},e.inflateSync=e=>{let n,r,i,s,a;if(!e||!e.istate)return K;const o=e.istate;if(o.mode!=ce&&(o.mode=ce,o.marker=0),0===(n=e.avail_in))return Q;for(r=e.next_in_index,i=o.marker;0!==n&&4>i;)e.read_byte(r)==de[i]?i++:i=0!==e.read_byte(r)?0:4-i,r++,n--;return e.total_in+=r-e.next_in_index,e.next_in_index=r,e.avail_in=n,o.marker=i,4!=i?X:(s=e.total_in,a=e.total_out,t(e),e.total_in=s,e.total_out=a,o.mode=7,0)},e.inflateSyncPoint=e=>e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():K}function fe(){}fe.prototype={inflateInit(e){const t=this;return t.istate=new ue,e||(e=15),t.istate.inflateInit(t,e)},inflate(e){const t=this;return t.istate?t.istate.inflate(t,e):K},inflateEnd(){const e=this;if(!e.istate)return K;const t=e.istate.inflateEnd(e);return e.istate=null,t},inflateSync(){const e=this;return e.istate?e.istate.inflateSync(e):K},inflateSetDictionary(e,t){const n=this;return n.istate?n.istate.inflateSetDictionary(n,e,t):K},read_byte(e){return this.next_in[e]},read_buf(e,t){return this.next_in.subarray(e,e+t)}};const we=4294967295,he=65535,pe=67324752,ge=134695760,me=ge,_e=33639248,be=101010256,ye=101075792,xe=117853008,Se=22,ke=21589,ze=2048,ve="/",Ae=30,Ce=new o(2107,11,31),Ee=new o(1980,0,1),Fe=void 0,De="undefined",Re="function";class Ie{constructor(e){return class extends z{constructor(t,n){const r=new e(n);super({transform(e,t){t.enqueue(r.append(e))},flush(e){const t=r.flush();t&&e.enqueue(t)}})}}}}let We=2;try{typeof F!=De&&F.hardwareConcurrency&&(We=F.hardwareConcurrency)}catch(e){}const Te={chunkSize:524288,maxWorkers:We,terminateWorkerTimeout:5e3,useWebWorkers:!0,useCompressionStream:!0,workerScripts:Fe,CompressionStreamNative:typeof C!=De&&C,DecompressionStreamNative:typeof E!=De&&E},Le=n.assign({},Te);function Ne(){return Le}function Ue(e){return a.max(e.chunkSize,64)}function qe(e){const{baseURL:n,chunkSize:r,maxWorkers:i,terminateWorkerTimeout:s,useCompressionStream:a,useWebWorkers:o,Deflate:l,Inflate:c,CompressionStream:d,DecompressionStream:u,workerScripts:w}=e;if(Oe("baseURL",n),Oe("chunkSize",r),Oe("maxWorkers",i),Oe("terminateWorkerTimeout",s),Oe("useCompressionStream",a),Oe("useWebWorkers",o),l&&(Le.CompressionStream=new Ie(l)),c&&(Le.DecompressionStream=new Ie(c)),Oe("CompressionStream",d),Oe("DecompressionStream",u),w!==Fe){const{deflate:e,inflate:n}=w;if((e||n)&&(Le.workerScripts||(Le.workerScripts={})),e){if(!t.isArray(e))throw new f("workerScripts.deflate must be an array");Le.workerScripts.deflate=e}if(n){if(!t.isArray(n))throw new f("workerScripts.inflate must be an array");Le.workerScripts.inflate=n}}}function Oe(e,t){t!==Fe&&(Le[e]=t)}function Pe(e,t,r){return class{constructor(i){const s=this;var a,o;a=i,o="level",(typeof n.hasOwn===Re?n.hasOwn(a,o):a.hasOwnProperty(o))&&i.level===Fe&&delete i.level,s.codec=new e(n.assign({},t,i)),r(s.codec,e=>{if(s.pendingData){const t=s.pendingData;s.pendingData=new w(t.length+e.length);const{pendingData:n}=s;n.set(t,0),n.set(e,t.length)}else s.pendingData=new w(e)})}append(e){return this.codec.push(e),i(this)}flush(){return this.codec.push(new w,!0),i(this)}};function i(e){if(e.pendingData){const t=e.pendingData;return e.pendingData=null,t}return new w}}const Me=[];for(let e=0;256>e;e++){let t=e;for(let e=0;8>e;e++)1&t?t=t>>>1^3988292384:t>>>=1;Me[e]=t}class He{constructor(e){this.crc=e||-1}append(e){let t=0|this.crc;for(let n=0,r=0|e.length;r>n;n++)t=t>>>8^Me[255&(t^e[n])];this.crc=t}get(){return~this.crc}}class Ve extends z{constructor(){let e;const t=new He;super({transform(e,n){t.append(e),n.enqueue(e)},flush(){const n=new w(4);new g(n.buffer).setUint32(0,t.get()),e.value=n}}),e=this}}function Be(e){if(typeof b==De){const t=new w((e=unescape(encodeURIComponent(e))).length);for(let n=0;n<t.length;n++)t[n]=e.charCodeAt(n);return t}return(new b).encode(e)}const je={concat(e,t){if(0===e.length||0===t.length)return e.concat(t);const n=e[e.length-1],r=je.getPartial(n);return 32===r?e.concat(t):je._shiftRight(t,r,0|n,e.slice(0,e.length-1))},bitLength(e){const t=e.length;if(0===t)return 0;const n=e[t-1];return 32*(t-1)+je.getPartial(n)},clamp(e,t){if(32*e.length<t)return e;const n=(e=e.slice(0,a.ceil(t/32))).length;return t&=31,n>0&&t&&(e[n-1]=je.partial(t,e[n-1]&2147483648>>t-1,1)),e},partial:(e,t,n)=>32===e?t:(n?0|t:t<<32-e)+1099511627776*e,getPartial:e=>a.round(e/1099511627776)||32,_shiftRight(e,t,n,r){for(void 0===r&&(r=[]);t>=32;t-=32)r.push(n),n=0;if(0===t)return r.concat(e);for(let i=0;i<e.length;i++)r.push(n|e[i]>>>t),n=e[i]<<32-t;const i=e.length?e[e.length-1]:0,s=je.getPartial(i);return r.push(je.partial(t+s&31,t+s>32?n:r.pop(),1)),r}},Ze={bytes:{fromBits(e){const t=je.bitLength(e)/8,n=new w(t);let r;for(let i=0;t>i;i++)3&i||(r=e[i/4]),n[i]=r>>>24,r<<=8;return n},toBits(e){const t=[];let n,r=0;for(n=0;n<e.length;n++)r=r<<8|e[n],3&~n||(t.push(r),r=0);return 3&n&&t.push(je.partial(8*(3&n),r)),t}}},Ge=class{constructor(e){const t=this;t.blockSize=512,t._init=[1732584193,4023233417,2562383102,271733878,3285377520],t._key=[1518500249,1859775393,2400959708,3395469782],e?(t._h=e._h.slice(0),t._buffer=e._buffer.slice(0),t._length=e._length):t.reset()}reset(){const e=this;return e._h=e._init.slice(0),e._buffer=[],e._length=0,e}update(e){const t=this;"string"==typeof e&&(e=Ze.utf8String.toBits(e));const n=t._buffer=je.concat(t._buffer,e),r=t._length,i=t._length=r+je.bitLength(e);if(i>9007199254740991)throw new f("Cannot hash more than 2^53 - 1 bits");const s=new p(n);let a=0;for(let e=t.blockSize+r-(t.blockSize+r&t.blockSize-1);i>=e;e+=t.blockSize)t._block(s.subarray(16*a,16*(a+1))),a+=1;return n.splice(0,16*a),t}finalize(){const e=this;let t=e._buffer;const n=e._h;t=je.concat(t,[je.partial(1,1)]);for(let e=t.length+2;15&e;e++)t.push(0);for(t.push(a.floor(e._length/4294967296)),t.push(0|e._length);t.length;)e._block(t.splice(0,16));return e.reset(),n}_f(e,t,n,r){return e>19?e>39?e>59?e>79?void 0:t^n^r:t&n|t&r|n&r:t^n^r:t&n|~t&r}_S(e,t){return t<<e|t>>>32-e}_block(e){const n=this,r=n._h,i=t(80);for(let t=0;16>t;t++)i[t]=e[t];let s=r[0],o=r[1],l=r[2],c=r[3],d=r[4];for(let e=0;79>=e;e++){16>e||(i[e]=n._S(1,i[e-3]^i[e-8]^i[e-14]^i[e-16]));const t=n._S(5,s)+n._f(e,o,l,c)+d+i[e]+n._key[a.floor(e/20)]|0;d=c,c=l,l=n._S(30,o),o=s,s=t}r[0]=r[0]+s|0,r[1]=r[1]+o|0,r[2]=r[2]+l|0,r[3]=r[3]+c|0,r[4]=r[4]+d|0}},Ye={getRandomValues(e){const t=new p(e.buffer),n=e=>{let t=987654321;const n=4294967295;return()=>(t=36969*(65535&t)+(t>>16)&n,(((t<<16)+(e=18e3*(65535&e)+(e>>16)&n)&n)/4294967296+.5)*(a.random()>.5?1:-1))};for(let r,i=0;i<e.length;i+=4){const e=n(4294967296*(r||a.random()));r=987654071*e(),t[i/4]=4294967296*e()|0}return e}},Ke={importKey:e=>new Ke.hmacSha1(Ze.bytes.toBits(e)),pbkdf2(e,t,n,r){if(n=n||1e4,0>r||0>n)throw new f("invalid params to pbkdf2");const i=1+(r>>5)<<2;let s,a,o,l,c;const d=new ArrayBuffer(i),u=new g(d);let w=0;const h=je;for(t=Ze.bytes.toBits(t),c=1;(i||1)>w;c++){for(s=a=e.encrypt(h.concat(t,[c])),o=1;n>o;o++)for(a=e.encrypt(a),l=0;l<a.length;l++)s[l]^=a[l];for(o=0;(i||1)>w&&o<s.length;o++)u.setInt32(w,s[o]),w+=4}return d.slice(0,r/8)},hmacSha1:class{constructor(e){const t=this,n=t._hash=Ge,r=[[],[]];t._baseHash=[new n,new n];const i=t._baseHash[0].blockSize/32;e.length>i&&(e=(new n).update(e).finalize());for(let t=0;i>t;t++)r[0][t]=909522486^e[t],r[1][t]=1549556828^e[t];t._baseHash[0].update(r[0]),t._baseHash[1].update(r[1]),t._resultHash=new n(t._baseHash[0])}reset(){const e=this;e._resultHash=new e._hash(e._baseHash[0]),e._updated=!1}update(e){this._updated=!0,this._resultHash.update(e)}digest(){const e=this,t=e._resultHash.finalize(),n=new e._hash(e._baseHash[1]).update(t).finalize();return e.reset(),n}encrypt(e){if(this._updated)throw new f("encrypt on already updated hmac called!");return this.update(e),this.digest(e)}}},Xe=typeof S!=De&&typeof S.getRandomValues==Re,Qe="Invalid password",Je="Invalid signature",$e="zipjs-abort-check-password";function et(e){return Xe?S.getRandomValues(e):Ye.getRandomValues(e)}const tt=16,nt={name:"PBKDF2"},rt=n.assign({hash:{name:"HMAC"}},nt),it=n.assign({iterations:1e3,hash:{name:"SHA-1"}},nt),st=["deriveBits"],at=[8,12,16],ot=[16,24,32],lt=10,ct=[0,0,0,0],dt=typeof S!=De,ut=dt&&S.subtle,ft=dt&&typeof ut!=De,wt=Ze.bytes,ht=class{constructor(e){const t=this;t._tables=[[[],[],[],[],[]],[[],[],[],[],[]]],t._tables[0][0][0]||t._precompute();const n=t._tables[0][4],r=t._tables[1],i=e.length;let s,a,o,l=1;if(4!==i&&6!==i&&8!==i)throw new f("invalid aes key size");for(t._key=[a=e.slice(0),o=[]],s=i;4*i+28>s;s++){let e=a[s-1];(s%i===0||8===i&&s%i===4)&&(e=n[e>>>24]<<24^n[e>>16&255]<<16^n[e>>8&255]<<8^n[255&e],s%i===0&&(e=e<<8^e>>>24^l<<24,l=l<<1^283*(l>>7))),a[s]=a[s-i]^e}for(let e=0;s;e++,s--){const t=a[3&e?s:s-4];o[e]=4>=s||4>e?t:r[0][n[t>>>24]]^r[1][n[t>>16&255]]^r[2][n[t>>8&255]]^r[3][n[255&t]]}}encrypt(e){return this._crypt(e,0)}decrypt(e){return this._crypt(e,1)}_precompute(){const e=this._tables[0],t=this._tables[1],n=e[4],r=t[4],i=[],s=[];let a,o,l,c;for(let e=0;256>e;e++)s[(i[e]=e<<1^283*(e>>7))^e]=e;for(let d=a=0;!n[d];d^=o||1,a=s[a]||1){let s=a^a<<1^a<<2^a<<3^a<<4;s=s>>8^255&s^99,n[d]=s,r[s]=d,c=i[l=i[o=i[d]]];let u=16843009*c^65537*l^257*o^16843008*d,f=257*i[s]^16843008*s;for(let n=0;4>n;n++)e[n][d]=f=f<<24^f>>>8,t[n][s]=u=u<<24^u>>>8}for(let n=0;5>n;n++)e[n]=e[n].slice(0),t[n]=t[n].slice(0)}_crypt(e,t){if(4!==e.length)throw new f("invalid aes block size");const n=this._key[t],r=n.length/4-2,i=[0,0,0,0],s=this._tables[t],a=s[0],o=s[1],l=s[2],c=s[3],d=s[4];let u,w,h,p=e[0]^n[0],g=e[t?3:1]^n[1],m=e[2]^n[2],_=e[t?1:3]^n[3],b=4;for(let e=0;r>e;e++)u=a[p>>>24]^o[g>>16&255]^l[m>>8&255]^c[255&_]^n[b],w=a[g>>>24]^o[m>>16&255]^l[_>>8&255]^c[255&p]^n[b+1],h=a[m>>>24]^o[_>>16&255]^l[p>>8&255]^c[255&g]^n[b+2],_=a[_>>>24]^o[p>>16&255]^l[g>>8&255]^c[255&m]^n[b+3],b+=4,p=u,g=w,m=h;for(let e=0;4>e;e++)i[t?3&-e:e]=d[p>>>24]<<24^d[g>>16&255]<<16^d[m>>8&255]<<8^d[255&_]^n[b++],u=p,p=g,g=m,m=_,_=u;return i}},pt=class{constructor(e,t){this._prf=e,this._initIv=t,this._iv=t}reset(){this._iv=this._initIv}update(e){return this.calculate(this._prf,e,this._iv)}incWord(e){if(255&~(e>>24))e+=1<<24;else{let t=e>>16&255,n=e>>8&255,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r}return e}incCounter(e){0===(e[0]=this.incWord(e[0]))&&(e[1]=this.incWord(e[1]))}calculate(e,t,n){let r;if(!(r=t.length))return[];const i=je.bitLength(t);for(let i=0;r>i;i+=4){this.incCounter(n);const r=e.encrypt(n);t[i]^=r[0],t[i+1]^=r[1],t[i+2]^=r[2],t[i+3]^=r[3]}return je.clamp(t,i)}},gt=Ke.hmacSha1;let mt=dt&&ft&&typeof ut.importKey==Re,_t=dt&&ft&&typeof ut.deriveBits==Re;class bt extends z{constructor({password:e,rawPassword:t,signed:r,encryptionStrength:i,checkPasswordOnly:s}){super({start(){n.assign(this,{ready:new _(e=>this.resolveReady=e),password:kt(e,t),signed:r,strength:i-1,pending:new w})},async transform(e,t){const n=this,{password:r,strength:i,resolveReady:a,ready:o}=n;r?(await(async(e,t,n,r)=>{const i=await St(e,t,n,vt(r,0,at[t])),s=vt(r,at[t]);if(i[0]!=s[0]||i[1]!=s[1])throw new f(Qe)})(n,i,r,vt(e,0,at[i]+2)),e=vt(e,at[i]+2),s?t.error(new f($e)):a()):await o;const l=new w(e.length-lt-(e.length-lt)%tt);t.enqueue(xt(n,e,l,0,lt,!0))},async flush(e){const{signed:t,ctr:n,hmac:r,pending:i,ready:s}=this;if(r&&n){await s;const a=vt(i,0,i.length-lt),o=vt(i,i.length-lt);let l=new w;if(a.length){const e=Ct(wt,a);r.update(e);const t=n.update(e);l=At(wt,t)}if(t){const e=vt(At(wt,r.digest()),0,lt);for(let t=0;lt>t;t++)if(e[t]!=o[t])throw new f(Je)}e.enqueue(l)}}})}}class yt extends z{constructor({password:e,rawPassword:t,encryptionStrength:r}){let i;super({start(){n.assign(this,{ready:new _(e=>this.resolveReady=e),password:kt(e,t),strength:r-1,pending:new w})},async transform(e,t){const n=this,{password:r,strength:i,resolveReady:s,ready:a}=n;let o=new w;r?(o=await(async(e,t,n)=>{const r=et(new w(at[t]));return zt(r,await St(e,t,n,r))})(n,i,r),s()):await a;const l=new w(o.length+e.length-e.length%tt);l.set(o,0),t.enqueue(xt(n,e,l,o.length,0))},async flush(e){const{ctr:t,hmac:n,pending:r,ready:s}=this;if(n&&t){await s;let a=new w;if(r.length){const e=t.update(Ct(wt,r));n.update(e),a=At(wt,e)}i.signature=At(wt,n.digest()).slice(0,lt),e.enqueue(zt(a,i.signature))}}}),i=this}}function xt(e,t,n,r,i,s){const{ctr:a,hmac:o,pending:l}=e,c=t.length-i;let d;for(l.length&&(t=zt(l,t),n=((e,t)=>{if(t&&t>e.length){const n=e;(e=new w(t)).set(n,0)}return e})(n,c-c%tt)),d=0;c-tt>=d;d+=tt){const e=Ct(wt,vt(t,d,d+tt));s&&o.update(e);const i=a.update(e);s||o.update(i),n.set(At(wt,i),d+r)}return e.pending=vt(t,d),n}async function St(e,r,i,s){e.password=null;const a=await(async(e,t,n,r,i)=>{if(!mt)return Ke.importKey(t);try{return await ut.importKey("raw",t,n,!1,i)}catch(e){return mt=!1,Ke.importKey(t)}})(0,i,rt,0,st),o=await(async(e,t,n)=>{if(!_t)return Ke.pbkdf2(t,e.salt,it.iterations,n);try{return await ut.deriveBits(e,t,n)}catch(r){return _t=!1,Ke.pbkdf2(t,e.salt,it.iterations,n)}})(n.assign({salt:s},it),a,8*(2*ot[r]+2)),l=new w(o),c=Ct(wt,vt(l,0,ot[r])),d=Ct(wt,vt(l,ot[r],2*ot[r])),u=vt(l,2*ot[r]);return n.assign(e,{keys:{key:c,authentication:d,passwordVerification:u},ctr:new pt(new ht(c),t.from(ct)),hmac:new gt(d)}),u}function kt(e,t){return t===Fe?Be(e):t}function zt(e,t){let n=e;return e.length+t.length&&(n=new w(e.length+t.length),n.set(e,0),n.set(t,e.length)),n}function vt(e,t,n){return e.subarray(t,n)}function At(e,t){return e.fromBits(t)}function Ct(e,t){return e.toBits(t)}class Et extends z{constructor({password:e,passwordVerification:t,checkPasswordOnly:r}){super({start(){n.assign(this,{password:e,passwordVerification:t}),It(this,e)},transform(e,t){const n=this;if(n.password){const t=Dt(n,e.subarray(0,12));if(n.password=null,t.at(-1)!=n.passwordVerification)throw new f(Qe);e=e.subarray(12)}r?t.error(new f($e)):t.enqueue(Dt(n,e))}})}}class Ft extends z{constructor({password:e,passwordVerification:t}){super({start(){n.assign(this,{password:e,passwordVerification:t}),It(this,e)},transform(e,t){const n=this;let r,i;if(n.password){n.password=null;const t=et(new w(12));t[11]=n.passwordVerification,r=new w(e.length+t.length),r.set(Rt(n,t),0),i=12}else r=new w(e.length),i=0;r.set(Rt(n,e),i),t.enqueue(r)}})}}function Dt(e,t){const n=new w(t.length);for(let r=0;r<t.length;r++)n[r]=Tt(e)^t[r],Wt(e,n[r]);return n}function Rt(e,t){const n=new w(t.length);for(let r=0;r<t.length;r++)n[r]=Tt(e)^t[r],Wt(e,t[r]);return n}function It(e,t){const r=[305419896,591751049,878082192];n.assign(e,{keys:r,crcKey0:new He(r[0]),crcKey2:new He(r[2])});for(let n=0;n<t.length;n++)Wt(e,t.charCodeAt(n))}function Wt(e,t){let[n,r,i]=e.keys;e.crcKey0.append([t]),n=~e.crcKey0.get(),r=Nt(a.imul(Nt(r+Lt(n)),134775813)+1),e.crcKey2.append([r>>>24]),i=~e.crcKey2.get(),e.keys=[n,r,i]}function Tt(e){const t=2|e.keys[2];return Lt(a.imul(t,1^t)>>>8)}function Lt(e){return 255&e}function Nt(e){return 4294967295&e}const Ut="Invalid uncompressed size",qt="deflate-raw";class Ot extends z{constructor(e,{chunkSize:t,CompressionStream:n,CompressionStreamNative:r}){super({});const{compressed:i,encrypted:s,useCompressionStream:a,zipCrypto:o,signed:l,level:c}=e,d=this;let u,f,w=super.readable;s&&!o||!l||(u=new Ve,w=Vt(w,u)),i&&(w=Ht(w,a,{level:c,chunkSize:t},r,n)),s&&(o?w=Vt(w,new Ft(e)):(f=new yt(e),w=Vt(w,f))),Mt(d,w,()=>{let e;s&&!o&&(e=f.signature),s&&!o||!l||(e=new g(u.value.buffer).getUint32(0)),d.signature=e})}}class Pt extends z{constructor(e,{chunkSize:t,DecompressionStream:n,DecompressionStreamNative:r}){super({});const{zipCrypto:i,encrypted:s,signed:a,signature:o,compressed:l,useCompressionStream:c}=e;let d,u,w=super.readable;s&&(i?w=Vt(w,new Et(e)):(u=new bt(e),w=Vt(w,u))),l&&(w=Ht(w,c,{chunkSize:t},r,n)),s&&!i||!a||(d=new Ve,w=Vt(w,d)),Mt(this,w,()=>{if((!s||i)&&a){const e=new g(d.value.buffer);if(o!=e.getUint32(0,!1))throw new f(Je)}})}}function Mt(e,t,r){t=Vt(t,new z({flush:r})),n.defineProperty(e,"readable",{get:()=>t})}function Ht(e,t,n,r,i){try{e=Vt(e,new(t&&r?r:i)(qt,n))}catch(r){if(!t)throw r;e=Vt(e,new i(qt,n))}return e}function Vt(e,t){return e.pipeThrough(t)}const Bt="data",jt="close",Zt="deflate",Gt="inflate";class Yt extends z{constructor(e,t){super({});const r=this,{codecType:i}=e;let s;i.startsWith(Zt)?s=Ot:i.startsWith(Gt)&&(s=Pt),r.outputSize=0;let a=0;const o=new s(e,t),l=super.readable,c=new z({transform(e,t){e&&e.length&&(a+=e.length,t.enqueue(e))},flush(){n.assign(r,{inputSize:a})}}),d=new z({transform(t,n){if(t&&t.length&&(n.enqueue(t),r.outputSize+=t.length,e.outputSize&&r.outputSize>e.outputSize))throw new f(Ut)},flush(){const{signature:e}=o;n.assign(r,{signature:e,inputSize:a})}});n.defineProperty(r,"readable",{get:()=>l.pipeThrough(c).pipeThrough(o).pipeThrough(d)})}}class Kt extends z{constructor(e){let t;super({transform:function n(r,i){if(t){const e=new w(t.length+r.length);e.set(t),e.set(r,t.length),r=e,t=null}r.length>e?(i.enqueue(r.slice(0,e)),n(r.slice(e),i)):t=r},flush(e){t&&t.length&&e.enqueue(t)}})}}let Xt=typeof D!=De;class Qt{constructor(e,{readable:t,writable:r},{options:i,config:s,streamOptions:a,useWebWorkers:o,transferStreams:l,scripts:c},d){const{signal:u}=a;return n.assign(e,{busy:!0,readable:t.pipeThrough(new Kt(s.chunkSize)).pipeThrough(new Jt(a),{signal:u}),writable:r,options:n.assign({},i),scripts:c,transferStreams:l,terminate:()=>new _(t=>{const{worker:n,busy:r}=e;n?(r?e.resolveTerminated=t:(n.terminate(),t()),e.interface=null):t()}),onTaskFinished(){const{resolveTerminated:t}=e;t&&(e.resolveTerminated=null,e.terminated=!0,e.worker.terminate(),t()),e.busy=!1,d(e)}}),(o&&Xt?tn:en)(e,s)}}class Jt extends z{constructor({onstart:e,onprogress:t,size:n,onend:r}){let i=0;super({async start(){e&&await $t(e,n)},async transform(e,r){i+=e.length,t&&await $t(t,i,n),r.enqueue(e)},async flush(){r&&await $t(r,i)}})}}async function $t(e,...t){try{await e(...t)}catch(e){}}function en(e,t){return{run:()=>(async({options:e,readable:t,writable:n,onTaskFinished:r},i)=>{let s;try{s=new Yt(e,i),await t.pipeThrough(s).pipeTo(n,{preventClose:!0,preventAbort:!0});const{signature:r,inputSize:a,outputSize:o}=s;return{signature:r,inputSize:a,outputSize:o}}catch(e){throw s&&(e.outputSize=s.outputSize),e}finally{r()}})(e,t)}}function tn(e,t){const{baseURL:r,chunkSize:i}=t;if(!e.interface){let s;try{s=((e,t,r)=>{const i={type:"module"};let s,a;typeof e==Re&&(e=e());try{s=new u(e,t)}catch(t){s=e}if(nn)try{a=new D(s)}catch(e){nn=!1,a=new D(s,i)}else a=new D(s,i);return a.addEventListener("message",e=>(async({data:e},t)=>{const{type:r,value:i,messageId:s,result:a,error:o}=e,{reader:l,writer:c,resolveResult:d,rejectResult:u,onTaskFinished:h}=t;try{if(o){const{message:e,stack:t,code:r,name:i,outputSize:s}=o,a=new f(e);n.assign(a,{stack:t,code:r,name:i,outputSize:s}),p(a)}else{if("pull"==r){const{value:e,done:n}=await l.read();sn({type:Bt,value:e,done:n,messageId:s},t)}r==Bt&&(await c.ready,await c.write(new w(i)),sn({type:"ack",messageId:s},t)),r==jt&&p(null,a)}}catch(o){sn({type:jt,messageId:s},t),p(o)}function p(e,t){e?u(e):d(t),c&&c.releaseLock(),h()}})(e,r)),a})(e.scripts[0],r,e)}catch(n){return Xt=!1,en(e,t)}n.assign(e,{worker:s,interface:{run:()=>(async(e,t)=>{let r,i;const s=new _((e,t)=>{r=e,i=t});n.assign(e,{reader:null,writer:null,resolveResult:r,rejectResult:i,result:s});const{readable:a,options:o,scripts:l}=e,{writable:c,closed:d}=(e=>{let t;const n=new _(e=>t=e);return{writable:new A({async write(t){const n=e.getWriter();await n.ready,await n.write(t),n.releaseLock()},close(){t()},abort:t=>e.getWriter().abort(t)}),closed:n}})(e.writable),u=sn({type:"start",scripts:l.slice(1),options:o,config:t,readable:a,writable:c},e);u||n.assign(e,{reader:a.getReader(),writer:c.getWriter()});const f=await s;return u||await c.getWriter().close(),await d,f})(e,{chunkSize:i})}})}return e.interface}let nn=!0,rn=!0;function sn(e,{worker:t,writer:n,onTaskFinished:r,transferStreams:i}){try{const{value:n,readable:r,writable:s}=e,a=[];if(n&&(n.byteLength<n.buffer.byteLength?e.value=n.buffer.slice(0,n.byteLength):e.value=n.buffer,a.push(e.value)),i&&rn?(r&&a.push(r),s&&a.push(s)):e.readable=e.writable=null,a.length)try{return t.postMessage(e,a),!0}catch(n){rn=!1,e.readable=e.writable=null,t.postMessage(e)}else t.postMessage(e)}catch(e){throw n&&n.releaseLock(),r(),e}}let an=[];const on=[];let ln=0;async function cn(e,t){const{options:n,config:r}=t,{transferStreams:s,useWebWorkers:a,useCompressionStream:o,codecType:l,compressed:c,signed:d,encrypted:u}=n,{workerScripts:f,maxWorkers:w}=r;t.transferStreams=s||s===Fe;const h=!(c||d||u||t.transferStreams);return t.useWebWorkers=!h&&(a||a===Fe&&r.useWebWorkers),t.scripts=t.useWebWorkers&&f?f[l]:[],n.useCompressionStream=o||o===Fe&&r.useCompressionStream,(await(async()=>{const n=an.find(e=>!e.busy);if(n)return dn(n),new Qt(n,e,t,p);if(an.length<w){const n={indexWorker:ln};return ln++,an.push(n),new Qt(n,e,t,p)}return new _(n=>on.push({resolve:n,stream:e,workerOptions:t}))})()).run();function p(e){if(on.length){const[{resolve:t,stream:n,workerOptions:r}]=on.splice(0,1);t(new Qt(e,n,r,p))}else e.worker?(dn(e),((e,t)=>{const{config:n}=t,{terminateWorkerTimeout:r}=n;i.isFinite(r)&&r>=0&&(e.terminated?e.terminated=!1:e.terminateTimeout=setTimeout(async()=>{an=an.filter(t=>t!=e);try{await e.terminate()}catch(e){}},r))})(e,t)):an=an.filter(t=>t!=e)}}function dn(e){const{terminateTimeout:t}=e;t&&(clearTimeout(t),e.terminateTimeout=null)}const un="HTTP error ",fn="HTTP Range not supported",wn="Writer iterator completed too soon",hn="Writer not initialized",pn="Range",gn="GET",mn="bytes",_n=65536,bn="writable";class yn{constructor(){this.size=0}init(){this.initialized=!0}}class xn extends yn{get readable(){const e=this,{chunkSize:t=_n}=e,n=new v({start(){this.chunkOffset=0},async pull(r){const{offset:i=0,size:s,diskNumberStart:o}=n,{chunkOffset:l}=this,c=s===Fe?t:a.min(t,s-l),d=await Bn(e,i+l,c,o);r.enqueue(d),l+t>s||s===Fe&&!d.length&&c?r.close():this.chunkOffset+=t}});return n}}class Sn extends yn{constructor(){super();const e=this,t=new A({write(t){if(!e.initialized)throw new f(hn);return e.writeUint8Array(t)}});n.defineProperty(e,bn,{get:()=>t})}writeUint8Array(){}}class kn extends xn{constructor(e){super(),n.assign(this,{blob:e,size:e.size})}async readUint8Array(e,t){const n=this,r=e+t,i=e||r<n.size?n.blob.slice(e,r):n.blob;let s=await i.arrayBuffer();return s.byteLength>t&&(s=s.slice(e,r)),new w(s)}}class zn extends yn{constructor(e){super();const t=new z,r=[];e&&r.push(["Content-Type",e]),n.defineProperty(this,bn,{get:()=>t.writable}),this.blob=new d(t.readable,{headers:r}).blob()}getData(){return this.blob}}class vn extends xn{constructor(e,t){super(),Cn(this,e,t)}async init(){await En(this,Nn,In),super.init()}readUint8Array(e,t){return Fn(this,e,t,Nn,In)}}class An extends xn{constructor(e,t){super(),Cn(this,e,t)}async init(){await En(this,Un,Wn),super.init()}readUint8Array(e,t){return Fn(this,e,t,Un,Wn)}}function Cn(e,t,r){const{preventHeadRequest:i,useRangeHeader:s,forceRangeRequests:a,combineSizeEocd:o}=r;delete(r=n.assign({},r)).preventHeadRequest,delete r.useRangeHeader,delete r.forceRangeRequests,delete r.combineSizeEocd,delete r.useXHR,n.assign(e,{url:t,options:r,preventHeadRequest:i,useRangeHeader:s,forceRangeRequests:a,combineSizeEocd:o})}async function En(e,t,n){const{url:r,preventHeadRequest:s,useRangeHeader:a,forceRangeRequests:o,combineSizeEocd:l}=e;if((e=>{const{baseURL:t}=Ne(),{protocol:n}=new u(e,t);return"http:"==n||"https:"==n})(r)&&(a||o)&&(void 0===s||s)){const r=await t(gn,e,Dn(e,l?-22:void 0));if(!o&&r.headers.get("Accept-Ranges")!=mn)throw new f(fn);{let s;l&&(e.eocdCache=new w(await r.arrayBuffer()));const a=r.headers.get("Content-Range");if(a){const e=a.trim().split(/\s*\/\s*/);if(e.length){const t=e[1];t&&"*"!=t&&(s=i(t))}}s===Fe?await Ln(e,t,n):e.size=s}}else await Ln(e,t,n)}async function Fn(e,t,n,r,i){const{useRangeHeader:s,forceRangeRequests:a,eocdCache:o,size:l,options:c}=e;if(s||a){if(o&&t==l-Se&&n==Se)return o;if(l>t){t+n>l&&(n=l-t);const i=await r(gn,e,Dn(e,t,n));if(206!=i.status)throw new f(fn);return new w(await i.arrayBuffer())}return new w}{const{data:r}=e;return r||await i(e,c),new w(e.data.subarray(t,t+n))}}function Dn(e,t=0,r=1){return n.assign({},Rn(e),{[pn]:mn+"="+(0>t?t:t+"-"+(t+r-1))})}function Rn({options:e}){const{headers:t}=e;if(t)return Symbol.iterator in t?n.fromEntries(t):t}async function In(e){await Tn(e,Nn)}async function Wn(e){await Tn(e,Un)}async function Tn(e,t){const n=await t(gn,e,Rn(e));e.data=new w(await n.arrayBuffer()),e.size||(e.size=e.data.length)}async function Ln(e,t,n){if(e.preventHeadRequest)await n(e,e.options);else{const r=(await t("HEAD",e,Rn(e))).headers.get("Content-Length");r?e.size=i(r):await n(e,e.options)}}async function Nn(e,{options:t,url:r},i){const s=await fetch(r,n.assign({},t,{method:e,headers:i}));if(400>s.status)return s;throw 416==s.status?new f(fn):new f(un+(s.statusText||s.status))}function Un(e,{url:t},r){return new _((i,s)=>{const a=new XMLHttpRequest;if(a.addEventListener("load",()=>{if(400>a.status){const e=[];a.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(t=>{const n=t.trim().split(/\s*:\s*/);n[0]=n[0].trim().replace(/^[a-z]|-[a-z]/g,e=>e.toUpperCase()),e.push(n)}),i({status:a.status,arrayBuffer:()=>a.response,headers:new l(e)})}else s(416==a.status?new f(fn):new f(un+(a.statusText||a.status)))},!1),a.addEventListener("error",e=>s(e.detail?e.detail.error:new f("Network error")),!1),a.open(e,t),r)for(const e of n.entries(r))a.setRequestHeader(e[0],e[1]);a.responseType="arraybuffer",a.send()})}class qn extends xn{constructor(e,t={}){super(),n.assign(this,{url:e,reader:t.useXHR?new An(e,t):new vn(e,t)})}set size(e){}get size(){return this.reader.size}async init(){await this.reader.init(),super.init()}readUint8Array(e,t){return this.reader.readUint8Array(e,t)}}class On extends xn{constructor(e){super(),this.readers=e}async init(){const e=this,{readers:t}=e;e.lastDiskNumber=0,e.lastDiskOffset=0,await _.all(t.map(async(n,r)=>{await n.init(),r!=t.length-1&&(e.lastDiskOffset+=n.size),e.size+=n.size})),super.init()}async readUint8Array(e,t,n=0){const r=this,{readers:i}=this;let s,o=n;-1==o&&(o=i.length-1);let l=e;for(;i[o]&&l>=i[o].size;)l-=i[o].size,o++;const c=i[o];if(c){const i=c.size;if(l+t>i){const a=i-l;s=new w(t);const o=await Bn(c,l,a);s.set(o,0);const d=await r.readUint8Array(e+a,t-a,n);s.set(d,a),o.length+d.length<t&&(s=s.subarray(0,o.length+d.length))}else s=await Bn(c,l,t)}else s=new w;return r.lastDiskNumber=a.max(o,r.lastDiskNumber),s}}class Pn extends yn{constructor(e,t=4294967295){super();const r=this;let i,s,a;n.assign(r,{diskNumber:0,diskOffset:0,size:0,maxSize:t,availableSize:t});const o=new A({async write(t){const{availableSize:n}=r;if(a)t.length<n?await l(t):(await l(t.subarray(0,n)),await c(),r.diskOffset+=i.size,r.diskNumber++,a=null,await this.write(t.subarray(n)));else{const{value:n,done:o}=await e.next();if(o&&!n)throw new f(wn);i=n,i.size=0,i.maxSize&&(r.maxSize=i.maxSize),r.availableSize=r.maxSize,await Vn(i),s=n.writable,a=s.getWriter(),await this.write(t)}},async close(){await a.ready,await c()}});async function l(e){const t=e.length;t&&(await a.ready,await a.write(e),i.size+=t,r.size+=t,r.availableSize-=t)}async function c(){await a.close()}n.defineProperty(r,bn,{get:()=>o})}}class Mn{constructor(e){return t.isArray(e)&&(e=new On(e)),e instanceof v&&(e={readable:e}),e}}class Hn{constructor(e){return e.writable===Fe&&typeof e.next==Re&&(e=new Pn(e)),e instanceof A&&(e={writable:e}),e.size===Fe&&(e.size=0),e instanceof Pn||n.assign(e,{diskNumber:0,diskOffset:0,availableSize:1/0,maxSize:1/0}),e}}async function Vn(e,t){if(!e.init||e.initialized)return _.resolve();await e.init(t)}function Bn(e,t,n,r){return e.readUint8Array(t,n,r)}const jn=On,Zn=Pn,Gn="\0 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ ".split("");function Yn(e,t){return t&&"cp437"==t.trim().toLowerCase()?(e=>{{let t="";for(let n=0;n<e.length;n++)t+=Gn[e[n]];return t}})(e):new y(t).decode(e)}const Kn="filename",Xn="rawFilename",Qn="comment",Jn="rawComment",$n="uncompressedSize",er="compressedSize",tr="offset",nr="diskNumberStart",rr="lastModDate",ir="rawLastModDate",sr="lastAccessDate",ar="creationDate",or="internalFileAttribute",lr="internalFileAttributes",cr="externalFileAttribute",dr="externalFileAttributes",ur="msDosCompatible",fr="zip64",wr="encrypted",hr="version",pr="versionMadeBy",gr="zipCrypto",mr="directory",_r="executable",br="compressionMethod",yr="signature",xr="extraField",Sr=[Kn,Xn,er,$n,rr,ir,Qn,Jn,sr,ar,tr,nr,nr,or,lr,cr,dr,ur,fr,wr,hr,pr,gr,mr,_r,br,yr,xr,"bitFlag","filenameUTF8","commentUTF8","rawExtraField","extraFieldZip64","extraFieldUnicodePath","extraFieldUnicodeComment","extraFieldAES","extraFieldNTFS","extraFieldExtendedTimestamp"];class kr{constructor(e){Sr.forEach(t=>this[t]=e[t])}}const zr="password",vr="rawPassword",Ar="passThrough",Cr="signal",Er="useWebWorkers",Fr="useCompressionStream",Dr="preventClose",Rr="supportZip64SplitFile",Ir="offset",Wr="usdz",Tr="File format is not recognized",Lr="End of central directory not found",Nr="End of Zip64 central directory locator not found",Ur="Central directory header not found",qr="Local file header not found",Or="Zip64 extra field not found",Pr="File contains encrypted entry",Mr="Encryption method not supported",Hr="Compression method not supported",Vr="Split zip file",Br="Overlapping entry found",jr="utf-8",Zr="cp437",Gr=[[$n,we],[er,we],[tr,we],[nr,he]],Yr={[he]:{getValue:si,bytes:4},[we]:{getValue:ai,bytes:8}};class Kr{constructor(e,t={}){n.assign(this,{reader:new Mn(e),options:t,config:Ne(),readRanges:[]})}async*getEntriesGenerator(e={}){const t=this;let{reader:r}=t;const{config:i}=t;if(await Vn(r),r.size!==Fe&&r.readUint8Array||(r=new kn(await new d(r.readable).blob()),await Vn(r)),r.size<Se)throw new f(Tr);r.chunkSize=Ue(i);const s=await(async(e,t,n)=>{const r=new w(4);var i;return i=t,oi(r).setUint32(0,i,!0),await s(22)||await s(a.min(1048582,n));async function s(t){const i=n-t,s=await Bn(e,i,t);for(let e=s.length-22;e>=0;e--)if(s[e]==r[0]&&s[e+1]==r[1]&&s[e+2]==r[2]&&s[e+3]==r[3])return{offset:i+e,buffer:s.slice(e,e+22).buffer}}})(r,be,r.size);if(!s)throw si(oi(await Bn(r,0,4)))==ge?new f(Vr):new f(Lr);const o=oi(s);let l=si(o,12),c=si(o,16);const u=s.offset,h=ii(o,20),p=u+Se+h;let g=ii(o,4);const m=r.lastDiskNumber||0;let b=ii(o,6),y=ii(o,8),x=0,S=0;if(c==we||l==we||y==he||b==he){const e=oi(await Bn(r,s.offset-20,20));if(si(e,0)==xe){c=ai(e,8);let t=await Bn(r,c,56,-1),n=oi(t);const i=s.offset-20-56;if(si(n,0)!=ye&&c!=i){const e=c;c=i,c>e&&(x=c-e),t=await Bn(r,c,56,-1),n=oi(t)}if(si(n,0)!=ye)throw new f(Nr);g==he&&(g=si(n,16)),b==he&&(b=si(n,20)),y==he&&(y=ai(n,32)),l==we&&(l=ai(n,40)),c-=l}}if(c<r.size||(x=r.size-c-l-Se,c=r.size-l-Se),m!=g)throw new f(Vr);if(0>c)throw new f(Tr);let k=0,v=await Bn(r,c,l,b),A=oi(v);if(l){const e=s.offset-l;if(si(A,k)!=_e&&c!=e){const t=c;c=e,c>t&&(x+=c-t),v=await Bn(r,c,l,b),A=oi(v)}}const C=s.offset-c-(r.lastDiskOffset||0);if(l==C||0>C||(l=C,v=await Bn(r,c,l,b),A=oi(v)),0>c||c>=r.size)throw new f(Tr);const E=ei(t,e,"filenameEncoding"),F=ei(t,e,"commentEncoding");for(let s=0;y>s;s++){const o=new Xr(r,i,t.options);if(si(A,k)!=_e)throw new f(Ur);Qr(o,A,k+6);const l=!!o.bitFlag.languageEncodingFlag,c=k+46,u=c+o.filenameLength,w=u+o.extraFieldLength,h=ii(A,k+4),p=!(h>>8),g=h>>8==3,m=v.subarray(c,u),b=ii(A,k+32),C=w+b,D=v.subarray(w,C),R=l,I=l,W=si(A,k+38),T=p&&!(16&~ri(A,k+38))||g&&16384==(W>>16&61440)||m.length&&47==m.at(-1),L=g&&!!(W>>16&73),N=si(A,k+42)+x;n.assign(o,{versionMadeBy:h,msDosCompatible:p,compressedSize:0,uncompressedSize:0,commentLength:b,directory:T,offset:N,diskNumberStart:ii(A,k+34),internalFileAttributes:ii(A,k+36),externalFileAttributes:W,rawFilename:m,filenameUTF8:R,commentUTF8:I,rawExtraField:v.subarray(u,w),executable:L}),o.internalFileAttribute=o.internalFileAttributes,o.externalFileAttribute=o.externalFileAttributes;const U=ei(t,e,"decodeText")||Yn,q=R?jr:E||Zr,O=I?jr:F||Zr;let P=U(m,q);P===Fe&&(P=Yn(m,q));let M=U(D,O);M===Fe&&(M=Yn(D,O)),n.assign(o,{rawComment:D,filename:P,comment:M,directory:T||P.endsWith(ve)}),S=a.max(N,S),Jr(o,o,A,k+6),o.zipCrypto=o.encrypted&&!o.extraFieldAES;const H=new kr(o);H.getData=(e,n)=>o.getData(e,H,t.readRanges,n),H.arrayBuffer=async e=>{const n=new z,[r]=await _.all([new d(n.readable).arrayBuffer(),o.getData(n,H,t.readRanges,e)]);return r},k=C;const{onprogress:V}=e;if(V)try{await V(s+1,y,new kr(o))}catch(e){}yield H}const D=ei(t,e,"extractPrependedData"),R=ei(t,e,"extractAppendedData");return D&&(t.prependedData=S>0?await Bn(r,0,S):new w),t.comment=h?await Bn(r,u+Se,h):new w,R&&(t.appendedData=p<r.size?await Bn(r,p,r.size-p):new w),!0}async getEntries(e={}){const t=[];for await(const n of this.getEntriesGenerator(e))t.push(n);return t}async close(){}}class Xr{constructor(e,t,r){n.assign(this,{reader:e,config:t,options:r})}async getData(e,t,r,i={}){const s=this,{reader:a,offset:o,diskNumberStart:l,extraFieldAES:c,extraFieldZip64:d,compressionMethod:u,config:h,bitFlag:p,signature:g,rawLastModDate:m,uncompressedSize:_,compressedSize:b}=s,{dataDescriptor:y}=p,x=t.localDirectory={},S=oi(await Bn(a,o,Ae,l));let k=ei(s,i,zr),z=ei(s,i,vr);const v=ei(s,i,Ar);if(k=k&&k.length&&k,z=z&&z.length&&z,c&&99!=c.originalCompressionMethod)throw new f(Hr);if(0!=u&&8!=u&&!v)throw new f(Hr);if(si(S,0)!=pe)throw new f(qr);Qr(x,S,4);const{extraFieldLength:C,filenameLength:E,lastAccessDate:F,creationDate:D}=x;x.rawExtraField=C?await Bn(a,o+Ae+E,C,l):new w,Jr(s,x,S,4,!0),n.assign(t,{lastAccessDate:F,creationDate:D});const R=s.encrypted&&x.encrypted&&!v,I=R&&!c;if(v||(t.zipCrypto=I),R){if(!I&&c.strength===Fe)throw new f(Mr);if(!k&&!z)throw new f(Pr)}const W=o+Ae+E+C,T=b,L=a.readable;n.assign(L,{diskNumberStart:l,offset:W,size:T});const N=ei(s,i,Cr),U=ei(s,i,"checkPasswordOnly");let q=ei(s,i,"checkOverlappingEntry");const O=ei(s,i,"checkOverlappingEntryOnly");O&&(q=!0);const{onstart:P,onprogress:M,onend:H}=i,V={options:{codecType:Gt,password:k,rawPassword:z,zipCrypto:I,encryptionStrength:c&&c.strength,signed:ei(s,i,"checkSignature")&&!v,passwordVerification:I&&(y?m>>>8&255:g>>>24&255),outputSize:_,signature:g,compressed:0!=u&&!v,encrypted:s.encrypted&&!v,useWebWorkers:ei(s,i,Er),useCompressionStream:ei(s,i,Fr),transferStreams:ei(s,i,"transferStreams"),checkPasswordOnly:U},config:h,streamOptions:{signal:N,size:T,onstart:P,onprogress:M,onend:H}};let B;q&&await(async({reader:e,fileEntry:t,offset:n,diskNumberStart:r,signature:i,compressedSize:s,uncompressedSize:a,dataOffset:o,dataDescriptor:l,extraFieldZip64:c,readRanges:d})=>{let u=0;if(r)for(let t=0;r>t;t++)u+=e.readers[t].size;let w=0;if(l&&(w=c?20:12),w){const n=await Bn(e,o+s,w+4,r);if(si(oi(n),0)==me){const e=si(oi(n),4);let r,o;c?(r=ai(oi(n),8),o=ai(oi(n),16)):(r=si(oi(n),8),o=si(oi(n),12)),(t.encrypted&&!t.zipCrypto||e==i)&&r==s&&o==a&&(w+=4)}}const h={start:u+n,end:u+o+s+w,fileEntry:t};for(const e of d)if(e.fileEntry!=t&&h.start>=e.start&&h.start<e.end){const t=new f(Br);throw t.overlappingEntry=e.fileEntry,t}d.push(h)})({reader:a,fileEntry:t,offset:o,diskNumberStart:l,signature:g,compressedSize:b,uncompressedSize:_,dataOffset:W,dataDescriptor:y||x.bitFlag.dataDescriptor,extraFieldZip64:d||x.extraFieldZip64,readRanges:r});try{if(!O){U&&(e=new A),e=new Hn(e),await Vn(e,v?b:_),({writable:B}=e);const{outputSize:t}=await cn({readable:L,writable:B},V);if(e.size+=t,t!=(v?b:_))throw new f(Ut)}}catch(t){if(t.outputSize!==Fe&&(e.size+=t.outputSize),!U||t.message!=$e)throw t}finally{ei(s,i,Dr)||!B||B.locked||await B.getWriter().close()}return U||O?Fe:e.getData?e.getData():B}}function Qr(e,t,r){const i=e.rawBitFlag=ii(t,r+2),s=!(1&~i),a=si(t,r+6);n.assign(e,{encrypted:s,version:ii(t,r),bitFlag:{level:(6&i)>>1,dataDescriptor:!(8&~i),languageEncodingFlag:(i&ze)==ze},rawLastModDate:a,lastModDate:ti(a),filenameLength:ii(t,r+22),extraFieldLength:ii(t,r+24)})}function Jr(e,t,r,i,s){const{rawExtraField:a}=t,c=t.extraField=new l,d=oi(new w(a));let u=0;try{for(;u<a.length;){const e=ii(d,u),t=ii(d,u+2);c.set(e,{type:e,data:a.slice(u+4,u+4+t)}),u+=4+t}}catch(e){}const h=ii(r,i+4);n.assign(t,{signature:si(r,i+10),compressedSize:si(r,i+14),uncompressedSize:si(r,i+18)});const p=c.get(1);p&&(((e,t)=>{t.zip64=!0;const n=oi(e.data),r=Gr.filter(([e,n])=>t[e]==n);for(let i=0,s=0;i<r.length;i++){const[a,o]=r[i];if(t[a]==o){const r=Yr[o];t[a]=e[a]=r.getValue(n,s),s+=r.bytes}else if(e[a])throw new f(Or)}})(p,t),t.extraFieldZip64=p);const g=c.get(28789);g&&($r(g,Kn,Xn,t,e),t.extraFieldUnicodePath=g);const m=c.get(25461);m&&($r(m,Qn,Jn,t,e),t.extraFieldUnicodeComment=m);const _=c.get(39169);_?(((e,t,r)=>{const i=oi(e.data),s=ri(i,4);n.assign(e,{vendorVersion:ri(i,0),vendorId:ri(i,2),strength:s,originalCompressionMethod:r,compressionMethod:ii(i,5)}),t.compressionMethod=e.compressionMethod})(_,t,h),t.extraFieldAES=_):t.compressionMethod=h;const b=c.get(10);b&&(((e,t)=>{const r=oi(e.data);let i,s=4;try{for(;s<e.data.length&&!i;){const t=ii(r,s),n=ii(r,s+2);1==t&&(i=e.data.slice(s+4,s+4+n)),s+=4+n}}catch(e){}try{if(i&&24==i.length){const r=oi(i),s=r.getBigUint64(0,!0),a=r.getBigUint64(8,!0),o=r.getBigUint64(16,!0);n.assign(e,{rawLastModDate:s,rawLastAccessDate:a,rawCreationDate:o});const l={lastModDate:ni(s),lastAccessDate:ni(a),creationDate:ni(o)};n.assign(e,l),n.assign(t,l)}}catch(e){}})(b,t),t.extraFieldNTFS=b);const y=c.get(ke);y&&(((e,t,n)=>{const r=oi(e.data),i=ri(r,0),s=[],a=[];n?(1&~i||(s.push(rr),a.push(ir)),2&~i||(s.push(sr),a.push("rawLastAccessDate")),4&~i||(s.push(ar),a.push("rawCreationDate"))):5>e.data.length||(s.push(rr),a.push(ir));let l=1;s.forEach((n,i)=>{if(e.data.length>=l+4){const s=si(r,l);t[n]=e[n]=new o(1e3*s);const c=a[i];e[c]=s}l+=4})})(y,t,s),t.extraFieldExtendedTimestamp=y);const x=c.get(6534);x&&(t.extraFieldUSDZ=x)}function $r(e,t,r,i,s){const a=oi(e.data),o=new He;o.append(s[r]);const l=oi(new w(4));l.setUint32(0,o.get(),!0);const c=si(a,1);n.assign(e,{version:ri(a,0),[t]:Yn(e.data.subarray(5)),valid:!s.bitFlag.languageEncodingFlag&&c==si(l,0)}),e.valid&&(i[t]=e[t],i[t+"UTF8"]=!0)}function ei(e,t,n){return t[n]===Fe?e.options[n]:t[n]}function ti(e){const t=(4294901760&e)>>16,n=65535&e;try{return new o(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(e){}}function ni(e){return new o(i(e/s(1e4)-s(116444736e5)))}function ri(e,t){return e.getUint8(t)}function ii(e,t){return e.getUint16(t,!0)}function si(e,t){return e.getUint32(t,!0)}function ai(e,t){return i(e.getBigUint64(t,!0))}function oi(e){return new g(e.buffer)}const li="File already exists",ci="Zip file comment exceeds 64KB",di="File entry comment exceeds 64KB",ui="File entry name exceeds 64KB",fi="Version exceeds 65535",wi="The strength must equal 1, 2, or 3",hi="Extra field type exceeds 65535",pi="Extra field data exceeds 64KB",gi="Zip64 is not supported (make sure 'keepOrder' is set to 'true')",mi="Undefined uncompressed size",_i="Zip file not empty",bi=new w([7,0,2,0,65,69,3,0,0]);let yi=0;const xi=[];class Si{constructor(e,t={}){const r=(e=new Hn(e)).availableSize!==Fe&&e.availableSize>0&&e.availableSize!==1/0&&e.maxSize!==Fe&&e.maxSize>0&&e.maxSize!==1/0;n.assign(this,{writer:e,addSplitZipSignature:r,options:t,config:Ne(),files:new l,filenames:new c,offset:t[Ir]===Fe?e.size||e.writable.size||0:t[Ir],pendingEntriesSize:0,pendingAddFileCalls:new c,bufferedWrites:0})}async prependZip(e){if(this.filenames.size)throw new f(_i);e=new Mn(e);const t=new Kr(e.readable),r=await t.getEntries();await t.close(),await e.readable.pipeTo(this.writer.writable,{preventClose:!0,preventAbort:!0}),this.writer.size=this.offset=e.size,this.filenames=new c(r.map(e=>e.filename)),this.files=new l(r.map(e=>{const{version:t,compressionMethod:r,lastModDate:i,lastAccessDate:s,creationDate:a,rawFilename:o,bitFlag:l,encrypted:c,uncompressedSize:d,compressedSize:u,diskOffset:f,diskNumber:h,zip64:p}=e;let{rawExtraFieldZip64:g,rawExtraFieldAES:m,rawExtraFieldExtendedTimestamp:_,rawExtraFieldNTFS:b,rawExtraField:y}=e;const{level:x,languageEncodingFlag:S,dataDescriptor:k}=l;g=g||new w,m=m||new w,_=_||new w,b=b||new w,y=y||new w;const z=Ti(g,m,_,b,y),v=p&&d>we,A=p&&u>we,{headerArray:C,headerView:E}=Li({version:t,bitFlag:Ni(x,S,k,c,r),compressionMethod:r,uncompressedSize:d,compressedSize:u,lastModDate:i,rawFilename:o,zip64CompressedSize:A,zip64UncompressedSize:v,extraFieldLength:z});return n.assign(e,{zip64UncompressedSize:v,zip64CompressedSize:A,zip64Offset:p&&this.offset-f>we,zip64DiskNumberStart:p&&h>he,rawExtraFieldZip64:g,rawExtraFieldAES:m,rawExtraFieldExtendedTimestamp:_,rawExtraFieldNTFS:b,rawExtraField:y,extendedTimestamp:_.length>0||b.length>0,extraFieldExtendedTimestampFlag:1+(s?2:0)+(a?4:0),headerArray:C,headerView:E}),[e.filename,e]}))}async add(e="",r,i={}){const l=this,{pendingAddFileCalls:c,config:u}=l;let p;yi<u.maxWorkers?yi++:await new _(e=>xi.push(e));try{if(e=e.trim(),l.filenames.has(e))throw new f(li);return l.filenames.add(e),p=(async(e,r,i,l)=>{r=r.trim();const c=Ai(e,l,ur),u=Ai(e,l,pr,c?20:768),p=Ai(e,l,_r);if(u>he)throw new f(fi);let g=Ai(e,l,dr,0);0===g&&(g=Ai(e,l,cr,0)),!l[mr]&&r.endsWith(ve)&&(l[mr]=!0),Ai(e,l,mr)?(r.endsWith(ve)||(r+=ve),0===g&&(g=16,c||(g|=16877<<16))):c||0!==g||(g=p?493<<16:27525120);const m=Ai(e,l,"encodeText",Be);let b=m(r);if(b===Fe&&(b=Be(r)),Ti(b)>he)throw new f(ui);const y=l[Qn]||"";let x=m(y);if(x===Fe&&(x=Be(y)),Ti(x)>he)throw new f(di);const S=Ai(e,l,hr,20);if(S>he)throw new f(fi);const k=Ai(e,l,rr,new o),v=Ai(e,l,sr),A=Ai(e,l,ar);let C=Ai(e,l,lr,0);0===C&&(C=Ai(e,l,or,0));const E=Ai(e,l,Ar);let F,D;E||(F=Ai(e,l,zr),D=Ai(e,l,vr));const R=Ai(e,l,"encryptionStrength",3),I=Ai(e,l,gr),W=Ai(e,l,"extendedTimestamp",!0),T=Ai(e,l,"keepOrder",!0),L=Ai(e,l,"level"),N=Ai(e,l,Er),U=Ai(e,l,"bufferedWrite"),q=Ai(e,l,"dataDescriptorSignature",!1),O=Ai(e,l,Cr),P=Ai(e,l,"useUnicodeFileNames",!0),M=Ai(e,l,Fr),H=Ai(e,l,br);let V=Ai(e,l,"dataDescriptor");U&&V===Fe&&(V=!1),(V===Fe||I)&&(V=!0);let B=Ai(e,l,fr);if(!I&&(F!==Fe||D!==Fe)&&(1>R||R>3))throw new f(wi);let j=new w;const Z=l[xr];if(Z){let e=0,t=0;Z.forEach(t=>e+=4+Ti(t)),j=new w(e),Z.forEach((e,n)=>{if(n>he)throw new f(hi);if(Ti(e)>he)throw new f(pi);Ii(j,new h([n]),t),Ii(j,new h([Ti(e)]),t+2),Ii(j,e,t+4),t+=4+Ti(e)})}let G=0,Y=0,K=0;if(E&&(K=l[$n],K===Fe))throw new f(mi);const X=!0===B;i&&(i=new Mn(i),await Vn(i),E?(l.uncompressedSize=K,G=Ci(K)):i.size===Fe?(V=!0,(B||B===Fe)&&(B=!0,K=G=4294967296)):(l.uncompressedSize=K=i.size,G=Ci(K)));const{diskOffset:Q,diskNumber:J,maxSize:$}=e.writer,ee=X||K>we,te=X||G>we,ne=X||e.offset+e.pendingEntriesSize-Q>we,re=Ai(e,l,Rr,!0)&&X||J+a.ceil(e.pendingEntriesSize/$)>he;if(ne||ee||te||re){if(!1===B||!T)throw new f(gi);B=!0}B=B||!1;const ie=Ai(e,l,wr),se=(e=>{const{rawFilename:t,lastModDate:n,lastAccessDate:r,creationDate:i,level:o,zip64:l,zipCrypto:c,useUnicodeFileNames:d,dataDescriptor:u,directory:f,rawExtraField:h,encryptionStrength:p,extendedTimestamp:g,passThrough:m,encrypted:_,zip64UncompressedSize:b,zip64CompressedSize:y,zip64Offset:x,zip64DiskNumberStart:S,uncompressedSize:k,offset:z,diskNumberStart:v}=e;let{version:A,compressionMethod:C}=e;const E=!f&&(o>0||o===Fe&&0!==C);let F;const D=m||!E,R=l&&(e.bufferedWrite||!b&&!y||D);if(l){let e=4;b&&(e+=8),y&&(e+=8),x&&(e+=8),S&&(e+=4),F=new w(e);const t=Wi(F);if(Fi(t,0,1),Fi(t,2,Ti(F)-4),R){const e=Wi(F);let t=4;b&&(Ri(e,t,s(k)),t+=8),y&&D&&(Ri(e,t,s(k)),t+=8),x&&(Ri(e,t,s(z)),t+=8),S&&(Di(e,t,v),t+=4)}}else F=new w;let I,W,T,L;if(_&&!c){I=new w(Ti(bi)+2);const e=Wi(I);Fi(e,0,39169),Ii(I,bi,2),Ei(e,8,p)}else I=new w;if(g){T=new w(9+(r?4:0)+(i?4:0));const e=Wi(T);Fi(e,0,ke),Fi(e,2,Ti(T)-4),L=1+(r?2:0)+(i?4:0),Ei(e,4,L);let t=5;Di(e,t,a.floor(n.getTime()/1e3)),t+=4,r&&(Di(e,t,a.floor(r.getTime()/1e3)),t+=4),i&&Di(e,t,a.floor(i.getTime()/1e3));try{W=new w(36);const e=Wi(W),t=vi(n);Fi(e,0,10),Fi(e,2,32),Fi(e,8,1),Fi(e,10,24),Ri(e,12,t),Ri(e,20,vi(r)||t),Ri(e,28,vi(i)||t)}catch(e){W=new w}}else W=T=new w;C===Fe&&(C=E?8:0),l&&(A=A>45?A:45),_&&!c&&(A=A>51?A:51,I[9]=C,C=99);const N=R?Ti(F):0,U=N+Ti(I,T,W,h),{headerArray:q,headerView:O,rawLastModDate:P}=Li({version:A,bitFlag:Ni(o,d,u,_,C),compressionMethod:C,uncompressedSize:k,lastModDate:Ee>n?Ee:n>Ce?Ce:n,rawFilename:t,zip64CompressedSize:y,zip64UncompressedSize:b,extraFieldLength:U});let M=Ae;const H=new w(M+Ti(t)+U),V=Wi(H);return Di(V,0,pe),Ii(H,q,4),Ii(H,t,M),M+=Ti(t),R&&Ii(H,F,M),M+=N,Ii(H,I,M),M+=Ti(I),Ii(H,T,M),M+=Ti(T),Ii(H,W,M),M+=Ti(W),Ii(H,h,M),u&&(Di(V,18,0),Di(V,22,0)),{localHeaderArray:H,localHeaderView:V,headerArray:q,headerView:O,lastModDate:n,rawLastModDate:P,encrypted:_,compressed:E,version:A,compressionMethod:C,extraFieldExtendedTimestampFlag:L,rawExtraFieldZip64:F,localExtraFieldZip64Length:N,rawExtraFieldExtendedTimestamp:T,rawExtraFieldNTFS:W,rawExtraFieldAES:I,extraFieldLength:U}})(l=n.assign({},l,{rawFilename:b,rawComment:x,version:S,versionMadeBy:u,lastModDate:k,lastAccessDate:v,creationDate:A,rawExtraField:j,zip64:B,zip64UncompressedSize:ee,zip64CompressedSize:te,zip64Offset:ne,zip64DiskNumberStart:re,password:F,rawPassword:D,level:M||e.config.CompressionStream!==Fe||e.config.CompressionStreamNative!==Fe?L:0,useWebWorkers:N,encryptionStrength:R,extendedTimestamp:W,zipCrypto:I,bufferedWrite:U,keepOrder:T,useUnicodeFileNames:P,dataDescriptor:V,dataDescriptorSignature:q,signal:O,msDosCompatible:c,internalFileAttribute:C,internalFileAttributes:C,externalFileAttribute:g,externalFileAttributes:g,useCompressionStream:M,passThrough:E,encrypted:!!(F&&Ti(F)||D&&Ti(D))||E&&ie,signature:l[yr],compressionMethod:H,uncompressedSize:K,offset:e.offset-Q,diskNumberStart:J})),ae=(({zip64:e,dataDescriptor:t,dataDescriptorSignature:n})=>{let r,i=new w,s=0,a=e?20:12;return n&&(a+=4),t&&(i=new w(a),r=Wi(i),n&&(s=4,Di(r,0,me))),{dataDescriptorArray:i,dataDescriptorView:r,dataDescriptorOffset:s}})(l),oe=Ti(se.localHeaderArray,ae.dataDescriptorArray);let le;Y=oe+G,e.options[Wr]&&(Y+=Y+64),e.pendingEntriesSize+=Y;try{le=await(async(e,r,i,a,o)=>{const{files:l,writer:c}=e,{keepOrder:u,dataDescriptor:h,signal:p}=o,{headerInfo:g}=a,m=e.options[Wr],b=t.from(l.values()).pop();let y,x,S,k,v,A,C,E={};l.set(r,E);try{let t;u&&(t=b&&b.lock,E.lock=new _(e=>S=e)),!(o.bufferedWrite||e.writerLocked||e.bufferedWrites&&u)&&h||m?(A=c,await F()):(A=new z,A.size=0,y=!0,e.bufferedWrites++,await Vn(c)),await Vn(A);const{writable:x,diskOffset:R}=c;if(e.addSplitZipSignature){delete e.addSplitZipSignature;const t=new w(4);Di(Wi(t),0,ge),await zi(c,t),e.offset+=4}m&&((e,t)=>{const{headerInfo:n}=e;let{localHeaderArray:r,extraFieldLength:i}=n,s=Wi(r),a=64-(t+Ti(r))%64;4>a&&(a+=64);const o=new w(a),l=Wi(o);Fi(l,0,6534),Fi(l,2,a-2);const c=r;n.localHeaderArray=r=new w(Ti(c)+a),Ii(r,c),Ii(r,o,Ti(c)),s=Wi(r),Fi(s,28,i+a),e.metadataSize+=a})(a,e.offset-R);const{localHeaderView:I,localHeaderArray:W}=g;y||(await t,await D(x));const{diskNumber:T}=c;v=!0,E.diskNumberStart=T,y?C=new d(A.readable).blob():await zi(A,W),E=await(async(e,t,{diskNumberStart:r,lock:i},a,o,l)=>{const{headerInfo:c,dataDescriptorInfo:d,metadataSize:u}=a,{headerArray:f,headerView:w,lastModDate:h,rawLastModDate:p,encrypted:g,compressed:m,version:_,compressionMethod:b,rawExtraFieldZip64:y,localExtraFieldZip64Length:x,rawExtraFieldExtendedTimestamp:S,extraFieldExtendedTimestampFlag:k,rawExtraFieldNTFS:z,rawExtraFieldAES:v}=c,{dataDescriptorArray:A}=d,{rawFilename:C,lastAccessDate:E,creationDate:F,password:D,rawPassword:R,level:I,zip64:W,zip64UncompressedSize:T,zip64CompressedSize:L,zip64Offset:N,zip64DiskNumberStart:U,zipCrypto:q,dataDescriptor:O,directory:P,executable:M,versionMadeBy:H,rawComment:V,rawExtraField:B,useWebWorkers:j,onstart:Z,onprogress:G,onend:Y,signal:K,encryptionStrength:X,extendedTimestamp:Q,msDosCompatible:J,internalFileAttributes:$,externalFileAttributes:ee,useCompressionStream:te,passThrough:ne}=l,re={lock:i,versionMadeBy:H,zip64:W,directory:!!P,executable:!!M,filenameUTF8:!0,rawFilename:C,commentUTF8:!0,rawComment:V,rawExtraFieldZip64:y,localExtraFieldZip64Length:x,rawExtraFieldExtendedTimestamp:S,rawExtraFieldNTFS:z,rawExtraFieldAES:v,rawExtraField:B,extendedTimestamp:Q,msDosCompatible:J,internalFileAttributes:$,externalFileAttributes:ee,diskNumberStart:r};let{signature:ie,uncompressedSize:se}=l,ae=0;ne||(se=0);const{writable:oe}=t;if(e){e.chunkSize=Ue(o);const n=e.readable,r=e.size,i={options:{codecType:Zt,level:I,rawPassword:R,password:D,encryptionStrength:X,zipCrypto:g&&q,passwordVerification:g&&q&&p>>8&255,signed:!ne,compressed:m&&!ne,encrypted:g&&!ne,useWebWorkers:j,useCompressionStream:te,transferStreams:!1},config:o,streamOptions:{signal:K,size:r,onstart:Z,onprogress:G,onend:Y}};try{const e=await cn({readable:n,writable:oe},i);ae=e.outputSize,t.size+=ae,ne||(se=e.inputSize,ie=e.signature)}catch(e){throw e.outputSize!==Fe&&(t.size+=e.outputSize),e}}return(({signature:e,compressedSize:t,uncompressedSize:n,headerInfo:r,dataDescriptorInfo:i},{zip64:a,zipCrypto:o,dataDescriptor:l})=>{const{headerView:c,encrypted:d}=r,{dataDescriptorView:u,dataDescriptorOffset:f}=i;d&&!o||e===Fe||(Di(c,10,e),l&&Di(u,f,e)),a?l&&(Ri(u,f+4,s(t)),Ri(u,f+12,s(n))):(Di(c,14,t),Di(c,18,n),l&&(Di(u,f+4,t),Di(u,f+8,n)))})({signature:ie,compressedSize:ae,uncompressedSize:se,headerInfo:c,dataDescriptorInfo:d},l),O&&await zi(t,A),n.assign(re,{uncompressedSize:se,compressedSize:ae,lastModDate:h,rawLastModDate:p,creationDate:F,lastAccessDate:E,encrypted:g,zipCrypto:q,size:u+ae,compressionMethod:b,version:_,headerArray:f,headerView:w,signature:ie,extraFieldExtendedTimestampFlag:k,zip64UncompressedSize:T,zip64CompressedSize:L,zip64Offset:N,zip64DiskNumberStart:U}),re})(i,A,E,a,e.config,o);const{zip64:L}=E;if(v=!1,l.set(r,E),E.filename=r,y){const[n]=await _.all([C,A.writable.getWriter().close(),t]);await F(),k=!0,E.diskNumberStart=c.diskNumber,E.offset=e.offset-c.diskOffset,L&&ki(E),(({rawFilename:e,encrypted:t,zip64:n,localExtraFieldZip64Length:r,signature:i,compressedSize:a,uncompressedSize:o,offset:l,diskNumberStart:c,zip64UncompressedSize:d,zip64CompressedSize:u,zip64Offset:f,zip64DiskNumberStart:w},h,{dataDescriptor:p})=>{if(p||(t||Di(h,14,i),n||(Di(h,18,a),Di(h,22,o))),n&&r){let t=Ae+Ti(e)+4;d&&(Ri(h,t,s(o)),t+=8),u&&(Ri(h,t,s(a)),t+=8),f&&(Ri(h,t,s(l)),t+=8),w&&Di(h,t,c)}})(E,I,o),await D(x),await zi(c,W),await n.stream().pipeTo(x,{preventClose:!0,preventAbort:!0,signal:p}),c.size+=A.size,k=!1}else E.offset=e.offset-R,L&&ki(E);if(E.offset>we&&!L)throw new f(gi);return e.offset+=E.size,E}catch(t){if(y&&k||!y&&v){if(e.hasCorruptedEntries=!0,t)try{t.corruptedEntry=!0}catch(e){}y?e.offset+=A.size:e.offset=A.size}throw l.delete(r),t}finally{y&&e.bufferedWrites--,S&&S(),x&&x()}async function F(){e.writerLocked=!0;const{lockWriter:t}=e;e.lockWriter=new _(t=>x=()=>{e.writerLocked=!1,t()}),await t}async function D(e){Ti(g.localHeaderArray)>c.availableSize&&(c.availableSize=0,await zi(e,new w))}})(e,r,i,{headerInfo:se,dataDescriptorInfo:ae,metadataSize:oe},l)}finally{e.pendingEntriesSize-=Y}return n.assign(le,{name:r,comment:y,extraField:Z}),new kr(le)})(l,e,r,i),c.add(p),await p}catch(t){throw l.filenames.delete(e),t}finally{c.delete(p);const e=xi.shift();e?e():yi--}}remove(e){const{filenames:t,files:n}=this;if("string"==typeof e&&(e=n.get(e)),e&&e.filename!==Fe){const{filename:r}=e;if(t.has(r)&&n.has(r))return t.delete(r),n.delete(r),!0}return!1}async close(e=new w,n={}){const{pendingAddFileCalls:r,writer:i}=this,{writable:o}=i;for(;r.size;)await _.allSettled(t.from(r));return await(async(e,n,r)=>{const{files:i,writer:o}=e,{diskOffset:l}=o;let{diskNumber:c}=o,d=0,u=0,h=e.offset-l,p=i.size;for(const[,e]of i){const{rawFilename:t,rawExtraFieldZip64:n,rawExtraFieldAES:r,rawComment:i,rawExtraFieldNTFS:s,rawExtraField:o,extendedTimestamp:l,extraFieldExtendedTimestampFlag:c,lastModDate:d}=e;let f;if(l){f=new w(9);const e=Wi(f);Fi(e,0,ke),Fi(e,2,5),Ei(e,4,c),Di(e,5,a.floor(d.getTime()/1e3))}else f=new w;e.rawExtraFieldExtendedTimestamp=f,u+=46+Ti(t,i,n,r,s,f,o)}const g=new w(u),m=Wi(g);await Vn(o);let _=0;for(const[e,n]of t.from(i.values()).entries()){const{offset:t,rawFilename:s,rawExtraFieldZip64:a,rawExtraFieldAES:l,rawExtraFieldExtendedTimestamp:c,rawExtraFieldNTFS:u,rawExtraField:f,rawComment:w,versionMadeBy:h,headerArray:p,headerView:b,zip64:y,zip64UncompressedSize:x,zip64CompressedSize:S,zip64DiskNumberStart:k,zip64Offset:z,internalFileAttributes:v,externalFileAttributes:A,diskNumberStart:C,uncompressedSize:E,compressedSize:F}=n,D=Ti(a,l,c,u,f);Di(m,d,_e),Fi(m,d+4,h),x||Di(b,18,E),S||Di(b,14,F),Ii(g,p,d+6);let R=d+Ae;if(Fi(m,R,D),R+=2,Fi(m,R,Ti(w)),R+=2,Fi(m,R,y&&k?he:C),R+=2,Fi(m,R,v),R+=2,A&&Di(m,R,A),R+=4,Di(m,R,y&&z?we:t),R+=4,Ii(g,s,R),R+=Ti(s),Ii(g,a,R),R+=Ti(a),Ii(g,l,R),R+=Ti(l),Ii(g,c,R),R+=Ti(c),Ii(g,u,R),R+=Ti(u),Ii(g,f,R),R+=Ti(f),Ii(g,w,R),d-_>o.availableSize&&(o.availableSize=0,await zi(o,g.slice(_,d)),_=d),d=R,r.onprogress)try{await r.onprogress(e+1,i.size,new kr(n))}catch(e){}}await zi(o,_?g.slice(_):g);let b=o.diskNumber;const{availableSize:y}=o;Se>y&&b++;let x=Ai(e,r,fr);if(h>we||u>we||p>he||b>he){if(!1===x)throw new f(gi);x=!0}const S=new w(x?98:Se),k=Wi(S);d=0,x&&(Di(k,0,ye),Ri(k,4,s(44)),Fi(k,12,45),Fi(k,14,45),Di(k,16,b),Di(k,20,c),Ri(k,24,s(p)),Ri(k,32,s(p)),Ri(k,40,s(u)),Ri(k,48,s(h)),Di(k,56,xe),Ri(k,64,s(h)+s(u)),Di(k,72,b+1),Ai(e,r,Rr,!0)&&(b=he,c=he),p=he,h=we,u=we,d+=76),Di(k,d,be),Fi(k,d+4,b),Fi(k,d+6,c),Fi(k,d+8,p),Fi(k,d+10,p),Di(k,d+12,u),Di(k,d+16,h);const z=Ti(n);if(z){if(z>he)throw new f(ci);Fi(k,d+20,z)}await zi(o,S),z&&await zi(o,n)})(this,e,n),Ai(this,n,Dr)||await o.getWriter().close(),i.getData?i.getData():o}}function ki({compressedSize:e,uncompressedSize:t,offset:n,diskNumberStart:r,zip64UncompressedSize:i,zip64CompressedSize:a,zip64Offset:o,zip64DiskNumberStart:l,rawExtraFieldZip64:c}){const d=Wi(c);let u=4;i&&(Ri(d,u,s(t)),u+=8),a&&(Ri(d,u,s(e)),u+=8),o&&(Ri(d,u,s(n)),u+=8),l&&Di(d,u,r)}async function zi(e,t){const{writable:n}=e,r=n.getWriter();try{await r.ready,e.size+=Ti(t),await r.write(t)}finally{r.releaseLock()}}function vi(e){if(e)return(s(e.getTime())+s(116444736e5))*s(1e4)}function Ai(e,t,n,r){const i=t[n]===Fe?e.options[n]:t[n];return i===Fe?r:i}function Ci(e){return e+5*(a.floor(e/16383)+1)}function Ei(e,t,n){e.setUint8(t,n)}function Fi(e,t,n){e.setUint16(t,n,!0)}function Di(e,t,n){e.setUint32(t,n,!0)}function Ri(e,t,n){e.setBigUint64(t,n,!0)}function Ii(e,t,n){e.set(t,n)}function Wi(e){return new g(e.buffer)}function Ti(...e){let t=0;return e.forEach(e=>e&&(t+=e.length)),t}function Li({version:e,bitFlag:t,compressionMethod:n,uncompressedSize:r,compressedSize:i,lastModDate:s,rawFilename:a,zip64CompressedSize:o,zip64UncompressedSize:l,extraFieldLength:c}){const d=new w(26),u=Wi(d);Fi(u,0,e),Fi(u,2,t),Fi(u,4,n);const f=new p(1),h=Wi(f);Fi(h,0,(s.getHours()<<6|s.getMinutes())<<5|s.getSeconds()/2),Fi(h,2,(s.getFullYear()-1980<<4|s.getMonth()+1)<<5|s.getDate());const g=f[0];return Di(u,6,g),(o||i!==Fe)&&Di(u,14,o?we:i),(l||r!==Fe)&&Di(u,18,l?we:r),Fi(u,22,Ti(a)),Fi(u,24,c),{headerArray:d,headerView:u,rawLastModDate:g}}function Ni(e,t,n,r,i){let s=0;return t&&(s|=ze),n&&(s|=8),8!=i&&9!=i||(0>e||e>3||(s|=6),e>3&&5>=e&&(s|=4),9==e&&(s|=2)),r&&(s|=1),s}let Ui;try{Ui=void 0===x&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:void 0===x?location.href:R&&"SCRIPT"===R.tagName.toUpperCase()&&R.src||new u("zip-full.min.js",x.baseURI).href}catch(e){}((e,t={})=>{const n='const{Array:e,Object:t,Number:n,Math:r,Error:s,Uint8Array:i,Uint16Array:o,Uint32Array:c,Int32Array:f,Map:a,DataView:l,Promise:u,TextEncoder:w,crypto:h,postMessage:d,TransformStream:p,ReadableStream:y,WritableStream:m,CompressionStream:b,DecompressionStream:g}=self,k=void 0,v="undefined",S="function";class z{constructor(e){return class extends p{constructor(t,n){const r=new e(n);super({transform(e,t){t.enqueue(r.append(e))},flush(e){const t=r.flush();t&&e.enqueue(t)}})}}}}const C=[];for(let e=0;256>e;e++){let t=e;for(let e=0;8>e;e++)1&t?t=t>>>1^3988292384:t>>>=1;C[e]=t}class x{constructor(e){this.t=e||-1}append(e){let t=0|this.t;for(let n=0,r=0|e.length;r>n;n++)t=t>>>8^C[255&(t^e[n])];this.t=t}get(){return~this.t}}class A extends p{constructor(){let e;const t=new x;super({transform(e,n){t.append(e),n.enqueue(e)},flush(){const n=new i(4);new l(n.buffer).setUint32(0,t.get()),e.value=n}}),e=this}}const I={concat(e,t){if(0===e.length||0===t.length)return e.concat(t);const n=e[e.length-1],r=I.i(n);return 32===r?e.concat(t):I.o(t,r,0|n,e.slice(0,e.length-1))},l(e){const t=e.length;if(0===t)return 0;const n=e[t-1];return 32*(t-1)+I.i(n)},u(e,t){if(32*e.length<t)return e;const n=(e=e.slice(0,r.ceil(t/32))).length;return t&=31,n>0&&t&&(e[n-1]=I.h(t,e[n-1]&2147483648>>t-1,1)),e},h:(e,t,n)=>32===e?t:(n?0|t:t<<32-e)+1099511627776*e,i:e=>r.round(e/1099511627776)||32,o(e,t,n,r){for(void 0===r&&(r=[]);t>=32;t-=32)r.push(n),n=0;if(0===t)return r.concat(e);for(let s=0;s<e.length;s++)r.push(n|e[s]>>>t),n=e[s]<<32-t;const s=e.length?e[e.length-1]:0,i=I.i(s);return r.push(I.h(t+i&31,t+i>32?n:r.pop(),1)),r}},_={bytes:{p(e){const t=I.l(e)/8,n=new i(t);let r;for(let s=0;t>s;s++)3&s||(r=e[s/4]),n[s]=r>>>24,r<<=8;return n},m(e){const t=[];let n,r=0;for(n=0;n<e.length;n++)r=r<<8|e[n],3&~n||(t.push(r),r=0);return 3&n&&t.push(I.h(8*(3&n),r)),t}}},P=class{constructor(e){const t=this;t.blockSize=512,t.k=[1732584193,4023233417,2562383102,271733878,3285377520],t.v=[1518500249,1859775393,2400959708,3395469782],e?(t.S=e.S.slice(0),t.C=e.C.slice(0),t.A=e.A):t.reset()}reset(){const e=this;return e.S=e.k.slice(0),e.C=[],e.A=0,e}update(e){const t=this;"string"==typeof e&&(e=_.I.m(e));const n=t.C=I.concat(t.C,e),r=t.A,i=t.A=r+I.l(e);if(i>9007199254740991)throw new s("Cannot hash more than 2^53 - 1 bits");const o=new c(n);let f=0;for(let e=t.blockSize+r-(t.blockSize+r&t.blockSize-1);i>=e;e+=t.blockSize)t._(o.subarray(16*f,16*(f+1))),f+=1;return n.splice(0,16*f),t}P(){const e=this;let t=e.C;const n=e.S;t=I.concat(t,[I.h(1,1)]);for(let e=t.length+2;15&e;e++)t.push(0);for(t.push(r.floor(e.A/4294967296)),t.push(0|e.A);t.length;)e._(t.splice(0,16));return e.reset(),n}D(e,t,n,r){return e>19?e>39?e>59?e>79?void 0:t^n^r:t&n|t&r|n&r:t^n^r:t&n|~t&r}V(e,t){return t<<e|t>>>32-e}_(t){const n=this,s=n.S,i=e(80);for(let e=0;16>e;e++)i[e]=t[e];let o=s[0],c=s[1],f=s[2],a=s[3],l=s[4];for(let e=0;79>=e;e++){16>e||(i[e]=n.V(1,i[e-3]^i[e-8]^i[e-14]^i[e-16]));const t=n.V(5,o)+n.D(e,c,f,a)+l+i[e]+n.v[r.floor(e/20)]|0;l=a,a=f,f=n.V(30,c),c=o,o=t}s[0]=s[0]+o|0,s[1]=s[1]+c|0,s[2]=s[2]+f|0,s[3]=s[3]+a|0,s[4]=s[4]+l|0}},D={getRandomValues(e){const t=new c(e.buffer),n=e=>{let t=987654321;const n=4294967295;return()=>(t=36969*(65535&t)+(t>>16)&n,(((t<<16)+(e=18e3*(65535&e)+(e>>16)&n)&n)/4294967296+.5)*(r.random()>.5?1:-1))};for(let s,i=0;i<e.length;i+=4){const e=n(4294967296*(s||r.random()));s=987654071*e(),t[i/4]=4294967296*e()|0}return e}},V={importKey:e=>new V.R(_.bytes.m(e)),B(e,t,n,r){if(n=n||1e4,0>r||0>n)throw new s("invalid params to pbkdf2");const i=1+(r>>5)<<2;let o,c,f,a,u;const w=new ArrayBuffer(i),h=new l(w);let d=0;const p=I;for(t=_.bytes.m(t),u=1;(i||1)>d;u++){for(o=c=e.encrypt(p.concat(t,[u])),f=1;n>f;f++)for(c=e.encrypt(c),a=0;a<c.length;a++)o[a]^=c[a];for(f=0;(i||1)>d&&f<o.length;f++)h.setInt32(d,o[f]),d+=4}return w.slice(0,r/8)},R:class{constructor(e){const t=this,n=t.M=P,r=[[],[]];t.U=[new n,new n];const s=t.U[0].blockSize/32;e.length>s&&(e=(new n).update(e).P());for(let t=0;s>t;t++)r[0][t]=909522486^e[t],r[1][t]=1549556828^e[t];t.U[0].update(r[0]),t.U[1].update(r[1]),t.K=new n(t.U[0])}reset(){const e=this;e.K=new e.M(e.U[0]),e.N=!1}update(e){this.N=!0,this.K.update(e)}digest(){const e=this,t=e.K.P(),n=new e.M(e.U[1]).update(t).P();return e.reset(),n}encrypt(e){if(this.N)throw new s("encrypt on already updated hmac called!");return this.update(e),this.digest(e)}}},R=typeof h!=v&&typeof h.getRandomValues==S,B="Invalid password",E="Invalid signature",M="zipjs-abort-check-password";function U(e){return R?h.getRandomValues(e):D.getRandomValues(e)}const K=16,N={name:"PBKDF2"},O=t.assign({hash:{name:"HMAC"}},N),T=t.assign({iterations:1e3,hash:{name:"SHA-1"}},N),W=["deriveBits"],j=[8,12,16],H=[16,24,32],L=10,F=[0,0,0,0],q=typeof h!=v,G=q&&h.subtle,J=q&&typeof G!=v,Q=_.bytes,X=class{constructor(e){const t=this;t.O=[[[],[],[],[],[]],[[],[],[],[],[]]],t.O[0][0][0]||t.T();const n=t.O[0][4],r=t.O[1],i=e.length;let o,c,f,a=1;if(4!==i&&6!==i&&8!==i)throw new s("invalid aes key size");for(t.v=[c=e.slice(0),f=[]],o=i;4*i+28>o;o++){let e=c[o-1];(o%i===0||8===i&&o%i===4)&&(e=n[e>>>24]<<24^n[e>>16&255]<<16^n[e>>8&255]<<8^n[255&e],o%i===0&&(e=e<<8^e>>>24^a<<24,a=a<<1^283*(a>>7))),c[o]=c[o-i]^e}for(let e=0;o;e++,o--){const t=c[3&e?o:o-4];f[e]=4>=o||4>e?t:r[0][n[t>>>24]]^r[1][n[t>>16&255]]^r[2][n[t>>8&255]]^r[3][n[255&t]]}}encrypt(e){return this.W(e,0)}decrypt(e){return this.W(e,1)}T(){const e=this.O[0],t=this.O[1],n=e[4],r=t[4],s=[],i=[];let o,c,f,a;for(let e=0;256>e;e++)i[(s[e]=e<<1^283*(e>>7))^e]=e;for(let l=o=0;!n[l];l^=c||1,o=i[o]||1){let i=o^o<<1^o<<2^o<<3^o<<4;i=i>>8^255&i^99,n[l]=i,r[i]=l,a=s[f=s[c=s[l]]];let u=16843009*a^65537*f^257*c^16843008*l,w=257*s[i]^16843008*i;for(let n=0;4>n;n++)e[n][l]=w=w<<24^w>>>8,t[n][i]=u=u<<24^u>>>8}for(let n=0;5>n;n++)e[n]=e[n].slice(0),t[n]=t[n].slice(0)}W(e,t){if(4!==e.length)throw new s("invalid aes block size");const n=this.v[t],r=n.length/4-2,i=[0,0,0,0],o=this.O[t],c=o[0],f=o[1],a=o[2],l=o[3],u=o[4];let w,h,d,p=e[0]^n[0],y=e[t?3:1]^n[1],m=e[2]^n[2],b=e[t?1:3]^n[3],g=4;for(let e=0;r>e;e++)w=c[p>>>24]^f[y>>16&255]^a[m>>8&255]^l[255&b]^n[g],h=c[y>>>24]^f[m>>16&255]^a[b>>8&255]^l[255&p]^n[g+1],d=c[m>>>24]^f[b>>16&255]^a[p>>8&255]^l[255&y]^n[g+2],b=c[b>>>24]^f[p>>16&255]^a[y>>8&255]^l[255&m]^n[g+3],g+=4,p=w,y=h,m=d;for(let e=0;4>e;e++)i[t?3&-e:e]=u[p>>>24]<<24^u[y>>16&255]<<16^u[m>>8&255]<<8^u[255&b]^n[g++],w=p,p=y,y=m,m=b,b=w;return i}},Y=class{constructor(e,t){this.j=e,this.H=t,this.L=t}reset(){this.L=this.H}update(e){return this.F(this.j,e,this.L)}q(e){if(255&~(e>>24))e+=1<<24;else{let t=e>>16&255,n=e>>8&255,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r}return e}G(e){0===(e[0]=this.q(e[0]))&&(e[1]=this.q(e[1]))}F(e,t,n){let r;if(!(r=t.length))return[];const s=I.l(t);for(let s=0;r>s;s+=4){this.G(n);const r=e.encrypt(n);t[s]^=r[0],t[s+1]^=r[1],t[s+2]^=r[2],t[s+3]^=r[3]}return I.u(t,s)}},Z=V.R;let $=q&&J&&typeof G.importKey==S,ee=q&&J&&typeof G.deriveBits==S;class te extends p{constructor({password:e,rawPassword:n,signed:r,encryptionStrength:o,checkPasswordOnly:c}){super({start(){t.assign(this,{ready:new u(e=>this.J=e),password:ie(e,n),signed:r,X:o-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:o,J:f,ready:a}=n;r?(await(async(e,t,n,r)=>{const i=await se(e,t,n,ce(r,0,j[t])),o=ce(r,j[t]);if(i[0]!=o[0]||i[1]!=o[1])throw new s(B)})(n,o,r,ce(e,0,j[o]+2)),e=ce(e,j[o]+2),c?t.error(new s(M)):f()):await a;const l=new i(e.length-L-(e.length-L)%K);t.enqueue(re(n,e,l,0,L,!0))},async flush(e){const{signed:t,Y:n,Z:r,pending:o,ready:c}=this;if(r&&n){await c;const f=ce(o,0,o.length-L),a=ce(o,o.length-L);let l=new i;if(f.length){const e=ae(Q,f);r.update(e);const t=n.update(e);l=fe(Q,t)}if(t){const e=ce(fe(Q,r.digest()),0,L);for(let t=0;L>t;t++)if(e[t]!=a[t])throw new s(E)}e.enqueue(l)}}})}}class ne extends p{constructor({password:e,rawPassword:n,encryptionStrength:r}){let s;super({start(){t.assign(this,{ready:new u(e=>this.J=e),password:ie(e,n),X:r-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:s,J:o,ready:c}=n;let f=new i;r?(f=await(async(e,t,n)=>{const r=U(new i(j[t]));return oe(r,await se(e,t,n,r))})(n,s,r),o()):await c;const a=new i(f.length+e.length-e.length%K);a.set(f,0),t.enqueue(re(n,e,a,f.length,0))},async flush(e){const{Y:t,Z:n,pending:r,ready:o}=this;if(n&&t){await o;let c=new i;if(r.length){const e=t.update(ae(Q,r));n.update(e),c=fe(Q,e)}s.signature=fe(Q,n.digest()).slice(0,L),e.enqueue(oe(c,s.signature))}}}),s=this}}function re(e,t,n,r,s,o){const{Y:c,Z:f,pending:a}=e,l=t.length-s;let u;for(a.length&&(t=oe(a,t),n=((e,t)=>{if(t&&t>e.length){const n=e;(e=new i(t)).set(n,0)}return e})(n,l-l%K)),u=0;l-K>=u;u+=K){const e=ae(Q,ce(t,u,u+K));o&&f.update(e);const s=c.update(e);o||f.update(s),n.set(fe(Q,s),u+r)}return e.pending=ce(t,u),n}async function se(n,r,s,o){n.password=null;const c=await(async(e,t,n,r,s)=>{if(!$)return V.importKey(t);try{return await G.importKey("raw",t,n,!1,s)}catch(e){return $=!1,V.importKey(t)}})(0,s,O,0,W),f=await(async(e,t,n)=>{if(!ee)return V.B(t,e.salt,T.iterations,n);try{return await G.deriveBits(e,t,n)}catch(r){return ee=!1,V.B(t,e.salt,T.iterations,n)}})(t.assign({salt:o},T),c,8*(2*H[r]+2)),a=new i(f),l=ae(Q,ce(a,0,H[r])),u=ae(Q,ce(a,H[r],2*H[r])),w=ce(a,2*H[r]);return t.assign(n,{keys:{key:l,$:u,passwordVerification:w},Y:new Y(new X(l),e.from(F)),Z:new Z(u)}),w}function ie(e,t){return t===k?(e=>{if(typeof w==v){const t=new i((e=unescape(encodeURIComponent(e))).length);for(let n=0;n<t.length;n++)t[n]=e.charCodeAt(n);return t}return(new w).encode(e)})(e):t}function oe(e,t){let n=e;return e.length+t.length&&(n=new i(e.length+t.length),n.set(e,0),n.set(t,e.length)),n}function ce(e,t,n){return e.subarray(t,n)}function fe(e,t){return e.p(t)}function ae(e,t){return e.m(t)}class le extends p{constructor({password:e,passwordVerification:n,checkPasswordOnly:r}){super({start(){t.assign(this,{password:e,passwordVerification:n}),de(this,e)},transform(e,t){const n=this;if(n.password){const t=we(n,e.subarray(0,12));if(n.password=null,t.at(-1)!=n.passwordVerification)throw new s(B);e=e.subarray(12)}r?t.error(new s(M)):t.enqueue(we(n,e))}})}}class ue extends p{constructor({password:e,passwordVerification:n}){super({start(){t.assign(this,{password:e,passwordVerification:n}),de(this,e)},transform(e,t){const n=this;let r,s;if(n.password){n.password=null;const t=U(new i(12));t[11]=n.passwordVerification,r=new i(e.length+t.length),r.set(he(n,t),0),s=12}else r=new i(e.length),s=0;r.set(he(n,e),s),t.enqueue(r)}})}}function we(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=ye(e)^t[r],pe(e,n[r]);return n}function he(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=ye(e)^t[r],pe(e,t[r]);return n}function de(e,n){const r=[305419896,591751049,878082192];t.assign(e,{keys:r,ee:new x(r[0]),te:new x(r[2])});for(let t=0;t<n.length;t++)pe(e,n.charCodeAt(t))}function pe(e,t){let[n,s,i]=e.keys;e.ee.append([t]),n=~e.ee.get(),s=be(r.imul(be(s+me(n)),134775813)+1),e.te.append([s>>>24]),i=~e.te.get(),e.keys=[n,s,i]}function ye(e){const t=2|e.keys[2];return me(r.imul(t,1^t)>>>8)}function me(e){return 255&e}function be(e){return 4294967295&e}const ge="deflate-raw";class ke extends p{constructor(e,{chunkSize:t,CompressionStream:n,CompressionStreamNative:r}){super({});const{compressed:s,encrypted:i,useCompressionStream:o,zipCrypto:c,signed:f,level:a}=e,u=this;let w,h,d=super.readable;i&&!c||!f||(w=new A,d=Ce(d,w)),s&&(d=ze(d,o,{level:a,chunkSize:t},r,n)),i&&(c?d=Ce(d,new ue(e)):(h=new ne(e),d=Ce(d,h))),Se(u,d,()=>{let e;i&&!c&&(e=h.signature),i&&!c||!f||(e=new l(w.value.buffer).getUint32(0)),u.signature=e})}}class ve extends p{constructor(e,{chunkSize:t,DecompressionStream:n,DecompressionStreamNative:r}){super({});const{zipCrypto:i,encrypted:o,signed:c,signature:f,compressed:a,useCompressionStream:u}=e;let w,h,d=super.readable;o&&(i?d=Ce(d,new le(e)):(h=new te(e),d=Ce(d,h))),a&&(d=ze(d,u,{chunkSize:t},r,n)),o&&!i||!c||(w=new A,d=Ce(d,w)),Se(this,d,()=>{if((!o||i)&&c){const e=new l(w.value.buffer);if(f!=e.getUint32(0,!1))throw new s(E)}})}}function Se(e,n,r){n=Ce(n,new p({flush:r})),t.defineProperty(e,"readable",{get:()=>n})}function ze(e,t,n,r,s){try{e=Ce(e,new(t&&r?r:s)(ge,n))}catch(r){if(!t)throw r;e=Ce(e,new s(ge,n))}return e}function Ce(e,t){return e.pipeThrough(t)}const xe="data",Ae="close";class Ie extends p{constructor(e,n){super({});const r=this,{codecType:i}=e;let o;i.startsWith("deflate")?o=ke:i.startsWith("inflate")&&(o=ve),r.outputSize=0;let c=0;const f=new o(e,n),a=super.readable,l=new p({transform(e,t){e&&e.length&&(c+=e.length,t.enqueue(e))},flush(){t.assign(r,{inputSize:c})}}),u=new p({transform(t,n){if(t&&t.length&&(n.enqueue(t),r.outputSize+=t.length,e.outputSize&&r.outputSize>e.outputSize))throw new s("Invalid uncompressed size")},flush(){const{signature:e}=f;t.assign(r,{signature:e,inputSize:c})}});t.defineProperty(r,"readable",{get:()=>a.pipeThrough(l).pipeThrough(f).pipeThrough(u)})}}class _e extends p{constructor(e){let t;super({transform:function n(r,s){if(t){const e=new i(t.length+r.length);e.set(t),e.set(r,t.length),r=e,t=null}r.length>e?(s.enqueue(r.slice(0,e)),n(r.slice(e),s)):t=r},flush(e){t&&t.length&&e.enqueue(t)}})}}const Pe=new a,De=new a;let Ve,Re=0,Be=!0;async function Ee(e){try{const{options:t,scripts:r,config:s}=e;if(r&&r.length)try{Be?importScripts.apply(k,r):await Me(r)}catch(e){Be=!1,await Me(r)}self.initCodec&&self.initCodec(),s.CompressionStreamNative=self.CompressionStream,s.DecompressionStreamNative=self.DecompressionStream,self.Deflate&&(s.CompressionStream=new z(self.Deflate)),self.Inflate&&(s.DecompressionStream=new z(self.Inflate));const i={highWaterMark:1},o=e.readable||new y({async pull(e){const t=new u(e=>Pe.set(Re,e));Ue({type:"pull",messageId:Re}),Re=(Re+1)%n.MAX_SAFE_INTEGER;const{value:r,done:s}=await t;e.enqueue(r),s&&e.close()}},i),c=e.writable||new m({async write(e){let t;const r=new u(e=>t=e);De.set(Re,t),Ue({type:xe,value:e,messageId:Re}),Re=(Re+1)%n.MAX_SAFE_INTEGER,await r}},i),f=new Ie(t,s);Ve=new AbortController;const{signal:a}=Ve;await o.pipeThrough(f).pipeThrough(new _e(s.chunkSize)).pipeTo(c,{signal:a,preventClose:!0,preventAbort:!0}),await c.getWriter().close();const{signature:l,inputSize:w,outputSize:h}=f;Ue({type:Ae,result:{signature:l,inputSize:w,outputSize:h}})}catch(e){e.outputSize=0,Ke(e)}}async function Me(e){for(const t of e)await import(t)}function Ue(e){let{value:t}=e;if(t)if(t.length)try{t=new i(t),e.value=t.buffer,d(e,[e.value])}catch(t){d(e)}else d(e);else d(e)}function Ke(e=new s("Unknown error")){const{message:t,stack:n,code:r,name:i,outputSize:o}=e;d({error:{message:t,stack:n,code:r,name:i,outputSize:o}})}addEventListener("message",({data:e})=>{const{type:t,messageId:n,value:r,done:s}=e;try{if("start"==t&&Ee(e),t==xe){const e=Pe.get(n);Pe.delete(n),e({value:new i(r),done:s})}if("ack"==t){const e=De.get(n);De.delete(n),e()}t==Ae&&Ve.abort()}catch(e){Ke(e)}});const Ne=-2;function Oe(t){return Te(t.map(([t,n])=>new e(t).fill(n,0,t)))}function Te(t){return t.reduce((t,n)=>t.concat(e.isArray(n)?Te(n):n),[])}const We=[0,1,2,3].concat(...Oe([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function je(){const e=this;function t(e,t){let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}e.ne=n=>{const s=e.re,i=e.ie.se,o=e.ie.oe;let c,f,a,l=-1;for(n.ce=0,n.fe=573,c=0;o>c;c++)0!==s[2*c]?(n.ae[++n.ce]=l=c,n.le[c]=0):s[2*c+1]=0;for(;2>n.ce;)a=n.ae[++n.ce]=2>l?++l:0,s[2*a]=1,n.le[a]=0,n.ue--,i&&(n.we-=i[2*a+1]);for(e.he=l,c=r.floor(n.ce/2);c>=1;c--)n.de(s,c);a=o;do{c=n.ae[1],n.ae[1]=n.ae[n.ce--],n.de(s,1),f=n.ae[1],n.ae[--n.fe]=c,n.ae[--n.fe]=f,s[2*a]=s[2*c]+s[2*f],n.le[a]=r.max(n.le[c],n.le[f])+1,s[2*c+1]=s[2*f+1]=a,n.ae[1]=a++,n.de(s,1)}while(n.ce>=2);n.ae[--n.fe]=n.ae[1],(t=>{const n=e.re,r=e.ie.se,s=e.ie.pe,i=e.ie.ye,o=e.ie.me;let c,f,a,l,u,w,h=0;for(l=0;15>=l;l++)t.be[l]=0;for(n[2*t.ae[t.fe]+1]=0,c=t.fe+1;573>c;c++)f=t.ae[c],l=n[2*n[2*f+1]+1]+1,l>o&&(l=o,h++),n[2*f+1]=l,f>e.he||(t.be[l]++,u=0,i>f||(u=s[f-i]),w=n[2*f],t.ue+=w*(l+u),r&&(t.we+=w*(r[2*f+1]+u)));if(0!==h){do{for(l=o-1;0===t.be[l];)l--;t.be[l]--,t.be[l+1]+=2,t.be[o]--,h-=2}while(h>0);for(l=o;0!==l;l--)for(f=t.be[l];0!==f;)a=t.ae[--c],a>e.he||(n[2*a+1]!=l&&(t.ue+=(l-n[2*a+1])*n[2*a],n[2*a+1]=l),f--)}})(n),((e,n,r)=>{const s=[];let i,o,c,f=0;for(i=1;15>=i;i++)s[i]=f=f+r[i-1]<<1;for(o=0;n>=o;o++)c=e[2*o+1],0!==c&&(e[2*o]=t(s[c]++,c))})(s,e.he,n.be)}}function He(e,t,n,r,s){const i=this;i.se=e,i.pe=t,i.ye=n,i.oe=r,i.me=s}je.ge=[0,1,2,3,4,5,6,7].concat(...Oe([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]])),je.ke=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],je.ve=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],je.Se=e=>256>e?We[e]:We[256+(e>>>7)],je.ze=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],je.Ce=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],je.xe=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],je.Ae=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];const Le=Oe([[144,8],[112,9],[24,7],[8,8]]);He.Ie=Te([12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227].map((e,t)=>[e,Le[t]]));const Fe=Oe([[30,5]]);function qe(e,t,n,r,s){const i=this;i._e=e,i.Pe=t,i.De=n,i.Ve=r,i.Re=s}He.Be=Te([0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23].map((e,t)=>[e,Fe[t]])),He.Ee=new He(He.Ie,je.ze,257,286,15),He.Me=new He(He.Be,je.Ce,0,30,15),He.Ue=new He(null,je.xe,0,19,7);const Ge=[new qe(0,0,0,0,0),new qe(4,4,8,4,1),new qe(4,5,16,8,1),new qe(4,6,32,32,1),new qe(4,4,16,16,2),new qe(8,16,32,32,2),new qe(8,16,128,128,2),new qe(8,32,128,256,2),new qe(32,128,258,1024,2),new qe(32,258,258,4096,2)],Je=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],Qe=113,Xe=666,Ye=262;function Ze(e,t,n,r){const s=e[2*t],i=e[2*n];return i>s||s==i&&r[t]<=r[n]}function $e(){const e=this;let t,n,s,c,f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z,C,x,A,I,_,P,D,V,R,B,E,M,U;const K=new je,N=new je,O=new je;let T,W,j,H,L,F;function q(){let t;for(t=0;286>t;t++)E[2*t]=0;for(t=0;30>t;t++)M[2*t]=0;for(t=0;19>t;t++)U[2*t]=0;E[512]=1,e.ue=e.we=0,W=j=0}function G(e,t){let n,r=-1,s=e[1],i=0,o=7,c=4;0===s&&(o=138,c=3),e[2*(t+1)+1]=65535;for(let f=0;t>=f;f++)n=s,s=e[2*(f+1)+1],++i<o&&n==s||(c>i?U[2*n]+=i:0!==n?(n!=r&&U[2*n]++,U[32]++):i>10?U[36]++:U[34]++,i=0,r=n,0===s?(o=138,c=3):n==s?(o=6,c=3):(o=7,c=4))}function J(t){e.Ke[e.pending++]=t}function Q(e){J(255&e),J(e>>>8&255)}function X(e,t){let n;const r=t;F>16-r?(n=e,L|=n<<F&65535,Q(L),L=n>>>16-F,F+=r-16):(L|=e<<F&65535,F+=r)}function Y(e,t){const n=2*e;X(65535&t[n],65535&t[n+1])}function Z(e,t){let n,r,s=-1,i=e[1],o=0,c=7,f=4;for(0===i&&(c=138,f=3),n=0;t>=n;n++)if(r=i,i=e[2*(n+1)+1],++o>=c||r!=i){if(f>o)do{Y(r,U)}while(0!==--o);else 0!==r?(r!=s&&(Y(r,U),o--),Y(16,U),X(o-3,2)):o>10?(Y(18,U),X(o-11,7)):(Y(17,U),X(o-3,3));o=0,s=r,0===i?(c=138,f=3):r==i?(c=6,f=3):(c=7,f=4)}}function $(){16==F?(Q(L),L=0,F=0):8>F||(J(255&L),L>>>=8,F-=8)}function ee(t,n){let s,i,o;if(e.Ne[W]=t,e.Oe[W]=255&n,W++,0===t?E[2*n]++:(j++,t--,E[2*(je.ge[n]+256+1)]++,M[2*je.Se(t)]++),!(8191&W)&&D>2){for(s=8*W,i=C-k,o=0;30>o;o++)s+=M[2*o]*(5+je.Ce[o]);if(s>>>=3,j<r.floor(W/2)&&s<r.floor(i/2))return!0}return W==T-1}function te(t,n){let r,s,i,o,c=0;if(0!==W)do{r=e.Ne[c],s=e.Oe[c],c++,0===r?Y(s,t):(i=je.ge[s],Y(i+256+1,t),o=je.ze[i],0!==o&&(s-=je.ke[i],X(s,o)),r--,i=je.Se(r),Y(i,n),o=je.Ce[i],0!==o&&(r-=je.ve[i],X(r,o)))}while(W>c);Y(256,t),H=t[513]}function ne(){F>8?Q(L):F>0&&J(255&L),L=0,F=0}function re(t,n,r){X(0+(r?1:0),3),((t,n)=>{ne(),H=8,Q(n),Q(~n),e.Ke.set(u.subarray(t,t+n),e.pending),e.pending+=n})(t,n)}function se(n){((t,n,r)=>{let s,i,o=0;D>0?(K.ne(e),N.ne(e),o=(()=>{let t;for(G(E,K.he),G(M,N.he),O.ne(e),t=18;t>=3&&0===U[2*je.Ae[t]+1];t--);return e.ue+=14+3*(t+1),t})(),s=e.ue+3+7>>>3,i=e.we+3+7>>>3,i>s||(s=i)):s=i=n+5,n+4>s||-1==t?i==s?(X(2+(r?1:0),3),te(He.Ie,He.Be)):(X(4+(r?1:0),3),((e,t,n)=>{let r;for(X(e-257,5),X(t-1,5),X(n-4,4),r=0;n>r;r++)X(U[2*je.Ae[r]+1],3);Z(E,e-1),Z(M,t-1)})(K.he+1,N.he+1,o+1),te(E,M)):re(t,n,r),q(),r&&ne()})(0>k?-1:k,C-k,n),k=C,t.Te()}function ie(){let e,n,r,s;do{if(s=w-A-C,0===s&&0===C&&0===A)s=f;else if(-1==s)s--;else if(C>=f+f-Ye){u.set(u.subarray(f,f+f),0),x-=f,C-=f,k-=f,e=y,r=e;do{n=65535&d[--r],d[r]=f>n?0:n-f}while(0!==--e);e=f,r=e;do{n=65535&h[--r],h[r]=f>n?0:n-f}while(0!==--e);s+=f}if(0===t.We)return;e=t.je(u,C+A,s),A+=e,3>A||(p=255&u[C],p=(p<<g^255&u[C+1])&b)}while(Ye>A&&0!==t.We)}function oe(e){let t,n,r=_,s=C,i=I;const o=C>f-Ye?C-(f-Ye):0;let c=B;const a=l,w=C+258;let d=u[s+i-1],p=u[s+i];R>I||(r>>=2),c>A&&(c=A);do{if(t=e,u[t+i]==p&&u[t+i-1]==d&&u[t]==u[s]&&u[++t]==u[s+1]){s+=2,t++;do{}while(u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&w>s);if(n=258-(w-s),s=w-258,n>i){if(x=e,i=n,n>=c)break;d=u[s+i-1],p=u[s+i]}}}while((e=65535&h[e&a])>o&&0!==--r);return i>A?A:i}e.le=[],e.be=[],e.ae=[],E=[],M=[],U=[],e.de=(t,n)=>{const r=e.ae,s=r[n];let i=n<<1;for(;i<=e.ce&&(i<e.ce&&Ze(t,r[i+1],r[i],e.le)&&i++,!Ze(t,s,r[i],e.le));)r[n]=r[i],n=i,i<<=1;r[n]=s},e.He=(t,S,x,W,j,G)=>(W||(W=8),j||(j=8),G||(G=0),t.Le=null,-1==S&&(S=6),1>j||j>9||8!=W||9>x||x>15||0>S||S>9||0>G||G>2?Ne:(t.Fe=e,a=x,f=1<<a,l=f-1,m=j+7,y=1<<m,b=y-1,g=r.floor((m+3-1)/3),u=new i(2*f),h=[],d=[],T=1<<j+6,e.Ke=new i(4*T),s=4*T,e.Ne=new o(T),e.Oe=new i(T),D=S,V=G,(t=>(t.qe=t.Ge=0,t.Le=null,e.pending=0,e.Je=0,n=Qe,c=0,K.re=E,K.ie=He.Ee,N.re=M,N.ie=He.Me,O.re=U,O.ie=He.Ue,L=0,F=0,H=8,q(),(()=>{w=2*f,d[y-1]=0;for(let e=0;y-1>e;e++)d[e]=0;P=Ge[D].Pe,R=Ge[D]._e,B=Ge[D].De,_=Ge[D].Ve,C=0,k=0,A=0,v=I=2,z=0,p=0})(),0))(t))),e.Qe=()=>42!=n&&n!=Qe&&n!=Xe?Ne:(e.Oe=null,e.Ne=null,e.Ke=null,d=null,h=null,u=null,e.Fe=null,n==Qe?-3:0),e.Xe=(e,t,n)=>{let r=0;return-1==t&&(t=6),0>t||t>9||0>n||n>2?Ne:(Ge[D].Re!=Ge[t].Re&&0!==e.qe&&(r=e.Ye(1)),D!=t&&(D=t,P=Ge[D].Pe,R=Ge[D]._e,B=Ge[D].De,_=Ge[D].Ve),V=n,r)},e.Ze=(e,t,r)=>{let s,i=r,o=0;if(!t||42!=n)return Ne;if(3>i)return 0;for(i>f-Ye&&(i=f-Ye,o=r-i),u.set(t.subarray(o,o+i),0),C=i,k=i,p=255&u[0],p=(p<<g^255&u[1])&b,s=0;i-3>=s;s++)p=(p<<g^255&u[s+2])&b,h[s&l]=d[p],d[p]=s;return 0},e.Ye=(r,i)=>{let o,w,m,_,R;if(i>4||0>i)return Ne;if(!r.$e||!r.et&&0!==r.We||n==Xe&&4!=i)return r.Le=Je[4],Ne;if(0===r.tt)return r.Le=Je[7],-5;var B;if(t=r,_=c,c=i,42==n&&(w=8+(a-8<<4)<<8,m=(D-1&255)>>1,m>3&&(m=3),w|=m<<6,0!==C&&(w|=32),w+=31-w%31,n=Qe,J((B=w)>>8&255),J(255&B)),0!==e.pending){if(t.Te(),0===t.tt)return c=-1,0}else if(0===t.We&&_>=i&&4!=i)return t.Le=Je[7],-5;if(n==Xe&&0!==t.We)return r.Le=Je[7],-5;if(0!==t.We||0!==A||0!=i&&n!=Xe){switch(R=-1,Ge[D].Re){case 0:R=(e=>{let n,r=65535;for(r>s-5&&(r=s-5);;){if(1>=A){if(ie(),0===A&&0==e)return 0;if(0===A)break}if(C+=A,A=0,n=k+r,(0===C||C>=n)&&(A=C-n,C=n,se(!1),0===t.tt))return 0;if(C-k>=f-Ye&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 1:R=(e=>{let n,r=0;for(;;){if(Ye>A){if(ie(),Ye>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C),0===r||(C-r&65535)>f-Ye||2!=V&&(v=oe(r)),3>v)n=ee(0,255&u[C]),A--,C++;else if(n=ee(C-x,v-3),A-=v,v>P||3>A)C+=v,v=0,p=255&u[C],p=(p<<g^255&u[C+1])&b;else{v--;do{C++,p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C}while(0!==--v);C++}if(n&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 2:R=(e=>{let n,r,s=0;for(;;){if(Ye>A){if(ie(),Ye>A&&0==e)return 0;if(0===A)break}if(3>A||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C),I=v,S=x,v=2,0!==s&&P>I&&f-Ye>=(C-s&65535)&&(2!=V&&(v=oe(s)),5>=v&&(1==V||3==v&&C-x>4096)&&(v=2)),3>I||v>I)if(0!==z){if(n=ee(0,255&u[C-1]),n&&se(!1),C++,A--,0===t.tt)return 0}else z=1,C++,A--;else{r=C+A-3,n=ee(C-1-S,I-3),A-=I-1,I-=2;do{++C>r||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C)}while(0!==--I);if(z=0,v=2,C++,n&&(se(!1),0===t.tt))return 0}}return 0!==z&&(n=ee(0,255&u[C-1]),z=0),se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i)}if(2!=R&&3!=R||(n=Xe),0==R||2==R)return 0===t.tt&&(c=-1),0;if(1==R){if(1==i)X(2,3),Y(256,He.Ie),$(),9>1+H+10-F&&(X(2,3),Y(256,He.Ie),$()),H=7;else if(re(0,0,!1),3==i)for(o=0;y>o;o++)d[o]=0;if(t.Te(),0===t.tt)return c=-1,0}}return 4!=i?0:1}}function et(){const e=this;e.nt=0,e.rt=0,e.We=0,e.qe=0,e.tt=0,e.Ge=0}function tt(e){const t=new et,n=(o=e&&e.chunkSize?e.chunkSize:65536)+5*(r.floor(o/16383)+1);var o;const c=new i(n);let f=e?e.level:-1;void 0===f&&(f=-1),t.He(f),t.$e=c,this.append=(e,r)=>{let o,f,a=0,l=0,u=0;const w=[];if(e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,o=t.Ye(0),0!=o)throw new s("deflating: "+t.Le);t.rt&&(t.rt==n?w.push(new i(c)):w.push(c.subarray(0,t.rt))),u+=t.rt,r&&t.nt>0&&t.nt!=a&&(r(t.nt),a=t.nt)}while(t.We>0||0===t.tt);return w.length>1?(f=new i(u),w.forEach(e=>{f.set(e,l),l+=e.length})):f=w[0]?new i(w[0]):new i,f}},this.flush=()=>{let e,r,o=0,f=0;const a=[];do{if(t.rt=0,t.tt=n,e=t.Ye(4),1!=e&&0!=e)throw new s("deflating: "+t.Le);n-t.tt>0&&a.push(c.slice(0,t.rt)),f+=t.rt}while(t.We>0||0===t.tt);return t.Qe(),r=new i(f),a.forEach(e=>{r.set(e,o),o+=e.length}),r}}et.prototype={He(e,t){const n=this;return n.Fe=new $e,t||(t=15),n.Fe.He(n,e,t)},Ye(e){const t=this;return t.Fe?t.Fe.Ye(t,e):Ne},Qe(){const e=this;if(!e.Fe)return Ne;const t=e.Fe.Qe();return e.Fe=null,t},Xe(e,t){const n=this;return n.Fe?n.Fe.Xe(n,e,t):Ne},Ze(e,t){const n=this;return n.Fe?n.Fe.Ze(n,e,t):Ne},je(e,t,n){const r=this;let s=r.We;return s>n&&(s=n),0===s?0:(r.We-=s,e.set(r.et.subarray(r.nt,r.nt+s),t),r.nt+=s,r.qe+=s,s)},Te(){const e=this;let t=e.Fe.pending;t>e.tt&&(t=e.tt),0!==t&&(e.$e.set(e.Fe.Ke.subarray(e.Fe.Je,e.Fe.Je+t),e.rt),e.rt+=t,e.Fe.Je+=t,e.Ge+=t,e.tt-=t,e.Fe.pending-=t,0===e.Fe.pending&&(e.Fe.Je=0))}};const nt=-2,rt=-3,st=-5,it=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],ot=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],ct=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],ft=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],at=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],lt=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ut=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function wt(){let e,t,n,r,s,i;function o(e,t,o,c,f,a,l,u,w,h,d){let p,y,m,b,g,k,v,S,z,C,x,A,I,_,P;C=0,g=o;do{n[e[t+C]]++,C++,g--}while(0!==g);if(n[0]==o)return l[0]=-1,u[0]=0,0;for(S=u[0],k=1;15>=k&&0===n[k];k++);for(v=k,k>S&&(S=k),g=15;0!==g&&0===n[g];g--);for(m=g,S>g&&(S=g),u[0]=S,_=1<<k;g>k;k++,_<<=1)if(0>(_-=n[k]))return rt;if(0>(_-=n[g]))return rt;for(n[g]+=_,i[1]=k=0,C=1,I=2;0!==--g;)i[I]=k+=n[C],I++,C++;g=0,C=0;do{0!==(k=e[t+C])&&(d[i[k]++]=g),C++}while(++g<o);for(o=i[m],i[0]=g=0,C=0,b=-1,A=-S,s[0]=0,x=0,P=0;m>=v;v++)for(p=n[v];0!==p--;){for(;v>A+S;){if(b++,A+=S,P=m-A,P=P>S?S:P,(y=1<<(k=v-A))>p+1&&(y-=p+1,I=v,P>k))for(;++k<P&&(y<<=1)>n[++I];)y-=n[I];if(P=1<<k,h[0]+P>1440)return rt;s[b]=x=h[0],h[0]+=P,0!==b?(i[b]=g,r[0]=k,r[1]=S,k=g>>>A-S,r[2]=x-s[b-1]-k,w.set(r,3*(s[b-1]+k))):l[0]=x}for(r[1]=v-A,o>C?d[C]<c?(r[0]=256>d[C]?0:96,r[2]=d[C++]):(r[0]=a[d[C]-c]+16+64,r[2]=f[d[C++]-c]):r[0]=192,y=1<<v-A,k=g>>>A;P>k;k+=y)w.set(r,3*(x+k));for(k=1<<v-1;0!==(g&k);k>>>=1)g^=k;for(g^=k,z=(1<<A)-1;(g&z)!=i[b];)b--,A-=S,z=(1<<A)-1}return 0!==_&&1!=m?st:0}function c(o){let c;for(e||(e=[],t=[],n=new f(16),r=[],s=new f(15),i=new f(16)),t.length<o&&(t=[]),c=0;o>c;c++)t[c]=0;for(c=0;16>c;c++)n[c]=0;for(c=0;3>c;c++)r[c]=0;s.set(n.subarray(0,15),0),i.set(n.subarray(0,16),0)}this.st=(n,r,s,i,f)=>{let a;return c(19),e[0]=0,a=o(n,0,19,19,null,null,s,r,i,e,t),a==rt?f.Le="oversubscribed dynamic bit lengths tree":a!=st&&0!==r[0]||(f.Le="incomplete dynamic bit lengths tree",a=rt),a},this.it=(n,r,s,i,f,a,l,u,w)=>{let h;return c(288),e[0]=0,h=o(s,0,n,257,ft,at,a,i,u,e,t),0!=h||0===i[0]?(h==rt?w.Le="oversubscribed literal/length tree":-4!=h&&(w.Le="incomplete literal/length tree",h=rt),h):(c(288),h=o(s,n,r,0,lt,ut,l,f,u,e,t),0!=h||0===f[0]&&n>257?(h==rt?w.Le="oversubscribed distance tree":h==st?(w.Le="incomplete distance tree",h=rt):-4!=h&&(w.Le="empty distance tree with lengths",h=rt),h):0)}}function ht(){const e=this;let t,n,r,s,i=0,o=0,c=0,f=0,a=0,l=0,u=0,w=0,h=0,d=0;function p(e,t,n,r,s,i,o,c){let f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z;d=c.nt,p=c.We,w=o.ot,h=o.ct,y=o.write,m=y<o.read?o.read-y-1:o.end-y,b=it[e],g=it[t];do{for(;20>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(f=w&b,a=n,l=r,z=3*(l+f),0!==(u=a[z]))for(;;){if(w>>=a[z+1],h-=a[z+1],16&u){for(u&=15,k=a[z+2]+(w&it[u]),w>>=u,h-=u;15>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;for(f=w&g,a=s,l=i,z=3*(l+f),u=a[z];;){if(w>>=a[z+1],h-=a[z+1],16&u){for(u&=15;u>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(v=a[z+2]+(w&it[u]),w>>=u,h-=u,m-=k,v>y){S=y-v;do{S+=o.end}while(0>S);if(u=o.end-S,k>u){if(k-=u,y-S>0&&u>y-S)do{o.lt[y++]=o.lt[S++]}while(0!==--u);else o.lt.set(o.lt.subarray(S,S+u),y),y+=u,S+=u,u=0;S=0}}else S=y-v,y-S>0&&2>y-S?(o.lt[y++]=o.lt[S++],o.lt[y++]=o.lt[S++],k-=2):(o.lt.set(o.lt.subarray(S,S+2),y),y+=2,S+=2,k-=2);if(y-S>0&&k>y-S)do{o.lt[y++]=o.lt[S++]}while(0!==--k);else o.lt.set(o.lt.subarray(S,S+k),y),y+=k,S+=k,k=0;break}if(64&u)return c.Le="invalid distance code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,rt;f+=a[z+2],f+=w&it[u],z=3*(l+f),u=a[z]}break}if(64&u)return 32&u?(k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,1):(c.Le="invalid literal/length code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,rt);if(f+=a[z+2],f+=w&it[u],z=3*(l+f),0===(u=a[z])){w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--;break}}else w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--}while(m>=258&&p>=10);return k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,0}e.init=(e,i,o,c,f,a)=>{t=0,u=e,w=i,r=o,h=c,s=f,d=a,n=null},e.ut=(e,y,m)=>{let b,g,k,v,S,z,C,x=0,A=0,I=0;for(I=y.nt,v=y.We,x=e.ot,A=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S;;)switch(t){case 0:if(z>=258&&v>=10&&(e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,m=p(u,w,r,h,s,d,e,y),I=y.nt,v=y.We,x=e.ot,A=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S,0!=m)){t=1==m?7:9;break}c=u,n=r,o=h,t=1;case 1:for(b=c;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(I++))<<A,A+=8}if(g=3*(o+(x&it[b])),x>>>=n[g+1],A-=n[g+1],k=n[g],0===k){f=n[g+2],t=6;break}if(16&k){a=15&k,i=n[g+2],t=2;break}if(!(64&k)){c=k,o=g/3+n[g+2];break}if(32&k){t=7;break}return t=9,y.Le="invalid literal/length code",m=rt,e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);case 2:for(b=a;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(I++))<<A,A+=8}i+=x&it[b],x>>=b,A-=b,c=w,n=s,o=d,t=3;case 3:for(b=c;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(I++))<<A,A+=8}if(g=3*(o+(x&it[b])),x>>=n[g+1],A-=n[g+1],k=n[g],16&k){a=15&k,l=n[g+2],t=4;break}if(!(64&k)){c=k,o=g/3+n[g+2];break}return t=9,y.Le="invalid distance code",m=rt,e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);case 4:for(b=a;b>A;){if(0===v)return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(I++))<<A,A+=8}l+=x&it[b],x>>=b,A-=b,t=5;case 5:for(C=S-l;0>C;)C+=e.end;for(;0!==i;){if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);e.lt[S++]=e.lt[C++],z--,C==e.end&&(C=0),i--}t=0;break;case 6:if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);m=0,e.lt[S++]=f,z--,t=0;break;case 7:if(A>7&&(A-=8,v++,I--),e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,e.read!=e.write)return e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);t=8;case 8:return m=1,e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);case 9:return m=rt,e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m);default:return m=nt,e.ot=x,e.ct=A,y.We=v,y.qe+=I-y.nt,y.nt=I,e.write=S,e.wt(y,m)}},e.ht=()=>{}}wt.dt=(e,t,n,r)=>(e[0]=9,t[0]=5,n[0]=ot,r[0]=ct,0);const dt=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function pt(e,t){const n=this;let r,s=0,o=0,c=0,a=0;const l=[0],u=[0],w=new ht;let h=0,d=new f(4320);const p=new wt;n.ct=0,n.ot=0,n.lt=new i(t),n.end=t,n.read=0,n.write=0,n.reset=(e,t)=>{t&&(t[0]=0),6==s&&w.ht(e),s=0,n.ct=0,n.ot=0,n.read=n.write=0},n.reset(e,null),n.wt=(e,t)=>{let r,s,i;return s=e.rt,i=n.read,r=(i>n.write?n.end:n.write)-i,r>e.tt&&(r=e.tt),0!==r&&t==st&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r,i==n.end&&(i=0,n.write==n.end&&(n.write=0),r=n.write-i,r>e.tt&&(r=e.tt),0!==r&&t==st&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r),e.rt=s,n.read=i,t},n.ut=(e,t)=>{let i,f,y,m,b,g,k,v;for(m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g;;){let S,z,C,x,A,I,_,P;switch(s){case 0:for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}switch(i=7&f,h=1&i,i>>>1){case 0:f>>>=3,y-=3,i=7&y,f>>>=i,y-=i,s=1;break;case 1:S=[],z=[],C=[[]],x=[[]],wt.dt(S,z,C,x),w.init(S[0],z[0],C[0],0,x[0],0),f>>>=3,y-=3,s=6;break;case 2:f>>>=3,y-=3,s=3;break;case 3:return f>>>=3,y-=3,s=9,e.Le="invalid block type",t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}break;case 1:for(;32>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if((~f>>>16&65535)!=(65535&f))return s=9,e.Le="invalid stored block lengths",t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);o=65535&f,f=y=0,s=0!==o?2:0!==h?7:0;break;case 2:if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(0===k&&(g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k&&(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k)))return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(t=0,i=o,i>b&&(i=b),i>k&&(i=k),n.lt.set(e.je(m,i),g),m+=i,b-=i,g+=i,k-=i,0!==(o-=i))break;s=0!==h?7:0;break;case 3:for(;14>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(c=i=16383&f,(31&i)>29||(i>>5&31)>29)return s=9,e.Le="too many length or distance symbols",t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(i=258+(31&i)+(i>>5&31),!r||r.length<i)r=[];else for(v=0;i>v;v++)r[v]=0;f>>>=14,y-=14,a=0,s=4;case 4:for(;4+(c>>>10)>a;){for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}r[dt[a++]]=7&f,f>>>=3,y-=3}for(;19>a;)r[dt[a++]]=0;if(l[0]=7,i=p.st(r,l,u,d,e),0!=i)return(t=i)==rt&&(r=null,s=9),n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);a=0,s=5;case 5:for(;i=c,258+(31&i)+(i>>5&31)>a;){let o,w;for(i=l[0];i>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(i=d[3*(u[0]+(f&it[i]))+1],w=d[3*(u[0]+(f&it[i]))+2],16>w)f>>>=i,y-=i,r[a++]=w;else{for(v=18==w?7:w-14,o=18==w?11:3;i+v>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(f>>>=i,y-=i,o+=f&it[v],f>>>=v,y-=v,v=a,i=c,v+o>258+(31&i)+(i>>5&31)||16==w&&1>v)return r=null,s=9,e.Le="invalid bit length repeat",t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w=16==w?r[v-1]:0;do{r[v++]=w}while(0!==--o);a=v}}if(u[0]=-1,A=[],I=[],_=[],P=[],A[0]=9,I[0]=6,i=c,i=p.it(257+(31&i),1+(i>>5&31),r,A,I,_,P,d,e),0!=i)return i==rt&&(r=null,s=9),t=i,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w.init(A[0],I[0],d,_[0],d,P[0]),s=6;case 6:if(n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,1!=(t=w.ut(n,e,t)))return n.wt(e,t);if(t=0,w.ht(e),m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g,0===h){s=0;break}s=7;case 7:if(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,n.read!=n.write)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);s=8;case 8:return t=1,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);case 9:return t=rt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);default:return t=nt,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}}},n.ht=e=>{n.reset(e,null),n.lt=null,d=null},n.yt=(e,t,r)=>{n.lt.set(e.subarray(t,t+r),0),n.read=n.write=r},n.bt=()=>1==s?1:0}const yt=13,mt=[0,0,255,255];function bt(){const e=this;function t(e){return e&&e.gt?(e.qe=e.Ge=0,e.Le=null,e.gt.mode=7,e.gt.kt.reset(e,null),0):nt}e.mode=0,e.method=0,e.vt=[0],e.St=0,e.marker=0,e.zt=0,e.Ct=t=>(e.kt&&e.kt.ht(t),e.kt=null,0),e.xt=(n,r)=>(n.Le=null,e.kt=null,8>r||r>15?(e.Ct(n),nt):(e.zt=r,n.gt.kt=new pt(n,1<<r),t(n),0)),e.At=(e,t)=>{let n,r;if(!e||!e.gt||!e.et)return nt;const s=e.gt;for(t=4==t?st:0,n=st;;)switch(s.mode){case 0:if(0===e.We)return n;if(n=t,e.We--,e.qe++,8!=(15&(s.method=e.ft(e.nt++)))){s.mode=yt,e.Le="unknown compression method",s.marker=5;break}if(8+(s.method>>4)>s.zt){s.mode=yt,e.Le="invalid win size",s.marker=5;break}s.mode=1;case 1:if(0===e.We)return n;if(n=t,e.We--,e.qe++,r=255&e.ft(e.nt++),((s.method<<8)+r)%31!=0){s.mode=yt,e.Le="incorrect header check",s.marker=5;break}if(!(32&r)){s.mode=7;break}s.mode=2;case 2:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St=(255&e.ft(e.nt++))<<24&4278190080,s.mode=3;case 3:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<16&16711680,s.mode=4;case 4:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<8&65280,s.mode=5;case 5:return 0===e.We?n:(n=t,e.We--,e.qe++,s.St+=255&e.ft(e.nt++),s.mode=6,2);case 6:return s.mode=yt,e.Le="need dictionary",s.marker=0,nt;case 7:if(n=s.kt.ut(e,n),n==rt){s.mode=yt,s.marker=0;break}if(0==n&&(n=t),1!=n)return n;n=t,s.kt.reset(e,s.vt),s.mode=12;case 12:return e.We=0,1;case yt:return rt;default:return nt}},e.It=(e,t,n)=>{let r=0,s=n;if(!e||!e.gt||6!=e.gt.mode)return nt;const i=e.gt;return s<1<<i.zt||(s=(1<<i.zt)-1,r=n-s),i.kt.yt(t,r,s),i.mode=7,0},e._t=e=>{let n,r,s,i,o;if(!e||!e.gt)return nt;const c=e.gt;if(c.mode!=yt&&(c.mode=yt,c.marker=0),0===(n=e.We))return st;for(r=e.nt,s=c.marker;0!==n&&4>s;)e.ft(r)==mt[s]?s++:s=0!==e.ft(r)?0:4-s,r++,n--;return e.qe+=r-e.nt,e.nt=r,e.We=n,c.marker=s,4!=s?rt:(i=e.qe,o=e.Ge,t(e),e.qe=i,e.Ge=o,c.mode=7,0)},e.Pt=e=>e&&e.gt&&e.gt.kt?e.gt.kt.bt():nt}function gt(){}function kt(e){const t=new gt,n=e&&e.chunkSize?r.floor(2*e.chunkSize):131072,o=new i(n);let c=!1;t.xt(),t.$e=o,this.append=(e,r)=>{const f=[];let a,l,u=0,w=0,h=0;if(0!==e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,0!==t.We||c||(t.nt=0,c=!0),a=t.At(0),c&&a===st){if(0!==t.We)throw new s("inflating: bad input")}else if(0!==a&&1!==a)throw new s("inflating: "+t.Le);if((c||1===a)&&t.We===e.length)throw new s("inflating: bad input");t.rt&&(t.rt===n?f.push(new i(o)):f.push(o.subarray(0,t.rt))),h+=t.rt,r&&t.nt>0&&t.nt!=u&&(r(t.nt),u=t.nt)}while(t.We>0||0===t.tt);return f.length>1?(l=new i(h),f.forEach(e=>{l.set(e,w),w+=e.length})):l=f[0]?new i(f[0]):new i,l}},this.flush=()=>{t.Ct()}}gt.prototype={xt(e){const t=this;return t.gt=new bt,e||(e=15),t.gt.xt(t,e)},At(e){const t=this;return t.gt?t.gt.At(t,e):nt},Ct(){const e=this;if(!e.gt)return nt;const t=e.gt.Ct(e);return e.gt=null,t},_t(){const e=this;return e.gt?e.gt._t(e):nt},It(e,t){const n=this;return n.gt?n.gt.It(n,e,t):nt},ft(e){return this.et[e]},je(e,t){return this.et.subarray(e,e+t)}},self.initCodec=()=>{self.Deflate=tt,self.Inflate=kt};\n',r=()=>t.useDataURI?"data:text/javascript,"+encodeURIComponent(n):u.createObjectURL(new m([n],{type:"text/javascript"}));e({workerScripts:{inflate:[r],deflate:[r]}})})(qe),qe({Deflate:function(e){const t=new Y,n=(r=e&&e.chunkSize?e.chunkSize:65536)+5*(a.floor(r/16383)+1);var r;const i=new w(n);let s=e?e.level:-1;void 0===s&&(s=-1),t.deflateInit(s),t.next_out=i,this.append=(e,r)=>{let s,a,o=0,l=0,c=0;const d=[];if(e.length){t.next_in_index=0,t.next_in=e,t.avail_in=e.length;do{if(t.next_out_index=0,t.avail_out=n,s=t.deflate(0),0!=s)throw new f("deflating: "+t.msg);t.next_out_index&&(t.next_out_index==n?d.push(new w(i)):d.push(i.subarray(0,t.next_out_index))),c+=t.next_out_index,r&&t.next_in_index>0&&t.next_in_index!=o&&(r(t.next_in_index),o=t.next_in_index)}while(t.avail_in>0||0===t.avail_out);return d.length>1?(a=new w(c),d.forEach(e=>{a.set(e,l),l+=e.length})):a=d[0]?new w(d[0]):new w,a}},this.flush=()=>{let e,r,s=0,a=0;const o=[];do{if(t.next_out_index=0,t.avail_out=n,e=t.deflate(4),1!=e&&0!=e)throw new f("deflating: "+t.msg);n-t.avail_out>0&&o.push(i.slice(0,t.next_out_index)),a+=t.next_out_index}while(t.avail_in>0||0===t.avail_out);return t.deflateEnd(),r=new w(a),o.forEach(e=>{r.set(e,s),s+=e.length}),r}},Inflate:function(e){const t=new fe,n=e&&e.chunkSize?a.floor(2*e.chunkSize):131072,r=new w(n);let i=!1;t.inflateInit(),t.next_out=r,this.append=(e,s)=>{const a=[];let o,l,c=0,d=0,u=0;if(0!==e.length){t.next_in_index=0,t.next_in=e,t.avail_in=e.length;do{if(t.next_out_index=0,t.avail_out=n,0!==t.avail_in||i||(t.next_in_index=0,i=!0),o=t.inflate(0),i&&o===Q){if(0!==t.avail_in)throw new f("inflating: bad input")}else if(0!==o&&1!==o)throw new f("inflating: "+t.msg);if((i||1===o)&&t.avail_in===e.length)throw new f("inflating: bad input");t.next_out_index&&(t.next_out_index===n?a.push(new w(r)):a.push(r.subarray(0,t.next_out_index))),u+=t.next_out_index,s&&t.next_in_index>0&&t.next_in_index!=c&&(s(t.next_in_index),c=t.next_in_index)}while(t.avail_in>0||0===t.avail_out);return a.length>1?(l=new w(u),a.forEach(e=>{l.set(e,d),d+=e.length})):l=a[0]?new w(a[0]):new w,l}},this.flush=()=>{t.inflateEnd()}},baseURL:Ui}),e.BlobReader=kn,e.BlobWriter=zn,e.Data64URIReader=class extends xn{constructor(e){super();let t=e.length;for(;"="==e.charAt(t-1);)t--;const r=e.indexOf(",")+1;n.assign(this,{dataURI:e,dataStart:r,size:a.floor(.75*(t-r))})}readUint8Array(e,t){const{dataStart:n,dataURI:r}=this,i=new w(t),s=4*a.floor(e/3),o=atob(r.substring(s+n,4*a.ceil((e+t)/3)+n)),l=e-3*a.floor(s/4);let c=0;for(let e=l;l+t>e&&e<o.length;e++)i[e-l]=o.charCodeAt(e),c++;return c<i.length?i.subarray(0,c):i}},e.Data64URIWriter=class extends Sn{constructor(e){super(),n.assign(this,{data:"data:"+(e||"")+";base64,",pending:[]})}writeUint8Array(e){const t=this;let n=0,i=t.pending;const s=t.pending.length;for(t.pending="",n=0;n<3*a.floor((s+e.length)/3)-s;n++)i+=r.fromCharCode(e[n]);for(;n<e.length;n++)t.pending+=r.fromCharCode(e[n]);i.length&&(i.length>2?t.data+=k(i):t.pending+=i)}getData(){return this.data+k(this.pending)}},e.ERR_BAD_FORMAT=Tr,e.ERR_CENTRAL_DIRECTORY_NOT_FOUND=Ur,e.ERR_DUPLICATED_NAME=li,e.ERR_ENCRYPTED=Pr,e.ERR_EOCDR_LOCATOR_ZIP64_NOT_FOUND=Nr,e.ERR_EOCDR_NOT_FOUND=Lr,e.ERR_EXTRAFIELD_ZIP64_NOT_FOUND=Or,e.ERR_HTTP_RANGE=fn,e.ERR_INVALID_COMMENT=ci,e.ERR_INVALID_ENCRYPTION_STRENGTH=wi,e.ERR_INVALID_ENTRY_COMMENT=di,e.ERR_INVALID_ENTRY_NAME=ui,e.ERR_INVALID_EXTRAFIELD_DATA=pi,e.ERR_INVALID_EXTRAFIELD_TYPE=hi,e.ERR_INVALID_PASSWORD=Qe,e.ERR_INVALID_SIGNATURE=Je,e.ERR_INVALID_UNCOMPRESSED_SIZE=Ut,e.ERR_INVALID_VERSION=fi,e.ERR_ITERATOR_COMPLETED_TOO_SOON=wn,e.ERR_LOCAL_FILE_HEADER_NOT_FOUND=qr,e.ERR_OVERLAPPING_ENTRY=Br,e.ERR_SPLIT_ZIP_FILE=Vr,e.ERR_UNDEFINED_UNCOMPRESSED_SIZE=mi,e.ERR_UNSUPPORTED_COMPRESSION=Hr,e.ERR_UNSUPPORTED_ENCRYPTION=Mr,e.ERR_UNSUPPORTED_FORMAT=gi,e.ERR_WRITER_NOT_INITIALIZED=hn,e.ERR_ZIP_NOT_EMPTY=_i,e.GenericReader=Mn,e.GenericWriter=Hn,e.HttpRangeReader=class extends qn{constructor(e,t={}){t.useRangeHeader=!0,super(e,t)}},e.HttpReader=qn,e.Reader=xn,e.SplitDataReader=On,e.SplitDataWriter=Pn,e.SplitZipReader=jn,e.SplitZipWriter=Zn,e.TextReader=class extends kn{constructor(e){super(new m([e],{type:"text/plain"}))}},e.TextWriter=class extends zn{constructor(e){super(e),n.assign(this,{encoding:e,utf8:!e||"utf-8"==e.toLowerCase()})}async getData(){const{encoding:e,utf8:t}=this,r=await super.getData();if(r.text&&t)return r.text();{const t=new FileReader;return new _((i,s)=>{n.assign(t,{onload:({target:e})=>i(e.result),onerror:()=>s(t.error)}),t.readAsText(r,e)})}}},e.Uint8ArrayReader=class extends xn{constructor(e){super(),e=new w(e.buffer,e.byteOffset,e.byteLength),n.assign(this,{array:e,size:e.length})}readUint8Array(e,t){return this.array.slice(e,e+t)}},e.Uint8ArrayWriter=class extends Sn{init(e=0){n.assign(this,{offset:0,array:new w(e)}),super.init()}writeUint8Array(e){const t=this;if(t.offset+e.length>t.array.length){const n=t.array;t.array=new w(n.length+e.length),t.array.set(n)}t.array.set(e,t.offset),t.offset+=e.length}getData(){return this.array}},e.Writer=Sn,e.ZipReader=Kr,e.ZipReaderStream=class{constructor(e={}){const{readable:t,writable:n}=new z,r=new Kr(t,e).getEntriesGenerator();this.readable=new v({async pull(e){const{done:t,value:n}=await r.next();if(t)return e.close();const i={...n,readable:(()=>{const{readable:e,writable:t}=new z;if(n.getData)return n.getData(t),e})()};delete i.getData,e.enqueue(i)}}),this.writable=n}},e.ZipWriter=Si,e.ZipWriterStream=class{constructor(e={}){const{readable:t,writable:n}=new z;this.readable=t,this.zipWriter=new Si(n,e)}transform(e){const{readable:t,writable:n}=new z({flush:()=>{this.zipWriter.close()}});return this.zipWriter.add(e,t),{readable:this.readable,writable:n}}writable(e){const{readable:t,writable:n}=new z;return this.zipWriter.add(e,t),n}close(e,t={}){return this.zipWriter.close(e,t)}},e.configure=qe,e.getMimeType=()=>"application/octet-stream",e.initShimAsyncCodec=(e,t={},n)=>({Deflate:Pe(e.Deflate,t.deflate,n),Inflate:Pe(e.Inflate,t.inflate,n)}),e.initStream=Vn,e.readUint8Array=Bn,e.terminateWorkers=async()=>{await _.allSettled(an.map(e=>(dn(e),e.terminate())))}});

/* END OF ZIP.JS */
</script>

<meta charset="utf-8"/>
<title>Plant Skills</title>
<style>
    /* Reset and base styles */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
      color: #333;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
      padding: 0;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      /* A bold blue background for the header */
      background-color: #1a73e8;
      color: #ffffff;
      border-bottom: 1px solid #005bb5;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.18);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .toolbar h1 {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1 1 240px;
      font-size: 1.35rem;
    }
    .toolbar h1 span[role="img"] {
      font-size: 1.5rem;
    }
    .toolbar .title {
      flex: 1 1 240px;
      min-width: 220px;
    }
    .toolbar .inputs label {
      margin-right: 12px;
      font-size: 0.85rem;
    }
    .toolbar input {
      padding: 4px;
      font-size: 0.85rem;
    }
    .toolbar .actions {
      display: flex;
      flex: 1 1 auto;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .toolbar .actions button {
      margin-left: 0;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid transparent;
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background-color 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.16);
    }
    .btn:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.12);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.24);
    }
    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .btn-muted {
      background-color: #fafafa;
      color: #123;
      border-color: #c7c7c7;
    }
    .btn-muted:hover {
      background-color: #f0f0f0;
    }
    .btn-primary {
      background-color: #0b57d0;
      color: #fff;
      border-color: #0847ab;
    }
    .btn-primary:hover {
      background-color: #084db9;
    }
    .secure-export-button {
      background-color: #0f9d58;
      color: #fff;
      border-color: #0b7d43;
    }
    .secure-export-button:hover {
      background-color: #0c7b43;
    }
    #legend {
      padding: 8px 16px;
      font-size: 0.8rem;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }

    /* Site navigation styles */
    .site-nav {
      padding: 8px 16px;
      font-size: 0.9rem;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 40px;
      z-index: 90;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .site-nav strong {
      margin-right: 8px;
    }
    .site-nav .btn {
      margin-right: 0;
    }
    /* Table styles */
    .view {
      overflow-y: auto;
      overflow-x: hidden;
      height: calc(100vh - 140px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 0.8rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background-color: #f0f0f0;
      padding: 6px 4px;
      border-bottom: 1px solid #ccc;
      z-index: 50;
    }
    tbody td {
      padding: 4px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      word-wrap: break-word;
    }
    tbody tr:nth-child(even) td {
      background-color: #fafafa;
    }
    /* Column widths to avoid horizontal scroll */
    /* Column widths sum to 100% to avoid horizontal scroll */
    .col-dept { width: 9%; }
    /* Removed the separate Cluster column. The cluster name will be displayed within the role cell instead. */
    /* .col-cluster { ... } is no longer used */
    /* Updated column widths for the new layout: the removed cluster column width is merged into the role column. */
    /* The role column is reduced to about 20% of the table width on the
       main worksheet. The freedup space is allocated to the comment
       columns (comments and mitigation details) to improve readability. */
    .col-role { width: 20%; }
    .col-crit { width: 7%; text-align: center; }
    .col-cap { width: 7%; text-align: center; }
    .col-ret { width: 7%; text-align: center; }
    .col-overall { width: 7%; text-align: center; }
    /* Comments column width is increased and font slightly reduced for readability */
    /* Increase the comments column width to 29% and reduce the role column
       accordingly. This provides more space for long capability and
       retention notes. */
    /* Allocate column widths such that the Comments and Mitigation Details
       columns have the same width.  By setting both to 22% and keeping
       the other columns unchanged, the total width remains 100%: 20% (Role)
       + 7% (Criticality) + 7% (Capability) + 7% (Retention Risk) + 7%
       (Overall Risk) + 22% (Comments) + 8% (Preferred Method) + 22%
       (Mitigation Details) = 100%.  The reduced comments width still
       provides ample room for notes while matching the mitigation details
       column for a balanced look. */
    .col-comments { width: 22%; font-size: 0.75rem; line-height: 1.3; }
    .col-pref { width: 8%; text-align: center; }
    .col-gap { width: 22%; }
    /* RAG colours */
    /* Row separator line for better readability */
    tbody tr:not(.dept-section) td {
      border-bottom: 1px solid #eee;
    }
    /* RAG colour classes with !important to override row striping */
    .crit-1 { background-color: #d7e7d3 !important; color: #004400 !important; }
    .crit-2 { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .crit-3 { background-color: #f8d7da !important; color: #842029 !important; }

    /* Summary card tables styling */
    .summary-card table {
      border-collapse: collapse;
      width: 100%;
    }
    .summary-card th,
    .summary-card td {
      padding: 4px 6px;
      border-right: 1px solid #cccccc;
      border-bottom: 1px solid #cccccc;
    }
    .summary-card th:last-child,
    .summary-card td:last-child {
      border-right: none;
    }
    /* Equal widths for risk columns in the AsIs summary. The first column is
       slightly reduced (24%) to free up space for the other risk columns.
       The remaining four columns each take up an equal share of the rest of
       the table width. */
    /* Adjust the AsIs summary table so the role column is about 20% of the
       total width, freeing up space for the four risk columns. Each of
       the risk columns now shares the remaining 80% evenly (20% each).
       This change gives more room to the capability and comments in the
       summary view. */
    .summary-card.as-is table th:nth-child(1),
    .summary-card.as-is table td:nth-child(1) {
      width: 20%;
    }
    .summary-card.as-is table th:nth-child(2),
    .summary-card.as-is table td:nth-child(2),
    .summary-card.as-is table th:nth-child(3),
    .summary-card.as-is table td:nth-child(3),
    .summary-card.as-is table th:nth-child(4),
    .summary-card.as-is table td:nth-child(4),
    .summary-card.as-is table th:nth-child(5),
    .summary-card.as-is table td:nth-child(5) {
      width: 20%;
    }

    /* Styling for the capability heatmap table */
    .cap-heatmap table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.75rem;
    }
    .cap-heatmap th,
    .cap-heatmap td {
      padding: 4px 6px;
      border-right: 1px solid #cccccc;
      border-bottom: 1px solid #cccccc;
      vertical-align: top;
    }
    .cap-heatmap th:last-child,
    .cap-heatmap td:last-child {
      border-right: none;
    }
    .cap-heatmap tr:nth-child(even) td {
      background-color: #f9f9f9;
    }

    /* Apply light alternating row shading to summary tables as well. This
       uses the same colour as the heatmap so that any grey backgrounds
       scroll naturally with the content rather than appearing fixed. */
    .summary-card table tr:nth-child(even) td {
      background-color: #f9f9f9;
    }
    .cap-1 { background-color: #f8d7da !important; color: #842029 !important; }
    /* Medium capability (amber) uses the same yellow as other RAG buckets to ensure
       consistency across all tables. */
    .cap-2 { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .cap-3 { background-color: #d7e7d3 !important; color: #004400 !important; }
    .ret-L { background-color: #d7e7d3 !important; color: #004400 !important; }
    .ret-M { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .ret-H { background-color: #f8d7da !important; color: #842029 !important; }
    .ret-null { background-color: #e7e7e7 !important; color: #666 !important; }
    .overall-Low { background-color: #d7e7d3 !important; color: #004400 !important; }
    .overall-Medium { background-color: #fff5d6 !important; color: #8a6d00 !important; }
    .overall-High { background-color: #f8d7da !important; color: #842029 !important; }
    .overall-Critical { background-color: #e5b7b9 !important; color: #660000 !important; animation: pulse 2s infinite !important; }
    @media (prefers-reduced-motion: reduce) {
      .overall-Critical { animation: none; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(132,32,41, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(132,32,41, 0); }
      100% { box-shadow: 0 0 0 0 rgba(132,32,41, 0); }
    }

    /* Department section rows span all columns. Use a light background and bold text for section headers */
    tr.dept-section td {
      background-color: #eef2f7;
      font-weight: bold;
      padding: 6px;
    }
    /* Hide department section header rows entirely since this version of the tool
       no longer distinguishes pulp-specific vs shared departments. This prevents
       the grey lines (pulp-specific departments, shared with paper mill) from
       being displayed. */
    tr.dept-section {
      display: none !important;
    }
    /* Popover */
    .popover {
      position: absolute;
      background-color: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 8px;
      z-index: 200;
      font-size: 0.8rem;
    }
    .popover label {
      display: block;
      margin-bottom: 4px;
    }
    .popover select {
      width: 100%;
      margin-bottom: 6px;
    }
    .popover button {
      margin-right: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    /* Summary view */
    #summaryView {
      padding: 8px;
    }
    .summary-card {
      background-color: #fff;
      border: 1px solid #ddd;
      margin-bottom: 12px;
      padding: 8px;
    }
    .summary-card h2 {
      margin: 0 0 6px 0;
      font-size: 1rem;
    }
    .summary-card table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 6px;
      font-size: 0.75rem;
      table-layout: fixed;
    }
    .summary-card th, .summary-card td {
      /* Use a consistent grey border on all sides to create clear vertical and
         horizontal separators. This slightly darker shade ensures column
         dividers remain visible without being too heavy. */
      border: 1px solid #cccccc;
      padding: 4px;
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
    }
    .hidden { display: none; }

    /* Neutral style for missing criticality values */
    .crit-null { background-color: #e7e7e7; color: #666; }

    /* Preserve newlines in comment and gap cells */
    .col-comments {
      white-space: pre-wrap;
    }
    .col-gap {
      white-space: pre-wrap;
    }
    /* Print styles */
    @media print {
      body { font-size: 10pt; }
      .toolbar, #legend, .popover { display: none !important; }
      #summaryView, #dataView { overflow: visible; height: auto; }
      thead th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
      .crit-1, .crit-2, .crit-3,
      .cap-1, .cap-2, .cap-3,
      .ret-L, .ret-M, .ret-H, .ret-null,
      .overall-Low, .overall-Medium, .overall-High, .overall-Critical {
        -webkit-print-color-adjust: exact;
      }
    }

    /* Start view styling */
    #startView {
      padding: 0;
    }
    .start-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .start-intro, .start-guidance {
      background: #fff;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    .start-intro p {
      margin: 0 0 1em 0;
    }
    .start-guidance h3 {
      margin-top: 0;
    }
    .start-guidance ul {
      list-style-type: disc;
      padding-left: 20px;
    }
    .consolidate-container {
      padding: 16px;
    }
    .consolidate-actions {
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .start-buttons {
      /* Display the mill buttons in a responsive grid.  We use flexbox with
         wrapping so the nine mills wrap onto two rows when the container
         width allows.  Each button takes up roughly 20% of the available
         width minus the gap, yielding five buttons on the first row and
         four on the second. */
      margin: 24px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }
    .start-buttons button {
      flex: 1 0 calc(20% - 16px);
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid #888;
      border-radius: 4px;
      background-color: #fafafa;
      text-align: center;
    }
    .start-buttons button:hover {
      background-color: #f0f0f0;
    }

    /* Provide extra space below the reset button to separate it from the
       guidance box. */
    .start-reset {
      margin-bottom: 24px;
    }

    /* Highlight the active site in the navigation bar.  The active-site
       button uses the same blue as the header with white text for
       contrast. */
    .site-nav .btn.active-site {
      background-color: #1a73e8;
      color: #fff;
    }
    .site-nav .btn.active-site:hover {
      background-color: #1a5bc2;
    }

    /* Hide any grey section rows that were specific to the old pulp mill layout. */
    .dept-section {
      display: none;
    }
    /* Modal styles for Manage Roles */
    #manageRolesModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 16px;
      z-index: 1000;
      max-height: 80vh;
      max-width: 90vw;
      overflow-y: auto;
    }
    #manageRolesModal table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    #manageRolesModal th,
    #manageRolesModal td {
      border: 1px solid #ddd;
      padding: 4px 6px;
    }
    #manageRolesModal th {
      background-color: #f7f7f7;
      font-weight: 700;
    }
    #manageRolesModal td input {
      width: 90%;
      padding: 2px;
      font-size: 0.85rem;
    }
    #manageRolesModal button {
      margin-top: 8px;
      margin-right: 8px;
    }
    #secureExportModal {
      position: fixed;
      inset: 0;
      background-color: rgba(16, 33, 61, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1600;
      padding: 16px;
    }
    #secureExportModal.active {
      display: flex;
    }
    #secureExportModal .modal-card {
      background-color: #fff;
      color: #123;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      padding: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
    }
    #secureExportModal h2 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    #secureExportModal p {
      margin: 0 0 12px 0;
      line-height: 1.4;
    }
    #secureExportModal .form-field {
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #secureExportModal label {
      font-weight: 600;
      font-size: 0.88rem;
    }
    #secureExportModal input[type="password"] {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #c7c7c7;
      font-size: 0.95rem;
    }
    #secureExportModal .form-hint {
      font-size: 0.78rem;
      color: #53637a;
      margin-top: -6px;
    }
    #secureExportError {
      display: none;
      background: #fde7e9;
      color: #b8060f;
      border: 1px solid #f1999f;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }
    #secureExportModal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }
    .secure-export-toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      min-width: 240px;
      max-width: 320px;
      padding: 14px 18px;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      color: #fff;
      font-weight: 600;
      display: none;
      z-index: 1700;
    }
    .secure-export-toast.show {
      display: block;
    }
    .secure-export-toast.info {
      background: #1a73e8;
    }
    .secure-export-toast.success {
      background: #0f9d58;
    }
    .secure-export-toast.error {
      background: #d93025;
    }
    /* Banner to display expiry countdown: soft colors and compact styling */
    .expiry-banner {
      display: none;
      background-color: #fff9d6;
      color: #555;
      text-align: center;
      padding: 6px;
      border-bottom: 1px solid #eee3b2;
      font-size: 0.8rem;
    }
    /* Removed custom export button styling so toolbar actions share the same look. */
  </style>
  <!-- SheetJS library included via local file if present.  If the script fails
       to load from the local path (e.g. when the HTML is opened from a
       different directory), the export function will attempt to load the
       library from a CDN dynamically as a fallback. -->
  <!-- zip.js is loaded dynamically when secure ZIP export is used. -->
</head>
<body>
<div id="secureExportModal" role="dialog" aria-modal="true" aria-labelledby="secureExportTitle" aria-describedby="secureExportContext">
  <div class="modal-card">
    <h2 id="secureExportTitle">Secure ZIP export</h2>
    <p id="secureExportContext">Protect the exported data with a strong password before sharing or storing the assessment.</p>
    <div id="secureExportError" role="alert" aria-live="assertive"></div>
    <div class="form-field">
      <label for="secureExportPassword">Password</label>
      <input id="secureExportPassword" type="password" autocomplete="new-password" placeholder="Enter password"/>
    </div>
    <div class="form-field">
      <label for="secureExportPasswordConfirm">Confirm password</label>
      <input id="secureExportPasswordConfirm" type="password" autocomplete="new-password" placeholder="Re-enter password"/>
    </div>
    <p class="form-hint">Use at least 8 characters and include a mix of letters and numbers.</p>
    <div class="modal-actions">
      <button id="secureExportCancel" type="button" class="btn btn-muted">Cancel</button>
      <button id="secureExportSubmit" type="button" class="btn secure-export-button">Create ZIP</button>
    </div>
  </div>
</div>
<div id="secureExportToast" class="secure-export-toast" role="status" aria-live="polite"></div>
<!-- Start view shown when no site selected -->
<div id="startView" style="display: none;">
<div class="toolbar">
<h1 class="toolbar-title"><span aria-label="factory" role="img"></span>Welcome</h1>
      <!-- Global actions shown on the welcome page.  These buttons mirror
           the actions available in the worksheet (Export, Save, Print) but
           include an Upload responses button specific to the start page.
           Manage Roles and Show Summary are not shown on the welcome page. -->
      <div class="actions">
        <button id="exportSecureStartBtn"> Secure ZIP Export</button>
        <button id="saveVersionStartBtn">Save New HTML with Updated Roles</button>
        <button id="printStartBtn">Print</button>
        <button id="uploadResponsesStartBtn">Upload responses</button>
      </div>
</div>
<div class="start-container">
<div class="start-intro">
<p>This tool has been created to help us assess the skills, capabilities, retention risks, and mitigation plans for our plant.</p>
<p>Please use it as a structured way to review data, identify gaps, and plan actions for improvement.</p>
</div>
<!-- Added a simple name input so users can enter their name before starting.
     The name is collected for courtesy but not displayed on subsequent pages. -->
<div class="start-input-wrapper" style="text-align:center; margin-top:12px; margin-bottom:12px; display:flex; justify-content:center; align-items:center; flex-wrap:wrap; gap:8px;">
  <label for="startUserName" style="margin-right:4px; font-weight:bold;">Name:</label>
  <input id="startUserName" type="text" placeholder="Enter your name" style="padding:4px; border:1px solid #ccc; border-radius:4px; width:200px;">
  <label for="startPlantName" style="margin-left:12px; margin-right:4px; font-weight:bold;">Plant Name:</label>
  <input id="startPlantName" type="text" placeholder="Enter plant name" style="padding:4px; border:1px solid #ccc; border-radius:4px; width:200px;">
</div>
<!-- Only three options are available on the combined tool.  Each button calls loadSite() with the exact site name. -->
<div class="start-buttons">
  <!-- Single start button launches the assessment for the unified plant.  The
       additional actions (Upload responses, Secure ZIP export, Save, Print)
       have been moved to the toolbar for a consistent UI. -->
  <button onclick="startAssessment()">Start</button>
</div>
<!-- Reset button to restore the default starting data. Only shown on the welcome page. -->
<div class="start-reset" style="text-align:center; margin-top:12px;">
<button onclick="resetData()" style="background-color:#d9534f; color:#fff; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;">Reset Data</button>
</div>
<!-- Lock role structure toggle -->
<div class="start-lock" style="text-align:center; margin-top:12px;">
  <label style="font-weight:bold;"><input id="lockStructureToggle" type="checkbox"> Lock role structure</label>
</div>
<div class="start-guidance">
<h3>Good Practice for Workshops</h3>
<p>As we work through the data, please keep these points in mind:</p>
<ul>
<li>Challenge each other. Ask questions, test assumptions, and make sure ratings are accurate.</li>
<li>Step 1: Review whether criticality, capabilities, and retention risk have been rated effectively.</li>
<li>Step 2: Discuss our current methods for addressing any gaps identified.</li>
<li>Stay open and constructive. The more we challenge, the stronger and more reliable our data will be.</li>
<li>Focus on improvement. Our goal is to ensure we have the right approach for addressing gaps and building capability.</li>
</ul>
</div>
</div>
</div>
<!-- Site content container; hidden until a site is selected -->
<!-- Consolidation view is defined outside of startView so it can be shown independently of the welcome page -->
<div id="consolidationView" style="display:none;">
  <div class="toolbar">
  <div class="title">
    <h1 class="toolbar-title"><span aria-label="factory" role="img" style="margin-right:6px;"></span>Consolidate Responses</h1>
  </div>
  <div class="inputs" aria-hidden="true"></div>
  <div class="actions">
    <button type="button" class="btn btn-secondary" onclick="showStart()">Back to Start</button>
  </div>
</div>
  <div class="consolidate-container">
    <!-- Hidden file input for selecting multiple CSVs -->
    <input id="uploadInput" type="file" accept=".csv" multiple style="display:none;">
    <div class="consolidate-actions">
      <button id="uploadBtn" type="button" class="btn btn-primary">Upload responses</button>
      <button id="processBtn" type="button" class="btn btn-secondary">Process</button>
      <button id="downloadConsolidatedBtn" type="button" class="btn btn-secondary">Download consolidated CSV</button>
      <button id="updateToolBtn" type="button" class="btn btn-secondary">Update tool with consolidated data</button>
      <button id="clearConsolidatedBtn" type="button" class="btn btn-muted">Clear Data</button>
    </div>
    <!-- Area where the consolidated table will be rendered -->
    <div id="consolidatedOutput"></div>
  </div>
</div>
<div id="siteContent" style="">
<div class="toolbar">
<div class="title">
<h1 class="toolbar-title"><span aria-label="factory" role="img"></span>Plant Skills Assessment</h1>
</div>
<div class="inputs">
<!-- User Name input removed -->
<label>Mill: <input id="inputMill" placeholder="Enter mill" type="text"/></label>
</div>
<div class="actions">
<button id="toggleSummary">Show Summary</button>
        <!-- Secure ZIP Export button -->
        <button id="exportSecureBtn" type="button" class="btn secure-export-button"> Secure ZIP Export</button>
<button id="saveVersion" type="button" class="btn btn-secondary">Save New HTML with Updated Roles</button>
<button id="printBtn" type="button" class="btn btn-secondary">Print</button>
<button id="manageRolesBtn" type="button" class="btn btn-secondary">Manage Roles</button>
  <!-- Upload responses button is hidden on the site view but available on the start view.  It will be toggled via JavaScript. -->
  <button id="uploadResponsesBtn" type="button" class="btn btn-primary" style="display:none;">Upload responses</button>
</div>
</div>
<!-- Expiry countdown banner -->
<div id="expiryBanner" class="expiry-banner"></div>
<!-- Navigation for switching between mill sites and returning to start. -->
<div class="site-nav">
<strong>Navigation:</strong>
<button type="button" class="btn btn-muted" onclick="showStart()">Back to Start</button>
</div>
<div class="view" id="dataView">
<table id="dataTable">
<thead>
<tr>
<!-- Removed Department and Cluster columns. Role column now contains cluster on top and role name below -->
<th class="col-role" title="Role">Role</th>
<!-- Removed the separate Cluster column; cluster name will be shown above the role name -->
<th class="col-crit" title="1  Essential, but short-term gaps can be managed. Impact is felt over months or years if not addressed.&#10;&#10;&#10;2  Important and increasingly disruptive if missing for weeks or months. Sustained absence reduces effectiveness and performance.&#10;&#10;&#10;3  Vital for ongoing operations or delivery. Any short-term lapse (days or weeks) causes immediate and significant disruption.">Criticality</th>
<th class="col-cap" title="1  Significant Gap: Current capability is well below what the role requires. Consistent support or development needed to perform effectively.&#10;&#10;&#10;2  Adequate / Developing: Meets most role requirements but with room for improvement. Performs competently in familiar situations; some growth still needed for full mastery.&#10;&#10;&#10;3  Strong Performance: Fully meets or exceeds expectations for the role. Demonstrates consistent, high-quality performance and applies the capability effectively in complex or changing contexts.">Capability</th>
<th class="col-ret" title="Retention Risk (HML scale):&#10;&#10;&#10;High: Likely to leave within 12 months. Clear indicators such as approaching retirement, active job search, dissatisfaction with role, leadership, or culture, or pay notably below market. Requires immediate action.&#10;&#10;&#10;Medium: Possible departure within 12 years. Some signs of disengagement, partial dissatisfaction, or moderate pay gap. Retention depends on improved development, recognition, or future opportunities.&#10;&#10;&#10;Low: Unlikely to leave in the foreseeable future. Individual is satisfied, well-compensated, and engaged with their work and environment. Risk limited to unexpected external offers or life events.">Retention Risk</th>
<th class="col-overall" title="Overall Risk">Overall Risk</th>
<th class="col-comments" title="Comments">Comments</th>
<th class="col-pref" title="Mitigation">Mitigation</th>
<th class="col-gap" title="Mitigation Details">Mitigation Details</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div> <!-- end of siteContent -->

<!-- Manage Roles Modal -->
<div id="manageRolesModal" style="display:none;">
  <h3>Manage Roles</h3>
  <div id="rolesList"></div>
  <div style="margin-top:12px;">
    <button id="addRoleBtnModal">Add Role</button>
    <button id="closeRolesModalBtn">Close</button>
  </div>
</div>

<!-- Placeholder summary view.  When the user toggles the summary on, the script
     will populate this container with dynamic content.  Leaving it empty
     here avoids displaying any legacy summary data from prior assessments. -->
<div id="summaryView" class="view hidden"></div>

<!-- Seed data embedded from Excel (JSON format).  We provide an empty
     rows array here because this combined Plant tool does not use any
     pre-filled site-specific default rows. -->
<script id="seed-data" type="application/json">{"rows": []}</script>

<script>
    (function() {
      // Utility functions for calculations
      function computeCapabilityAvg(row) {
        // Coerce numeric values to numbers before averaging. If any cell is
        // provided as a string (e.g. "3"), addition on strings can lead to
        // concatenation which breaks averaging. Cast to floats here.
        const rawVals = [row.capTech, row.capExperience, row.capCrisis, row.capLeadComm, row.capSafety];
        const vals = rawVals.filter(v => v !== null && v !== undefined).map(v => {
          // parseInt may return NaN for empty strings; fallback to null
          const num = typeof v === 'string' ? parseFloat(v) : v;
          return isNaN(num) ? null : num;
        }).filter(v => v !== null);
        if (!vals.length) return null;
        const sum = vals.reduce((a, b) => a + b, 0);
        return sum / vals.length;
      }
      function bucketCapability(avg) {
        if (avg === null) return null;
        if (avg >= 2.5) return 3;
        if (avg >= 1.5) return 2;
        return 1;
      }

      /**
       * Round down values that end in .5 to the next lower integer.  For example,
       * 0.5 becomes 0, 1.5 becomes 1, and 2.5 becomes 2.  Values that do
       * not have a fractional part of 0.5 are returned unchanged.  A small
       * tolerance is used to account for floatingpoint imprecision.
       *
       * @param {number|null} val The numeric value to adjust.
       * @returns {number|null} The adjusted value or the original if no change is needed.
       */
      function roundDownHalf(val) {
        if (val == null) return val;
        const frac = val - Math.floor(val);
        // Use a tolerance to handle floating point rounding errors, e.g. 0.49999999
        if (Math.abs(frac - 0.5) < 1e-6) {
          return Math.floor(val);
        }
        return val;
      }

      /**
       * Round a numeric value to the nearest whole number while always rounding
       * .5 values down (toward zero). This helper is used when computing
       * aggregated capability dimensions that must map onto discrete rating
       * options (03) in the main assessment.  For example, 1.2  1,
       * 1.5  1, 1.8  2. Negative numbers are returned unchanged.
       *
       * @param {number|null} val The numeric value to round.
       * @returns {number|null} The rounded integer or the original value if null.
       */
      function roundNearestWholeHalfDown(val) {
        if (val == null) return val;
        // Only operate on non-negative numbers. If the value is negative,
        // simply return it unchanged.
        if (val < 0) return val;
        const floor = Math.floor(val);
        const frac = val - floor;
        // Treat .5 specially: always round down
        if (Math.abs(frac - 0.5) < 1e-6) {
          return floor;
        }
        // Otherwise, round to nearest whole: frac < 0.5  floor, frac > 0.5  floor+1
        let result = (frac < 0.5 ? floor : floor + 1);
        // Enforce a minimum value of 1 because the rating scale in the
        // assessment does not support zero.  Without this adjustment,
        // averages below 0.5 would produce 0, which cannot be represented
        // in the dropdown and would render as a dash.
        if (result < 1) result = 1;
        return result;
      }
      function mapRetentionNum(val) {
        if (!val || val === '-') return null;
        if (val === 'L') return 1;
        if (val === 'M') return 2;
        if (val === 'H') return 3;
        return null;
      }
      function computeOverallRisk(row) {
        /*
         * Overall risk mapping derived from the criticality map document. The
         * overall risk is determined by combining the role's criticality (1 =
         * Low, 2 = Medium, 3 = High) with its capability bucket (1 = Low,
         * 2 = Medium, 3 = High) and retention risk (L/M/H mapped to 1/2/3).
         * Missing capability values default to High (3) and missing
         * retention risk defaults to Low (1) to avoid penalising unknowns.
         *
         * The mapping for each criticality level is:
         *
         * Criticality = High (3):
         *   cap\ret  1    2        3
         *    3      Low  Medium   High
         *    2     Medium High    Critical
         *    1     High  Critical Critical
         *
         * Criticality = Medium (2):
         *   cap\ret  1    2        3
         *    3      Low  Medium   Medium
         *    2     Medium Medium   High
         *    1     Medium High    High
         *
         * Criticality = Low (1):
         *   cap\ret  1    2        3
         *    3      Low  Low      Low
         *    2      Low  Low     Medium
         *    1      Low  Medium  Medium
         */
        const criticality = row.criticality != null ? Math.round(row.criticality) : null;
        // Default missing capability to high capability
        const capBucket = row.capabilityBucket != null ? row.capabilityBucket : 1;
        // Default missing retention risk to low
        const retNumRaw = mapRetentionNum(row.retentionRisk);
        const ret = retNumRaw != null ? retNumRaw : 1;
        if (!criticality) return null;
        // High criticality
        if (criticality === 3) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Medium';
          if (capBucket === 3 && ret === 3) return 'High';
          if (capBucket === 2 && ret === 1) return 'Medium';
          if (capBucket === 2 && ret === 2) return 'High';
          if (capBucket === 2 && ret === 3) return 'Critical';
          if (capBucket === 1 && ret === 1) return 'High';
          if (capBucket === 1 && ret === 2) return 'Critical';
          if (capBucket === 1 && ret === 3) return 'Critical';
        }
        // Medium criticality
        if (criticality === 2) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Medium';
          if (capBucket === 3 && ret === 3) return 'Medium';
          if (capBucket === 2 && ret === 1) return 'Medium';
          if (capBucket === 2 && ret === 2) return 'Medium';
          if (capBucket === 2 && ret === 3) return 'High';
          if (capBucket === 1 && ret === 1) return 'Medium';
          if (capBucket === 1 && ret === 2) return 'High';
          if (capBucket === 1 && ret === 3) return 'High';
        }
        // Low criticality
        if (criticality === 1) {
          if (capBucket === 3 && ret === 1) return 'Low';
          if (capBucket === 3 && ret === 2) return 'Low';
          if (capBucket === 3 && ret === 3) return 'Low';
          if (capBucket === 2 && ret === 1) return 'Low';
          if (capBucket === 2 && ret === 2) return 'Low';
          if (capBucket === 2 && ret === 3) return 'Medium';
          if (capBucket === 1 && ret === 1) return 'Low';
          if (capBucket === 1 && ret === 2) return 'Medium';
          if (capBucket === 1 && ret === 3) return 'Medium';
        }
        return null;
      }
      /**
       * Determine which capability dimensions are low (value === 1).
       * Returns an array of strings like "Technical knowledge".
       */
      function getLowDimensions(row) {
        const dims = [];
        if (row.capTech === 1) dims.push('Technical knowledge');
        if (row.capExperience === 1) dims.push('Experience');
        if (row.capCrisis === 1) dims.push('Crisis management');
        if (row.capLeadComm === 1) dims.push('Leadership & Communication');
        if (row.capSafety === 1) dims.push('Safety mindset');
        return dims;
      }
      /**
       * Build a multiline comments string for display in the table.
       * It separates capability and retention comments into their own sections
       * with bullet points. Automatic notes about low capability dimensions are
       * appended to the capability section.
       */
      function displayComments(row) {
        const lines = [];
        // Capability section
        const capLines = [];
        // manual capability comments
        if (row.capabilityComment) {
          row.capabilityComment.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
              // Append capability comments without a leading dash.  Dashes can
              // interfere with consolidation and are unnecessary for simple
              // listing.
              capLines.push(trimmed);
            }
          });
        }
        // Removed auto generated low dimension notes to avoid duplicate comments during merging.
        // Always include a Capability section.  Only add bullet lines if
        // capability comments exist; otherwise leave the section empty.  This
        // avoids inserting placeholder dashes that would pollute consolidated
        // comments.
        lines.push('Capability:');
        if (capLines.length) {
          lines.push(...capLines);
        }
        // Retention section
        const retLines = [];
        if (row.retentionComment) {
          row.retentionComment.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
              // Append retention comments without a leading dash
              retLines.push(trimmed);
            }
          });
        }
        // Insert an extra blank line between capability and retention only if
        // there are capability lines.  This keeps the two sections separate
        // without introducing empty bullets when there are no notes.
        if (capLines.length) {
          lines.push('');
          lines.push('');
        }
        lines.push('Retention:');
        if (retLines.length) {
          lines.push(...retLines);
        }
        // Additional general comments (from original comments field) if provided
        const addLines = [];
        if (row.comments) {
          row.comments.split(/\n/).forEach(l => {
            const trimmed = l.trim();
            if (trimmed) {
                  // Append additional comments without a leading dash
                  addLines.push(trimmed);
            }
          });
        }
        if (addLines.length) {
          // Add a single blank line before Additional section for separation
          lines.push('');
          lines.push('Additional:');
          lines.push(...addLines);
        }
        if (lines.length === 0) return '';
        return lines.join('\n');
      }
      // Parse seed data
      const seedEl = document.getElementById('seed-data');
      const seedJson = JSON.parse(seedEl.textContent);
      // Override the seed data rows to reflect paper mill roles instead of pulp mill roles
      /* Override of seedJson.rows for paper roles is no longer used in this combined tool.
      seedJson.rows = [
        {department: null, cluster: null, roleArea: 'Operations Manager (Paper)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supervisor (Shift/Area)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production / Area Manager  Paper Machine, Finishing & Converting', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Maintenance & Reliability Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Process Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Project Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'HSE Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Quality Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'R&D / Technical Services Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supply Chain Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Logistics & Warehouse Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Continuous Improvement / Lean Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Finance / Plant Controller', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];
      */

      // Define the list of mills (sites) for the paper mill assessment.
      // Each site will maintain its own independent data set.
      // Define the list of mills (sites) for the combined pulp and paper assessment.
      // Only three options are available: a pulp-only view, a paper & shared view, and Jnkping.
      const siteNames = [
        'Plant'
      ];

      // Definitions for each role.  When hovering over a role name in the
      // table, the corresponding definition will appear as a tooltip.  These
      // descriptions describe the core responsibilities of each role in
      // the paper mill.  If a role is not listed here, no tooltip is
      // displayed.
      const roleDefinitions = {
        'Operations Manager (Paper)': 'Production planning and coordination; grade changeovers; stabilising run conditions; KPI control (speed, waste, quality, uptime); cross-shift alignment; clear escalation.',
        'Supervisor (Shift/Area)': 'Front-line leadership; control-room/line operation; safe start-up/shutdown; standard work enforcement; quick escalation; training and performance feedback.',
        'Production / Area Manager  Paper Machine, Finishing & Converting': 'High-speed run stability across areas; crew leadership and training; standard work discipline; fast troubleshooting of breaks/defects; safe operations; clean handovers.',
        'Maintenance & Reliability Manager': 'Preventive/predictive programs; rapid breakdown response; root-cause fixes; shutdown/turnaround planning; spares control; reliability and uptime improvement.',
        'Process Engineer': 'Optimising wet end, pressing, drying, calendering; data analysis/SPC; fibre/chemistry tuning; run trials; energy/water reduction; solving chronic losses.',
        'Project Engineer': 'Capex scoping and business cases; equipment spec/selection; installation and commissioning; contractor/vendor control; schedule/cost/risk management; change control.',
        'HSE Manager': 'Compliance and permits; risk assessments and safe systems of work; training and audits; incident investigation and learning; effluent/air/noise monitoring; regulator reporting.',
        'Quality Manager': 'QMS ownership; lab methods and release testing; SPC basics; traceability and certificates; customer complaints/CAPA; supplier quality checks.',
        'R&D / Technical Services Manager': 'New grade development; fibre blends and sizing/coating optimisation; pilot/plant trials and scale-up; customer line support; specs and datasheets.',
        'Supply Chain Manager': 'Pulp/chemical/packaging procurement; inventory and warehouse control; production & delivery planning; logistics coordination; cost-to-serve optimisation.',
        'Logistics & Warehouse Manager': 'Dock/yard operations; carrier management; export docs; roll/pack integrity and damage prevention; layout, picking, cycle counts; on-time dispatch.',
        'Continuous Improvement / Lean Manager': 'Structured problem-solving (A3, 5-Why); process mapping; standard work/visual controls; kaizen facilitation; benefits tracking and verification.',
        'Finance / Plant Controller': 'Costing/variance analysis; budgets/forecasts; inventory valuation/controls; capex cases; compliance; decision support to operations.'
      };

      // Persist role definitions so that edited descriptions are saved across sessions.
      // Definitions are stored under a dedicated key in localStorage.  When editing or
      // adding roles in the Manage Roles modal, changes to descriptions are saved via
      // saveDefinitions().  Upon load, loadDefinitions() will override the default
      // descriptions with any saved values.
      const DEFINITIONS_KEY = 'plant_skills_roleDefinitions';
      function loadDefinitions() {
        try {
          const saved = localStorage.getItem(DEFINITIONS_KEY);
          if (saved) {
            const obj = JSON.parse(saved);
            if (obj && typeof obj === 'object') {
              Object.keys(obj).forEach(k => {
                roleDefinitions[k] = obj[k];
              });
            }
          }
        } catch (e) {
          // Ignore parse errors
        }
      }
      function saveDefinitions() {
        try {
          localStorage.setItem(DEFINITIONS_KEY, JSON.stringify(roleDefinitions));
        } catch (e) {
          // Ignore storage errors
        }
      }

      // Prepare default data sets for each site. These are deep copies of the
      // seed rows and serve as the baseline when first loading or resetting a site.
      /*
       * Define default data for each site.  Rather than cloning the generic
       * seed data for every site, we explicitly set up rows for our three
       * sites.  The pulp rows mirror the structure of the combined pulp
       * assessment but have all numeric ratings set to the lowest level and
       * comments left blank.  The paper rows reflect the paper mill roles with
       * default ratings of 1 (capabilities) and 'M' retention risk.  The
       * sharedRow represents the maintenance & reliability role that is
       * shared between the pulp and paper mills; it is only included on the
       * "Billingfors (Paper and shared)" view.
       */

      // Pulp-specific rows with low criticality/capability and low retention risk
      const pulpRows = [
        {department: null, cluster: 'Process Engineering', roleArea: 'Process Engineering', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Maintenance', roleArea: 'Pulp-Specific Maintenance', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Project Engineering', roleArea: 'Project Engineering', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: 'Health Safety & Environment', roleArea: 'Health Safety & Environment', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];

      // Paper-specific rows with default capability ratings of 1 and medium retention risk
      const paperRows = [
        {department: null, cluster: null, roleArea: 'Operations Manager (Paper)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supervisor (Shift/Area)', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Production / Area Manager  Paper Machine, Finishing & Converting', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Maintenance & Reliability Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Process Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Project Engineer', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'HSE Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Quality Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'R&D / Technical Services Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Supply Chain Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Logistics & Warehouse Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Continuous Improvement / Lean Manager', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''},
        {department: null, cluster: null, roleArea: 'Finance / Plant Controller', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'M', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''}
      ];

      // Row that is shared between pulp and paper (maintenance & reliability)
      const sharedRow = {department: 'Shared with Papermill', cluster: 'Maintenance & Reliability', roleArea: 'Maintenance & Reliability', criticality: 1, capTech: 1, capExperience: 1, capCrisis: 1, capLeadComm: 1, capSafety: 1, capabilityComment: '', retentionRisk: 'L', retentionComment: '', comments: '', preferredMethod: '-', gapMethodComment: ''};

      // Build the default data object for the single unified plant.  We clone the
      // seed rows so that edits do not affect the original seed data.  The
      // previous pulp and paper specific definitions are retained above but
      // unused now that only one plant is supported.
      const defaultData = {
        // Initialise the single Plant site using the paper mill roles from the
        // Jonkping paper mill.  Each row is cloned from the paperRows array
        // defined above, with numeric ratings set to 1 and retention risk
        // defaulting to Low ("L") and empty comments.  This ensures that
        // the roles displayed on the Plant site reflect the paper mill rather
        // than the generic seed data.  See the paperRows definition above for
        // the list of roles and their descriptions.
        'Plant': paperRows.map(r => {
          const obj = Object.assign({}, r);
          obj.criticality = 1;
          obj.capTech = 1;
          obj.capExperience = 1;
          obj.capCrisis = 1;
          obj.capLeadComm = 1;
          obj.capSafety = 1;
          // Default retention risk to Low and clear any comments.  Although
          // the paperRows default is Medium ("M"), using Low here aligns
          // with the requested baseline of 1/Low across all metrics.
          obj.retentionRisk = 'L';
          obj.capabilityComment = '';
          obj.retentionComment = '';
          obj.comments = '';
          obj.preferredMethod = '-';
          obj.gapMethodComment = '';
          return obj;
        })
      };

      // If a site-defaults script is present, parse it to override the defaults.
      // This script may contain a JSON object keyed by site name. The content
      // can be plain JSON or base64-encoded JSON. When present, it allows
      // preserving per-site edits when saving the tool.
      try {
        const siteDefaultsEl = document.getElementById('site-defaults');
        if (siteDefaultsEl) {
          let text = siteDefaultsEl.textContent.trim();
          let parsed = null;
          try {
            // Try to parse plain JSON first
            parsed = JSON.parse(text);
          } catch (jsonErr) {
            try {
              // Attempt to decode from base64. Use decodeURIComponent/escape
              // to properly handle Unicode characters if the plain atob fails.
              const decoded = atob(text);
              try {
                parsed = JSON.parse(decoded);
              } catch (innerErr) {
                parsed = JSON.parse(decodeURIComponent(escape(decoded)));
              }
            } catch (b64Err) {
              parsed = null;
            }
          }
          if (parsed && typeof parsed === 'object') {
            Object.keys(parsed).forEach(name => {
              if (Array.isArray(parsed[name])) {
                defaultData[name] = parsed[name].map(r => Object.assign({}, r));
              }
            });
            // If a lock state is present in the saved defaults, restore it
            if (parsed.lock && typeof parsed.lock.structureLocked !== 'undefined') {
              structureLocked = !!parsed.lock.structureLocked;
            }
            // If role definitions are included, override the defaults
            if (parsed.definitions && typeof parsed.definitions === 'object') {
              Object.keys(parsed.definitions).forEach(k => {
                roleDefinitions[k] = parsed.definitions[k];
              });
            }
          }
        }
      } catch (e) {
        console.error('Failed to parse custom site defaults', e);
      }
      // Initialize global variables for site, storage, and row data. The site
      // will be selected by the user via the start screen, so default to
      // "default" until loadSite() is invoked.
      const STORAGE_KEY_PREFIX = 'pulp_skills_data_20250825201950_20250910150825_';
      let currentSite = null;
      let siteParam = 'default';
      let storageKey = STORAGE_KEY_PREFIX + siteParam;
      let rows = [];
      // Flag to indicate whether the role structure is locked. When true, users cannot add, rename, or delete roles.
      let structureLocked = false;
      // Track whether the summary view is currently visible. When switching
      // plants, this value will be used to restore the summary state.
      let summaryVisible = false;

      // Load previously saved data or seed data for the given site. This
      // function is called when loadSite() is invoked.
      function loadRowsForSite() {
        rows = [];
        // Determine whether we loaded data from localStorage. This helps us
        // distinguish between usersaved data and default starting data.
        let loadedFromStorage = false;
        try {
          const saved = localStorage.getItem(storageKey);
          if (saved) {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              parsed.forEach((r) => rows.push(Object.assign({}, r)));
              loadedFromStorage = true;
            }
          }
        } catch (e) {
          // ignore errors and fall back to seed
        }
        // If there is no saved data in storage, fall back to the default
        // starting data for the current site. We prefer sitespecific
        // defaults from defaultData for the requested site. If for some
        // reason that data is missing, we use the seed JSON rows as a
        // fallback.
        if (rows.length === 0) {
          const siteDefaults = defaultData[currentSite];
          if (siteDefaults && Array.isArray(siteDefaults)) {
            siteDefaults.forEach((r) => rows.push(Object.assign({}, r)));
          } else if (seedJson.rows && Array.isArray(seedJson.rows)) {
            seedJson.rows.forEach((r) => rows.push(Object.assign({}, r)));
          }
          loadedFromStorage = false;
        }
        // Removed per-site retention risk customization. All sites start with
        // the same retention risk defined in the seed rows.
        // Compute derived values
        rows.forEach((row, idx) => {
          row.id = idx;
          row.capabilityAvg = computeCapabilityAvg(row);
          row.capabilityBucket = bucketCapability(row.capabilityAvg);
          row.overallRisk = computeOverallRisk(row);
        });
      }

      // Load a given site, show the worksheet, and hide the start screen.
      window.loadSite = function(siteName) {
        // Commit any inprogress edits before switching sites. This ensures
        // that values currently being edited are saved before we potentially
        // rerender the table.
        commitEditing();
        // Capture the previously selected site before updating state.  We
        // compare this to the requested site below to decide whether to
        // reload rows from storage or defaults.
        const previousSite = currentSite;
        // Update the current site and storage key based on the requested site
        currentSite = siteName;
        siteParam = siteName;
        storageKey = STORAGE_KEY_PREFIX + siteName;
        // Prepopulate the mill field only if the user has not already entered
        // a plant name.  This preserves the plant name typed on the welcome
        // page when returning to the same site.
        const millInputEl2 = document.getElementById('inputMill');
        if (millInputEl2 && !millInputEl2.value) {
          millInputEl2.value = siteName;
        }
        // If we are loading a different site or the rows are empty, read
        // persisted data (or defaults) for this site.  When the user returns
        // to the same site from the start screen, we skip this step so that
        // previously entered data remains intact.  This prevents the Start
        // button from discarding unsaved work.
        if (rows.length === 0 || previousSite !== siteName) {
          loadRowsForSite();
        }
        // Render the table view for the selected site
        renderTable();
        // Build navigation bar: always include Back to Start
        const navEl = document.querySelector('.site-nav');
        if (navEl) {
          const navHtml = '<strong>Navigation:</strong> <button type="button" class="btn btn-muted" onclick="showStart()">Back to Start</button>';
          navEl.innerHTML = navHtml;
        }
        // Restore summary visibility if it was previously active.  This ensures
        // that switching between sites retains the view state (summary vs data).
        const summaryEl = document.getElementById('summaryView');
        const dataEl = document.getElementById('dataView');
        const toggleBtn = document.getElementById('toggleSummary');
        if (summaryVisible) {
          generateSummary();
          summaryEl.classList.remove('hidden');
          dataEl.classList.add('hidden');
          if (toggleBtn) toggleBtn.textContent = 'Show Full Data';
        } else {
          summaryEl.classList.add('hidden');
          dataEl.classList.remove('hidden');
          if (toggleBtn) toggleBtn.textContent = 'Show Summary';
        }
        // Show site content and hide start view
        const siteDiv = document.getElementById('siteContent');
        const startDiv = document.getElementById('startView');
        if (siteDiv) siteDiv.style.display = '';
        if (startDiv) startDiv.style.display = 'none';

        // When a site is loaded, adjust the toolbar actions to show
        // Manage Roles and Show Summary buttons and hide Upload responses.  This
        // ensures the blue toolbar displays consistent core actions and only
        // toggles additional functions relevant to the worksheet.
        if (typeof updateTopActionsForSite === 'function') {
          updateTopActionsForSite();
        }
      };

      // Show the start screen and hide the worksheet.
      window.showStart = function() {
        // Commit any in-progress edits before hiding the worksheet
        commitEditing();
        const siteDiv = document.getElementById('siteContent');
        const startDiv = document.getElementById('startView');
        // Also hide the consolidation view when returning to the start so it doesn't remain visible
        const consDiv = document.getElementById('consolidationView');
        if (siteDiv) siteDiv.style.display = 'none';
        if (startDiv) startDiv.style.display = '';
        if (consDiv) consDiv.style.display = 'none';
        // Hide summary view and show data view when returning to start.
        const summaryDiv = document.getElementById('summaryView');
        const dataDiv = document.getElementById('dataView');
        const toggleBtn = document.getElementById('toggleSummary');
        if (summaryDiv) {
          summaryDiv.classList.add('hidden');
        }
        if (dataDiv) {
          dataDiv.classList.remove('hidden');
        }
        // Reset summary button label and state
        if (toggleBtn) {
          toggleBtn.textContent = 'Show Summary';
        }
        summaryVisible = false;

        // Update the toolbar actions to reflect the welcome page.  Hide
        // Manage Roles and Show Summary buttons and show Upload responses
        // and the start-specific Save/Export/Print buttons.
        if (typeof updateTopActionsForStart === 'function') {
          updateTopActionsForStart();
        }
      };

      // On initial load, clear any persisted assessment data and then show the
      // start screen.  Clearing here ensures that previously saved data from
      // earlier sessions does not prepopulate the worksheet.  Data entered
      // during the current session will continue to persist via localStorage
      // until the page is reloaded or the user clicks the Reset Data button.
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // Remove all keys beginning with our storage prefix so each new
          // session starts fresh.  Without this removal, reopening the tool
          // could surface stale data from prior assessments.
          Object.keys(localStorage).forEach(function(k) {
            if (k.startsWith(STORAGE_KEY_PREFIX)) {
              localStorage.removeItem(k);
            }
          });
        } catch (e) {
          // Silently ignore any storage errors (e.g. disabled storage)
        }
        showStart();
      });

      /**
       * Reset the persisted data for all sites back to the original default
       * starting values. This function is called from a button on the
       * welcome page. It writes the default data back into localStorage
       * for all supported sites and clears any in-memory state. After
       * resetting, the next time a site is loaded it will read from the
       * freshly reset storage.
       */
      window.resetData = function() {
        // Confirm resetting but keep role structure by unioning saved and default roles.
        if (!confirm('Reset all ratings and comments to defaults, keeping the role list?')) return;
        try {
          // Determine base prefix for storage keys (remove current siteParam from storageKey)
          const basePrefix = STORAGE_KEY_PREFIX;
          // For each site, compute the union of roles from saved data and defaultData, then reset values to defaults
          siteNames.forEach(name => {
            const roleSet = new Set();
            // Roles from saved localStorage
            try {
              const savedStr = localStorage.getItem(basePrefix + name);
              if (savedStr) {
                JSON.parse(savedStr).forEach(r => {
                  if (r && r.roleArea) roleSet.add(r.roleArea);
                });
              }
            } catch (ex) {
              console.error('Error reading saved data during reset for', name, ex);
            }
            // Roles from defaultData
            if (defaultData[name]) {
              defaultData[name].forEach(r => {
                if (r && r.roleArea) roleSet.add(r.roleArea);
              });
            }
            // Build new rows with default values
            const newRows = Array.from(roleSet).map(roleName => {
              return defaultRowTemplate(roleName);
            });
            // Save into localStorage
            try {
              localStorage.setItem(basePrefix + name, JSON.stringify(newRows));
            } catch (saveEx) {
              console.error('Error saving reset data for', name, saveEx);
            }
          });
          // If currently viewing a site, reload its rows from storage and render
          if (currentSite) {
            try {
              const savedStr = localStorage.getItem(storageKey);
              rows = savedStr ? JSON.parse(savedStr) : [];
              rows.forEach((row, i) => {
                row.id = i;
                row.capabilityAvg = computeCapabilityAvg(row);
                row.capabilityBucket = bucketCapability(row.capabilityAvg);
                row.overallRisk = computeOverallRisk(row);
              });
              renderTable();
            } catch (err) {
              console.error('Failed to reload rows after reset', err);
            }
          }
          alert('All ratings/comments reset. Your role list was preserved.');
        } catch (e) {
          console.error('Failed to reset data:', e);
        }
      };

      // Save the current rows array to localStorage for this site. Invoked after
      // any edit so data persists between visits.
      function saveData() {
        try {
          localStorage.setItem(storageKey, JSON.stringify(rows));
          // Update expiry timestamp whenever data is saved
          if (typeof setExpiry === 'function') {
            setExpiry();
          }
        } catch (e) {
          // Silently ignore storage errors (e.g. quota exceeded)
        }
      }

      // -----------------------------------------------------------------------------
      // Data expiry management
      // Set a timestamp 3 days in the future whenever data is saved.  The
      // expiration timestamp is stored in localStorage under a key derived from
      // STORAGE_KEY_PREFIX.  On page load and periodically thereafter, the
      // checkExpiry function will compare the current time to the stored
      // timestamp. If the data has expired, it clears all persisted
      // assessment data for this tool and resets the view. It also updates a
      // small banner showing the remaining time until expiry.
      const DATA_EXPIRY_MS = 3 * 24 * 60 * 60 * 1000;
      // Use a fixed key for storing the expiration timestamp.  Earlier
      // implementations attempted to construct a key using an undefined
      // storage prefix, which resulted in the expiry timestamp being stored
      // under an unintended key.  Using a constant ensures the expiry timer
      // persists correctly.
      const EXPIRY_KEY = 'plant_skills_dataExpiry';
      function setExpiry() {
        try {
          const expiryTimestamp = Date.now() + DATA_EXPIRY_MS;
          localStorage.setItem(EXPIRY_KEY, String(expiryTimestamp));
        } catch (e) {
          // ignore storage errors
        }
      }
      function checkExpiry() {
        try {
          const banner = document.getElementById('expiryBanner');
          const expiryVal = localStorage.getItem(EXPIRY_KEY);
          if (!expiryVal) {
            if (banner) banner.style.display = 'none';
            return;
          }
          const expiry = parseInt(expiryVal, 10);
          const now = Date.now();
          if (isNaN(expiry)) {
            if (banner) banner.style.display = 'none';
            return;
          }
          if (now >= expiry) {
            // Gather keys for deletion first to avoid modifying localStorage while iterating
            const keysToDelete = [];
            for (let i = 0; i < localStorage.length; i++) {
              const k = localStorage.key(i);
              // Only remove keys associated with this assessment tool.  Keys
              // containing other site prefixes (plant_skills_, pulp_skills_data_, mill_skills_)
              // are considered part of this tool's storage and will be
              // cleared.  Other localStorage keys are left untouched.
              if (k && (k.indexOf('plant_skills_') !== -1 || k.indexOf(STORAGE_KEY_PREFIX) !== -1 || k.indexOf('mill_skills_') !== -1)) {
                keysToDelete.push(k);
              }
            }
            keysToDelete.forEach(function(k) { localStorage.removeItem(k); });
            rows = [];
            if (typeof showStart === 'function') {
              showStart();
            }
            if (banner) banner.style.display = 'none';
            alert(' Assessment data expired (3 days old). Please start fresh or upload previous export.');
            // Clear the expiry timestamp
            localStorage.removeItem(EXPIRY_KEY);
            return;
          }
          // compute remaining time
          const ms = expiry - now;
          const days = Math.floor(ms / (24*60*60*1000));
          const hours = Math.floor((ms % (24*60*60*1000)) / (60*60*1000));
          const minutes = Math.floor((ms % (60*60*1000)) / (60*1000));
          const parts = [];
          if (days > 0) parts.push(days + 'd');
          if (hours > 0 || days > 0) parts.push(hours + 'h');
          // always include minutes for clarity
          parts.push(minutes + 'm');
          if (banner) {
            banner.textContent = ' Assessment data will expire in ' + parts.join(' ') + '. Please export before expiration.';
            banner.style.display = 'block';
          }
        } catch (e) {
          console.error(e);
        }
      }
      // Carry-forward for display: this returns array of displayRows with departmentDisplay and clusterDisplay plus rowspans
      function computeDisplayRows() {
        let displayRows = rows.map(row => Object.assign({}, row));
        // Carry-forward department & cluster display text
        let lastDept = null;
        let lastCluster = null;
        displayRows.forEach(r => {
          if (r.department) lastDept = r.department;
          r.departmentDisplay = r.department || lastDept || '';
          if (r.cluster) lastCluster = r.cluster;
          r.clusterDisplay = r.cluster || lastCluster || '';
        });
        // Compute grouping for rowspans
        // First group by departmentDisplay; then clusterDisplay
        let i = 0;
        while (i < displayRows.length) {
          const dept = displayRows[i].departmentDisplay;
          let j = i;
          // find consecutive rows with same department
          while (j < displayRows.length && displayRows[j].departmentDisplay === dept) {
            j++;
          }
          const deptCount = j - i;
          // inside this block, compute clusters
          let k = i;
          while (k < j) {
            const cluster = displayRows[k].clusterDisplay;
            let l = k;
            while (l < j && displayRows[l].clusterDisplay === cluster) {
              l++;
            }
            const clusterCount = l - k;
            // assign rowspans: if cluster text equals department text, merge cells (colspan=2) on first row
            for (let m = k; m < l; m++) {
              displayRows[m].deptRowspan = 0;
              displayRows[m].clusterRowspan = 0;
              displayRows[m].clusterMerged = false;
            }
            if (deptCount > 0) {
              // Only set deptRowspan on first cluster group start row
              displayRows[i].deptRowspan = deptCount;
            }
            if (clusterCount > 0) {
              // If department and cluster labels are identical (and non-empty) then merge into one cell with colspan=2
              if (cluster === dept && cluster) {
                // merge cluster into department: we'll mark clusterMerged on first row of this cluster
                displayRows[k].deptRowspan = clusterCount;
                displayRows[k].clusterMerged = true;
              } else {
                displayRows[k].clusterRowspan = clusterCount;
              }
            }
            k = l;
          }
          i = j;
        }
        return displayRows;
      }
      // Render full data table
      const tbody = document.querySelector('#dataTable tbody');
      function renderTable() {
        // Clear any active inline editor before rebuilding the table. After a
        // re-render, no cell should be marked as editing.
        editingCell = null;
        closePopover();
        tbody.innerHTML = '';
        // Build rows directly from the underlying data. Insert a department
        // section row whenever a new department value is encountered. The
        // section rows span all visible columns (8) and display the department
        // name.
        let prevDept = null;
        rows.forEach((r) => {
          // Insert a section header row if this row introduces a new department
          if (r.department && r.department !== prevDept) {
            const sectionTr = document.createElement('tr');
            sectionTr.className = 'dept-section';
            const td = document.createElement('td');
            td.colSpan = 8; // number of visible columns: role (includes cluster), crit, cap, ret, overall, comments, pref, gap
            td.textContent = r.department;
            sectionTr.appendChild(td);
            tbody.appendChild(sectionTr);
            prevDept = r.department;
          }
          const tr = document.createElement('tr');
          tr.dataset.rowId = r.id;
          // Role cell: include cluster name on top (small) followed by bold role name. Remove separate cluster column.
          const tdRole = document.createElement('td');
          tdRole.className = 'col-role';
          // Show only the role name in bold; cluster names have been removed
          // from the display per user feedback. Previously the cluster name was
          // rendered as a small label above the role. Now the role cell
          // contains only the bold role name to simplify the layout.
          const roleName = r.roleArea || '-';
          tdRole.innerHTML = `<strong>${roleName}</strong>`;
          // Attach a tooltip for the role if a definition exists.  This
          // provides additional context when hovering over the role name.
          const defn = roleDefinitions[roleName];
          if (defn) {
            tdRole.title = defn;
          }
          tr.appendChild(tdRole);
          // Criticality cell
          const tdCrit = document.createElement('td');
          tdCrit.className = 'col-crit';
          tdCrit.dataset.rowId = r.id;
          tdCrit.dataset.field = 'criticality';
          tdCrit.setAttribute('tabindex', 0);
          const critVal = r.criticality;
          tdCrit.textContent = critVal != null ? (critVal.toFixed(1)) : '-';
          // Round criticality to nearest integer for CSS class
          const critRounded = critVal != null ? Math.round(critVal) : null;
          const critClass = critRounded ? `crit-${critRounded}` : 'crit-null';
          tdCrit.classList.add(critClass);
          tr.appendChild(tdCrit);
          // Capability cell
          const tdCap = document.createElement('td');
          tdCap.className = 'col-cap';
          tdCap.dataset.rowId = r.id;
          tdCap.dataset.field = 'capability';
          tdCap.setAttribute('tabindex', 0);
          const avg = r.capabilityAvg;
          tdCap.textContent = avg != null ? avg.toFixed(1) : '-';
          const capBucket = bucketCapability(avg);
          if (capBucket) {
            tdCap.classList.add(`cap-${capBucket}`);
            const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
            const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
            tdCap.style.backgroundColor = capBg[capBucket];
            tdCap.style.color = capFg[capBucket];
          }
          tr.appendChild(tdCap);
          // Retention risk cell
          const tdRet = document.createElement('td');
          tdRet.className = 'col-ret';
          tdRet.dataset.rowId = r.id;
          tdRet.dataset.field = 'retentionRisk';
          tdRet.setAttribute('tabindex', 0);
          const ret = r.retentionRisk || '-';
          tdRet.textContent = ret;
          const retClass = (ret && ret !== '-') ? `ret-${ret}` : 'ret-null';
          tdRet.classList.add(retClass);
          tr.appendChild(tdRet);
          // Overall risk cell
          const tdOverall = document.createElement('td');
          tdOverall.className = 'col-overall';
          const overall = r.overallRisk;
          tdOverall.textContent = overall || '-';
          if (overall) tdOverall.classList.add(`overall-${overall}`);
          tr.appendChild(tdOverall);
          // Comments cell
          const tdComments = document.createElement('td');
          tdComments.className = 'col-comments';
          tdComments.dataset.rowId = r.id;
          tdComments.dataset.field = 'comments';
          tdComments.setAttribute('tabindex', 0);
          // Build separate sections for capability and retention comments.  Each
          // section is wrapped in its own <div> to align on separate rows
          // within the cell.  This prevents the two comment types from
          // merging together when consolidating data and improves
          // readability.  We also preserve any additional comments as a
          // third section if provided.  Bulleted lists are created for
          // each set of comments.
          const capLines = [];
          if (r.capabilityComment) {
            r.capabilityComment.split(/\n/).forEach(l => {
              const trimmed = l.trim();
              if (trimmed) {
                // Push comment line without adding a dash; dashes are not
                // necessary and can complicate consolidation
                capLines.push(trimmed);
              }
            });
          }
          // Do not insert placeholder bullets for capability when there are no
          // notes.  Leaving the section empty avoids unwanted characters
          // being included in consolidated comments.
          // (capLines remains empty if there are no capability comments)
          const retLines = [];
          if (r.retentionComment) {
              r.retentionComment.split(/\n/).forEach(l => {
                const trimmed = l.trim();
                if (trimmed) {
                  retLines.push(trimmed);
                }
              });
          }
          const addLines = [];
          if (r.comments) {
              r.comments.split(/\n/).forEach(l => {
                const trimmed = l.trim();
                if (trimmed) {
                  addLines.push(trimmed);
                }
              });
          }
          // Build HTML for each section.  Using div wrappers ensures that
          // capability and retention comments render on distinct rows.  A
          // small margin is added between sections for subtle separation.
          let commentsHTML = '';
          commentsHTML += '<div><strong>Capability:</strong><br>' +
            (capLines.length ? capLines.join('<br>') : '') + '</div>';
          commentsHTML += '<div style="margin-top:4px;"><strong>Retention:</strong><br>' +
            retLines.join('<br>') + '</div>';
          if (addLines.length) {
            commentsHTML += '<div style="margin-top:4px;"><strong>Additional:</strong><br>' +
              addLines.join('<br>') + '</div>';
          }
          tdComments.innerHTML = commentsHTML;
          // Append comments cell to the row.  We do not bind a direct click
          // handler here; event delegation on the table body handles
          // editing.
          tr.appendChild(tdComments);
          // Preferred Method cell
          const tdPref = document.createElement('td');
          tdPref.className = 'col-pref';
          tdPref.dataset.rowId = r.id;
          tdPref.dataset.field = 'preferredMethod';
          tdPref.setAttribute('tabindex', 0);
          tdPref.textContent = r.preferredMethod || '-';
          tr.appendChild(tdPref);
          // Gap Method Comment cell
          const tdGap = document.createElement('td');
          tdGap.className = 'col-gap';
          tdGap.dataset.rowId = r.id;
          tdGap.dataset.field = 'gapMethodComment';
          tdGap.setAttribute('tabindex', 0);
          tdGap.textContent = r.gapMethodComment || '';
          tr.appendChild(tdGap);
          tbody.appendChild(tr);
        });
        // After building the table rows, apply all colors comprehensively
        // to ensure they never appear white or mismatched.
        reapplyAllColors();
      }

    /**
     * Iterate over all capability cells in the current table and apply the
     * appropriate RAG colour classes and inline styles based solely on the
     * displayed numeric value. This is used as a final pass after rendering
     * the table to guard against missed updates and ensure colours never
     * remain white or mismatched. The function parses the cell text, uses
     * bucketCapability to determine whether the value is low (1), medium (2)
     * or high (3), then assigns the cap-* class and inline colours.
     */
    function reapplyCapabilityColours() {
      const capCells = tbody.querySelectorAll('td.col-cap');
      capCells.forEach(cell => {
        const text = cell.textContent.trim();
        const num = parseFloat(text);
        if (!isNaN(num)) {
          const bucket = bucketCapability(num);
          if (bucket) {
            // Remove any existing capability classes
            cell.classList.remove('cap-1', 'cap-2', 'cap-3');
            cell.classList.add(`cap-${bucket}`);
            // Inline colours to override row striping
            const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
            const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
            cell.style.backgroundColor = capBg[bucket];
            cell.style.color = capFg[bucket];
          }
        }
      });
    }
    
    /**
     * Comprehensive function to reapply all color coding to all cell types.
     * This ensures proper coloring after consolidation or any data updates.
     * It handles criticality, capability, retention risk, and overall risk cells.
     */
    function reapplyAllColors() {
      // Reapply criticality colors
      const critCells = tbody.querySelectorAll('td.col-crit');
      critCells.forEach(cell => {
        const text = cell.textContent.trim();
        const num = parseFloat(text);
        
        // Remove all existing criticality classes
        cell.classList.remove('crit-1', 'crit-2', 'crit-3', 'crit-null');
        
        if (!isNaN(num)) {
          const rounded = Math.round(num);
          cell.classList.add(`crit-${rounded}`);
          // Apply inline styles to ensure colors show
          const critBg = {1: '#d7e7d3', 2: '#fff5d6', 3: '#f8d7da'};
          const critFg = {1: '#004400', 2: '#8a6d00', 3: '#842029'};
          if (critBg[rounded]) {
            cell.style.backgroundColor = critBg[rounded] + ' !important';
            cell.style.color = critFg[rounded] + ' !important';
          }
        } else {
          cell.classList.add('crit-null');
        }
      });
      
      // Reapply capability colors (use existing function)
      reapplyCapabilityColours();
      
      // Reapply retention risk colors
      const retCells = tbody.querySelectorAll('td.col-ret');
      retCells.forEach(cell => {
        const text = cell.textContent.trim();
        
        // Remove all existing retention classes
        cell.classList.remove('ret-L', 'ret-M', 'ret-H', 'ret-null');
        
        if (text === 'L' || text === 'M' || text === 'H') {
          cell.classList.add(`ret-${text}`);
          // Apply inline styles to ensure colors show
          const retBg = {L: '#d7e7d3', M: '#fff5d6', H: '#f8d7da'};
          const retFg = {L: '#004400', M: '#8a6d00', H: '#842029'};
          if (retBg[text]) {
            cell.style.backgroundColor = retBg[text] + ' !important';
            cell.style.color = retFg[text] + ' !important';
          }
        } else {
          cell.classList.add('ret-null');
        }
      });
      
      // Reapply overall risk colors
      const overallCells = tbody.querySelectorAll('td.col-overall');
      overallCells.forEach(cell => {
        const text = cell.textContent.trim();
        
        // Remove all existing overall risk classes
        cell.classList.remove('overall-Low', 'overall-Medium', 'overall-High', 'overall-Critical');
        
        if (text === 'Low' || text === 'Medium' || text === 'High' || text === 'Critical') {
          cell.classList.add(`overall-${text}`);
          // Apply inline styles to ensure colors show
          const overallBg = {
            Low: '#d7e7d3',
            Medium: '#fff5d6', 
            High: '#f8d7da',
            Critical: '#e5b7b9'
          };
          const overallFg = {
            Low: '#004400',
            Medium: '#8a6d00',
            High: '#842029',
            Critical: '#660000'
          };
          if (overallBg[text]) {
            cell.style.backgroundColor = overallBg[text] + ' !important';
            cell.style.color = overallFg[text] + ' !important';
            if (text === 'Critical') {
              // Add animation for critical
              cell.style.animation = 'pulse 2s infinite !important';
            }
          }
        }
      });
    }
      // Render initial table
      renderTable();
      // Editing interactions
      // Track the currently open popover (e.g. capability popover) and the
      // cell currently being edited inline (select or textarea). This allows
      // us to prevent reopening editors when a user is interacting with an
      // existing control.
      // Use var for currentPopover so it is hoisted and accessible before
      // initialization. Otherwise references in functions called prior to this
      // declaration (such as renderTable -> closePopover) will throw a
      // ReferenceError due to the temporal dead zone of let/const.
      var currentPopover = null;
      // Use var here so it is hoisted to the top of the IIFE. Without hoisting,
      // referencing editingCell before its declaration inside functions would
      // result in a ReferenceError during early calls to renderTable().
      var editingCell = null;
      // Holds the consolidated rows when processing multiple CSV files. This
      // is used to temporarily store averaged data and comments before
      // updating the main table. It is reset whenever new files are
      // processed.
      let consolidatedData = [];
      function closePopover() {
        if (currentPopover) {
          document.body.removeChild(currentPopover);
          currentPopover = null;
        }
      }
      document.addEventListener('click', (evt) => {
        const target = evt.target;
        // If a capability popover is open and the click occurred outside of it and not on another capability cell,
        // commit any outstanding edits and close the popover. We retrieve the associated row ID from the popover's
        // dataset so we can recompute derived fields and persist changes. After committing we reset editingCell.
        if (currentPopover && !currentPopover.contains(target) && !target.closest('.col-cap')) {
          // Commit changes if possible
          const rowId = currentPopover.dataset.rowId;
          if (rowId !== undefined) {
            const idNum = parseInt(rowId);
            if (!isNaN(idNum)) {
              updateRow(idNum);
            }
          }
          editingCell = null;
          closePopover();
        }
      });
      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && currentPopover) {
          closePopover();
        }
      });
      // Helper to update row and re-render row only
      function updateRow(id) {
        const row = rows[id];
        row.capabilityAvg = computeCapabilityAvg(row);
        row.capabilityBucket = bucketCapability(row.capabilityAvg);
        row.overallRisk = computeOverallRisk(row);
        // Persist data to storage for this site
        saveData();
        // Re-render entire table (simpler) for now
        renderTable();
        // Force reapply all colors after a short delay to ensure DOM is updated
        setTimeout(() => {
          reapplyAllColors();
        }, 50);
      }

      /**
       * Commit any in-progress inline edits by blurring the active editor. When
       * a select or textarea is open, calling blur() will trigger its
       * respective blur handler which calls updateRow() and saveData(). This
       * function should be called before switching sites or returning to
       * the start screen to ensure no data is lost.
       */
      function commitEditing() {
        if (editingCell) {
          const input = editingCell.querySelector('input, select, textarea');
          if (input) {
            input.blur();
          }
        }
      }
      // Event delegation for cell clicks
      tbody.addEventListener('click', function(evt) {
        /**
         * Normalize the click target to the containing TD element. Sometimes
         * users may click on text nodes or child elements; walk up the DOM
         * until we hit a TD or abort if not found.
         */
        let el = evt.target;
        while (el && el.tagName !== 'TD') {
          el = el.parentElement;
        }
        const cell = el;
        if (!cell) return;
        // If a select or textarea is already open for editing, avoid
        // reentering edit mode. Allow clicks inside the currently
        // editing cell (e.g. to open dropdown) to be handled by the
        // control itself but prevent creating another editor on blur.
        if (editingCell) {
          // If click is inside the active editing cell, do nothing here.
          if (editingCell.contains(evt.target)) {
            return;
          }
        }
        // If a popover (for capability editing) is open, do not open a new editor
        if (currentPopover) {
          return;
        }

        // Determine row id either from cell or fallback to its parent TR
        let rowId = parseInt(cell.dataset.rowId);
        if (isNaN(rowId)) {
          const trEl = cell.closest('tr');
          if (trEl && trEl.dataset && trEl.dataset.rowId) {
            rowId = parseInt(trEl.dataset.rowId);
          }
        }
        // Determine which editor to invoke based on CSS class rather than
        // relying solely on data-field attributes. This guards against cases
        // where dataset may be missing due to DOM quirks (e.g. merged cells).
        if (cell.classList.contains('col-comments')) {
          editComments(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-crit')) {
          editCriticality(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-ret')) {
          editRetention(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-pref')) {
          editPreferredMethod(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-gap')) {
          editGapComment(cell, rowId);
          return;
        }
        if (cell.classList.contains('col-cap')) {
          editCapabilityDimensions(cell, rowId);
          return;
        }
      });
      // Editing functions
      function editCriticality(cell, id) {
        // Prevent multiple editors: if this cell is already being edited, ignore
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        [1,2,3].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val.toFixed(1);
          if (row.criticality === val) opt.selected = true;
          select.appendChild(opt);
        });
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when the user selects a new value. This
        // commits the change without requiring the user to click away. After
        // updating, reset editingCell to allow new edits.
        select.addEventListener('change', () => {
          row.criticality = parseInt(select.value);
          updateRow(id);
          editingCell = null;
        });
        // Preserve a blur handler to clean up if the user clicks away without
        // changing the value. It won't save again because updateRow was
        // already invoked on change.
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        // Mark this cell as currently being edited
        editingCell = cell;
      }
      function editRetention(cell, id) {
        // Inline editor for retention risk: similar behaviour to criticality and preferred
        // Avoid opening multiple editors at once
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        ['-','L','M','H'].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          if ((row.retentionRisk || '-') === val) opt.selected = true;
          select.appendChild(opt);
        });
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when a new retention risk is chosen
        select.addEventListener('change', () => {
          const val = select.value;
          row.retentionRisk = (val === '-') ? '-' : val;
          updateRow(id);
          editingCell = null;
        });
        // Blur handler only commits if still editing (no change occurred)
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        editingCell = cell;
      }
      function editPreferredMethod(cell, id) {
        // Prevent multiple editors
        if (editingCell) return;
        const row = rows[id];
        const select = document.createElement('select');
        ['-','build','buy','borrow','bot','retain'].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          if ((row.preferredMethod || '-') === val) opt.selected = true;
          select.appendChild(opt);
        });
        // Remove any duplicate entries that may have been added inadvertently by the browser.
        {
          const seen = new Set();
          const toRemove = [];
          Array.from(select.options).forEach(opt => {
            if (seen.has(opt.value)) {
              toRemove.push(opt);
            } else {
              seen.add(opt.value);
            }
          });
          toRemove.forEach(opt => opt.remove());
        }
        select.style.width = '100%';
        cell.innerHTML = '';
        cell.appendChild(select);
        select.focus();
        // Immediately update and save when the user selects a preferred method
        select.addEventListener('change', () => {
          row.preferredMethod = select.value === '-' ? '-' : select.value;
          updateRow(id);
          editingCell = null;
        });
        // Blur handler ensures a commit if no change occurred before leaving
        select.addEventListener('blur', () => {
          if (editingCell) {
            updateRow(id);
            editingCell = null;
          }
        });
        editingCell = cell;
      }
      function editComments(cell, id) {
        // Inline editing of comments using two separate textareas: one for
        // capability comments and one for retention comments.  Changes are
        // automatically committed when the user clicks away from the
        // editing container.  This eliminates the need for explicit
        // Save/Cancel buttons and still allows the user to edit both
        // comment types within a single interaction.
        if (editingCell) return;
        const row = rows[id];
        // Close any existing popover when editing comments
        closePopover();
        // Build the editing UI
        cell.innerHTML = '';
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '4px';
        // Capability label and textarea
        const capLabel = document.createElement('label');
        capLabel.textContent = 'Capability:';
        const capTextarea = document.createElement('textarea');
        capTextarea.style.width = '100%';
        capTextarea.style.minHeight = '60px';
        capTextarea.value = row.capabilityComment || '';
        // Retention label and textarea
        const retLabel = document.createElement('label');
        retLabel.textContent = 'Retention:';
        const retTextarea = document.createElement('textarea');
        retTextarea.style.width = '100%';
        retTextarea.style.minHeight = '60px';
        retTextarea.value = row.retentionComment || '';
        // When focus leaves the editing container, automatically commit
        // any changes entered by the user.  This replaces explicit Save/Cancel
        // buttons.  We listen for focusout events and check if the new
        // focused element is outside of the editing container.  If it is,
        // we update the underlying data and re-render the row.
        container.addEventListener('focusout', (evt) => {
          // relatedTarget may be null if focus leaves the document
          const newTarget = evt.relatedTarget;
          if (!container.contains(newTarget)) {
            // Commit changes
            row.capabilityComment = capTextarea.value.trim();
            row.retentionComment = retTextarea.value.trim();
            updateRow(id);
            editingCell = null;
          }
        });
        // Assemble the UI
        container.appendChild(capLabel);
        container.appendChild(capTextarea);
        container.appendChild(retLabel);
        container.appendChild(retTextarea);
        cell.appendChild(container);
        editingCell = cell;
      }
      function editGapComment(cell, id) {
        // Inline editing of gap comment. Ensure only one editor is open at a time.
        if (editingCell) return;
        const row = rows[id];
        const textarea = document.createElement('textarea');
        textarea.style.width = '100%';
        textarea.style.minHeight = '60px';
        textarea.value = row.gapMethodComment || '';
        cell.innerHTML = '';
        cell.appendChild(textarea);
        textarea.focus();
        textarea.addEventListener('blur', () => {
          row.gapMethodComment = textarea.value.trim();
          updateRow(id);
          editingCell = null;
        });
        editingCell = cell;
      }
      function editCapabilityDimensions(cell, id) {
        // open a popover near cell with five dropdowns
        closePopover();
        const row = rows[id];
        const rect = cell.getBoundingClientRect();
        const pop = document.createElement('div');
        pop.className = 'popover';
        // Use fixed positioning so the popover is placed relative to the viewport
        pop.style.position = 'fixed';
        // Build controls
        const dims = [
          { key: 'capTech', label: 'Technical knowledge' },
          { key: 'capExperience', label: 'Experience' },
          { key: 'capCrisis', label: 'Crisis management' },
          { key: 'capLeadComm', label: 'Leadership & Communication' },
          { key: 'capSafety', label: 'Safety mindset' }
        ];
        // Mark this cell as being edited so commitEditing() can attempt to
        // finish any in-progress editing when switching pages. Although
        // capability editing uses a popover with separate selects, we still
        // assign editingCell to the capability cell so commitEditing() will
        // attempt to blur it when navigating away. This helps ensure that any
        // unsaved changes are committed before leaving the page.
        editingCell = cell;

        dims.forEach(dim => {
          const label = document.createElement('label');
          label.textContent = dim.label;
          const select = document.createElement('select');
          ['','1','2','3'].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v || '-';
            const current = row[dim.key];
            if (v === '' && (current === null || current === undefined)) opt.selected = true;
            if (v && parseInt(v) === current) opt.selected = true;
            select.appendChild(opt);
          });
          // Persist capability changes immediately. When a user selects a new
          // value we update the underlying row property, recompute derived
          // fields and save to localStorage via updateRow(). This ensures that
          // switching sites or returning to the start page will not discard
          // capability edits.
          select.addEventListener('change', () => {
            const val = select.value;
            // Update the underlying capability dimension on this row.  Do not
            // immediately close the popover or re-render the table; instead
            // compute the derived fields and persist the data silently.  The
            // table will refresh when the user clicks outside the popover,
            // which triggers the global click handler to commit changes.
            row[dim.key] = val ? parseInt(val) : null;
            // Recompute capability average, bucket and overall risk on the fly.
            row.capabilityAvg = computeCapabilityAvg(row);
            row.capabilityBucket = bucketCapability(row.capabilityAvg);
            row.overallRisk = computeOverallRisk(row);
            // Persist but do not re-render.
            saveData();
          });
          label.appendChild(select);
          pop.appendChild(label);
        });
        // Assign the row ID to the popover so we know which row to commit when closing
        document.body.appendChild(pop);
        pop.dataset.rowId = id;
        /*
         * After appending the popover to the body, measure its dimensions and
         * position it within the viewport. We compute a tentative top/left
         * relative to the clicked cell (below the cell by default) and then
         * adjust to ensure the entire popover remains visible. Without this,
         * the popover could extend beyond the viewport, making part of it
         * unreachable on smaller screens or when the table is scrolled toward
         * the bottom.
         */
        const popRect = pop.getBoundingClientRect();
        // Default placement: below the cell
        let top = rect.bottom;
        let left = rect.left;
        // If the popover would overflow the bottom of the viewport, place it above
        if (top + popRect.height > window.innerHeight) {
          top = rect.top - popRect.height;
        }
        // Clamp vertical position within viewport
        if (top < 0) top = 0;
        if (top + popRect.height > window.innerHeight) {
          top = window.innerHeight - popRect.height;
        }
        // Clamp horizontal position within viewport
        if (left + popRect.width > window.innerWidth) {
          left = window.innerWidth - popRect.width;
        }
        if (left < 0) left = 0;
        pop.style.top = `${top}px`;
        pop.style.left = `${left}px`;
        // Record this popover so it can be closed later
        currentPopover = pop;
        pop.tabIndex = -1;
        pop.focus();
      }
      // Summary view generation
      function generateSummary() {
        const container = document.getElementById('summaryView');
        container.innerHTML = '';
        /**
         * This function builds an interactive summary view containing:
         * 1. A critical spotlight table for roles with High or Critical overall risk.
         * 2. A scatter chart of Capability vs. Criticality.
         * 3. A scatter chart of Retention Risk vs. Criticality.
         * 4. A bar chart showing the distribution of overall risk categories.
         * 5. A crosstable linking overall risk to preferred method counts.
         * 6. A word summary listing role areas grouped by overall risk.
         */
        // Helper to build a card
        function createCard(titleText) {
          const card = document.createElement('div');
          card.className = 'summary-card';
          const title = document.createElement('h2');
          title.textContent = titleText;
          card.appendChild(title);
          return card;
        }
        // Critical spotlight (full listing). Show all roles (13) sorted by overall risk
        // severity: Critical first, then High, Medium, Low, and unset last. Remove
        // the department and cluster columns to focus on the role and risk values.
        {
          // Create a sorted copy of rows
          const sorted = rows.slice().sort((a, b) => {
            const order = {Critical:0, High:1, Medium:2, Low:3, '-':4, undefined:4};
            const aKey = a.overallRisk || '-';
            const bKey = b.overallRisk || '-';
            return order[aKey] - order[bKey];
          });
          const card = createCard('As-Is Summary');
          // Mark this card as the AsIs summary so the CSS sizing rules apply
          card.classList.add('as-is');
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          // Only include columns for Role Area and risk-related fields
          // Reorder columns so Criticality appears before Capability (avg) per user request
          thead.innerHTML = '<tr><th>Role Area</th><th>Criticality</th><th>Capability (avg)</th><th>Retention Risk</th><th>Overall Risk</th></tr>';
          table.appendChild(thead);
          const tbodyEl = document.createElement('tbody');
          sorted.forEach(r => {
            const tr = document.createElement('tr');
            // Role area
            const tdRole = document.createElement('td');
            tdRole.textContent = r.roleArea || '-';
            tr.appendChild(tdRole);
            // Criticality (before capability)
            const tdCrit = document.createElement('td');
            if (r.criticality != null) {
              tdCrit.textContent = r.criticality.toFixed(1);
              tdCrit.classList.add(`crit-${Math.round(r.criticality)}`);
            } else {
              tdCrit.textContent = '-';
              tdCrit.classList.add('crit-null');
            }
            tr.appendChild(tdCrit);
            // Capability average with RAG styling
            const tdCap = document.createElement('td');
            tdCap.textContent = r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '-';
            const capBucket = bucketCapability(r.capabilityAvg);
            if (capBucket) {
              tdCap.classList.add(`cap-${capBucket}`);
              const capBg = {1: '#f8d7da', 2: '#fff5d6', 3: '#d7e7d3'};
              const capFg = {1: '#842029', 2: '#8a6d00', 3: '#004400'};
              tdCap.style.backgroundColor = capBg[capBucket];
              tdCap.style.color = capFg[capBucket];
            }
            tr.appendChild(tdCap);
            // Retention risk
            const tdRet = document.createElement('td');
            const retVal = r.retentionRisk || '-';
            tdRet.textContent = retVal;
            const retClass = (retVal && retVal !== '-') ? `ret-${retVal}` : 'ret-null';
            tdRet.classList.add(retClass);
            tr.appendChild(tdRet);
            // Overall risk
            const tdOverall = document.createElement('td');
            const risk = r.overallRisk || '-';
            tdOverall.textContent = risk;
            if (risk && risk !== '-') {
              tdOverall.classList.add(`overall-${risk}`);
            }
            tr.appendChild(tdOverall);
            tbodyEl.appendChild(tr);
          });
          table.appendChild(tbodyEl);
          card.appendChild(table);
          container.appendChild(card);

        // Capability AsIs table moved here for better grouping. This
        // simplified heatmap lists only the capability dimensions and
        // overall capability rating. It appears immediately after the
        // AsIs summary.
        {
          const capCard = createCard('Capability As-Is');
          capCard.classList.add('cap-heatmap');
          const capTable = document.createElement('table');
          const capThead = document.createElement('thead');
          capThead.innerHTML = '<tr>' +
            '<th>Role Area</th>' +
            '<th>Technical knowledge</th>' +
            '<th>Experience</th>' +
            '<th>Crisis management</th>' +
            '<th>Leadership &amp; Communication</th>' +
            '<th>Safety mindset</th>' +
            '<th>Overall capability rating</th>' +
            '</tr>';
          capTable.appendChild(capThead);
          const capTbody = document.createElement('tbody');
          rows.forEach(r => {
            const tr2 = document.createElement('tr');
            const tdRole2 = document.createElement('td');
            tdRole2.textContent = r.roleArea || '-';
            tr2.appendChild(tdRole2);
            function appendCapCell2(value) {
              const td = document.createElement('td');
              if (value != null && value !== '') {
                const num = Number(value);
                if (!isNaN(num)) {
                  td.textContent = num.toFixed(1);
                  const bucket = bucketCapability(num);
                  if (bucket) {
                    td.classList.add(`cap-${bucket}`);
                  }
                } else {
                  td.textContent = value;
                }
              } else {
                td.textContent = '-';
              }
              return td;
            }
            tr2.appendChild(appendCapCell2(r.capTech));
            tr2.appendChild(appendCapCell2(r.capExperience));
            tr2.appendChild(appendCapCell2(r.capCrisis));
            tr2.appendChild(appendCapCell2(r.capLeadComm));
            tr2.appendChild(appendCapCell2(r.capSafety));
            // Overall capability rating
            const tdCapAvg2 = document.createElement('td');
            if (r.capabilityAvg != null) {
              tdCapAvg2.textContent = r.capabilityAvg.toFixed(1);
              const bucket = bucketCapability(r.capabilityAvg);
              if (bucket) tdCapAvg2.classList.add(`cap-${bucket}`);
            } else {
              tdCapAvg2.textContent = '-';
            }
            tr2.appendChild(tdCapAvg2);
            capTbody.appendChild(tr2);
          });
          capTable.appendChild(capTbody);
          capCard.appendChild(capTable);
          container.appendChild(capCard);
        }
        }
        // Prepare data arrays for tables and quadrants
        const riskCounts = {Low:0, Medium:0, High:0, Critical:0};
        const riskMethodCounts = {};
        // Quadrant containers
        const capCritQuads = {
          HH: [], // High capability, High criticality
          HL: [], // High capability, Low criticality
          LH: [], // Low capability, High criticality
          LL: []  // Low capability, Low criticality
        };
        const retCritQuads = {
          HH: [], // High retention risk, High criticality
          HL: [], // High retention risk, Low criticality
          LH: [], // Low retention risk, High criticality
          LL: []  // Low retention risk, Low criticality
        };
        rows.forEach(r => {
          // Overall risk distribution
          if (r.overallRisk) {
            riskCounts[r.overallRisk] = (riskCounts[r.overallRisk] || 0) + 1;
          }
          // Risk vs preferred method cross table
          const risk = r.overallRisk || '-';
          const method = r.preferredMethod || '-';
          if (!riskMethodCounts[risk]) riskMethodCounts[risk] = {};
          riskMethodCounts[risk][method] = (riskMethodCounts[risk][method] || 0) + 1;
          // Compute high/low for capability and criticality
          const capHigh = (r.capabilityAvg != null && r.capabilityAvg >= 2);
          const critHigh = (r.criticality != null && r.criticality >= 2);
          const capCritKey = (capHigh ? 'H' : 'L') + (critHigh ? 'H' : 'L');
          capCritQuads[capCritKey].push(r.roleArea);
          // Compute high/low for retention risk (H and M considered high)
          const retNum = mapRetentionNum(r.retentionRisk);
          const retHigh = (retNum != null && retNum >= 2);
          const retCritKey = (retHigh ? 'H' : 'L') + (critHigh ? 'H' : 'L');
          retCritQuads[retCritKey].push(r.roleArea);
        });
        // Quadrant: Capability vs Criticality
        {
          const card = createCard('Capability vs Criticality (Quadrants)');
          const quadWrap = document.createElement('div');
          quadWrap.style.display = 'flex';
          quadWrap.style.flexWrap = 'wrap';
          const quadDefs = [
            // High criticality quadrants first: high capability/high crit and low capability/high crit
            { key:'HH', title:'High Capability & High Criticality' },
            { key:'LH', title:'Low Capability & High Criticality' },
            // Then low criticality quadrants: high capability/low crit and low capability/low crit
            { key:'HL', title:'High Capability & Low Criticality' },
            { key:'LL', title:'Low Capability & Low Criticality' }
          ];
          quadDefs.forEach(def => {
            const box = document.createElement('div');
            box.style.flex = '1 0 45%';
            box.style.border = '1px solid #ddd';
            box.style.margin = '4px';
            box.style.padding = '4px';
            // Apply RAG colour coding to capability vs criticality quadrants.
            // High capability & high/low criticality are green; low capability & high criticality is red; low capability & low criticality is amber.
            const capCritColors = { HH: '#d7e7d3', HL: '#d7e7d3', LH: '#f8d7da', LL: '#fff5d6' };
            const capCritText = { HH: '#004400', HL: '#004400', LH: '#842029', LL: '#8a6d00' };
            const bgCol = capCritColors[def.key] || '#fff';
            const fgCol = capCritText[def.key] || '#333';
            box.style.backgroundColor = bgCol;
            box.style.color = fgCol;
            const heading = document.createElement('strong');
            heading.textContent = def.title;
            box.appendChild(heading);
            const roles = capCritQuads[def.key] || [];
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
              });
              box.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              box.appendChild(span);
            }
            quadWrap.appendChild(box);
          });
          card.appendChild(quadWrap);
          container.appendChild(card);
        }
        // Quadrant: Retention Risk vs Criticality
        {
          const card = createCard('Retention Risk vs Criticality (Quadrants)');
          const quadWrap = document.createElement('div');
          quadWrap.style.display = 'flex';
          quadWrap.style.flexWrap = 'wrap';
          const quadDefs = [
            // High criticality quadrants first (high retention/high criticality and low retention/high criticality)
            { key:'HH', title:'High Retention Risk & High Criticality' },
            { key:'LH', title:'Low Retention Risk & High Criticality' },
            // Then low criticality quadrants
            { key:'HL', title:'High Retention Risk & Low Criticality' },
            { key:'LL', title:'Low Retention Risk & Low Criticality' }
          ];
          quadDefs.forEach(def => {
            const box = document.createElement('div');
            // The quadrant boxes share styling with the capability vs criticality
            // quadrants; each box is roughly half width, with padding and a border.
            box.style.flex = '1 0 45%';
            box.style.border = '1px solid #ddd';
            box.style.margin = '4px';
            box.style.padding = '4px';
            /*
             * Apply RAG colour coding based on the combination of retention risk
             * (high/low) and criticality (high/low). High retention risk and
             * high criticality represent the highest concern and are coloured
             * red. High retention with low criticality is amber, while low
             * retention with high criticality is amber as well. Low retention
             * combined with low criticality is green. These colours align
             * with the main RAG scheme used throughout the assessment.
             */
            const retCritColors = { HH: '#f8d7da', HL: '#fff5d6', LH: '#fff5d6', LL: '#d7e7d3' };
            const retCritText = { HH: '#842029', HL: '#8a6d00', LH: '#8a6d00', LL: '#004400' };
            const bgCol = retCritColors[def.key] || '#fff';
            const fgCol = retCritText[def.key] || '#333';
            box.style.backgroundColor = bgCol;
            box.style.color = fgCol;
            const heading = document.createElement('strong');
            heading.textContent = def.title;
            box.appendChild(heading);
            const roles = retCritQuads[def.key] || [];
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                ul.appendChild(li);
              });
              box.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              box.appendChild(span);
            }
            quadWrap.appendChild(box);
          });
          card.appendChild(quadWrap);
          container.appendChild(card);
        }
        // Bar chart: Overall risk distribution
        {
          const card = createCard('Overall Risk Distribution');
          const canvas = document.createElement('canvas');
          canvas.width = 400;
          canvas.height = 260;
          card.appendChild(canvas);
          drawBar(canvas, riskCounts);
          container.appendChild(card);
        }
        // Risk vs Preferred Method cross table removed as per requirements.

        // Roles by risk level summary
        {
          const card = createCard('Roles by Risk Level');
          const listContainer = document.createElement('div');
          ['Critical','High','Medium','Low','-'].forEach(level => {
            const roles = rows.filter(r => (r.overallRisk || '-') === level);
            const section = document.createElement('div');
            const heading = document.createElement('strong');
            heading.textContent = (level === '-' ? 'Unset' : level) + ':';
            section.appendChild(heading);
            if (roles.length) {
              const ul = document.createElement('ul');
              roles.forEach(r => {
                const li = document.createElement('li');
                // Determine preferred method text
                const methodText = r.preferredMethod && r.preferredMethod !== '-' ? r.preferredMethod : 'Unset';
                // Build display string: role name followed by arrow and preferred method
                li.textContent = `${r.roleArea} -> ${methodText}`;
                ul.appendChild(li);
              });
              section.appendChild(ul);
            } else {
              const span = document.createElement('span');
              span.textContent = ' none';
              section.appendChild(span);
            }
            listContainer.appendChild(section);
          });
          card.appendChild(listContainer);
          container.appendChild(card);
        }
      }

      /**
       * Draw a simple scatter chart on the provided canvas.
       * data: array of {x, y, label}. options: {xLabel, yLabel, xMin, xMax, yMin, yMax}
       */
      function drawScatter(canvas, data, options) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        // Margins
        const marginLeft = 40;
        const marginBottom = 30;
        const marginTop = 20;
        const marginRight = 20;
        ctx.clearRect(0,0,w,h);
        ctx.font = '10px sans-serif';
        ctx.fillStyle = '#333';
        ctx.strokeStyle = '#333';
        // Draw axes
        ctx.beginPath();
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(w - marginRight, h - marginBottom);
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(marginLeft, marginTop);
        ctx.stroke();
        // Axis labels
        ctx.save();
        ctx.textAlign = 'center';
        ctx.fillText(options.xLabel, (w - marginRight + marginLeft)/2, h - 5);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(options.yLabel, - (marginTop + (h - marginBottom))/2, 12);
        ctx.restore();
        // Ticks and labels for x and y (assume integer values 1-3)
        const xMin = options.xMin;
        const xMax = options.xMax;
        const yMin = options.yMin;
        const yMax = options.yMax;
        for (let i = xMin; i <= xMax; i++) {
          const xPos = marginLeft + (i - xMin) * (w - marginLeft - marginRight) / (xMax - xMin);
          ctx.beginPath();
          ctx.moveTo(xPos, h - marginBottom);
          ctx.lineTo(xPos, h - marginBottom + 4);
          ctx.stroke();
          ctx.textAlign = 'center';
          ctx.fillText(i.toString(), xPos, h - marginBottom + 14);
        }
        for (let j = yMin; j <= yMax; j++) {
          const yPos = h - marginBottom - (j - yMin) * (h - marginTop - marginBottom) / (yMax - yMin);
          ctx.beginPath();
          ctx.moveTo(marginLeft - 4, yPos);
          ctx.lineTo(marginLeft, yPos);
          ctx.stroke();
          ctx.textAlign = 'right';
          ctx.fillText(j.toString(), marginLeft - 6, yPos + 3);
        }
        // Plot points
        data.forEach(pt => {
          const xPos = marginLeft + (pt.x - xMin) * (w - marginLeft - marginRight) / (xMax - xMin);
          const yPos = h - marginBottom - (pt.y - yMin) * (h - marginTop - marginBottom) / (yMax - yMin);
          // draw circle
          ctx.beginPath();
          ctx.arc(xPos, yPos, 3, 0, Math.PI * 2);
          ctx.fillStyle = '#1a73e8';
          ctx.fill();
          // label near point
          ctx.fillStyle = '#333';
          ctx.textAlign = 'left';
          ctx.fillText(pt.label, xPos + 5, yPos - 2);
        });
      }
      /**
       * Draw a bar chart for overall risk distribution. riskCounts is an object with keys
       * Low, Medium, High, Critical. Bars are coloured accordingly.
       */
      function drawBar(canvas, riskCounts) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0,0,w,h);
        // Chart area
        const marginLeft = 40;
        const marginBottom = 40;
        const marginTop = 20;
        const marginRight = 20;
        ctx.font = '10px sans-serif';
        // Determine max
        const categories = ['Low','Medium','High','Critical'];
        const colours = {
          Low: '#d7e7d3',
          Medium: '#fff5d6',
          High: '#f8d7da',
          Critical: '#e5b7b9'
        };
        const maxVal = Math.max(...categories.map(c => riskCounts[c] || 0));
        // Draw axes
        ctx.beginPath();
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(w - marginRight, h - marginBottom);
        ctx.moveTo(marginLeft, h - marginBottom);
        ctx.lineTo(marginLeft, marginTop);
        ctx.strokeStyle = '#333';
        ctx.stroke();
        // Y ticks: show integer ticks up to max
        const yTickCount = Math.min(maxVal, 5);
        const yStep = maxVal ? Math.ceil(maxVal / yTickCount) : 1;
        for (let i = 0; i <= yTickCount; i++) {
          const val = i * yStep;
          const yPos = h - marginBottom - (val / (yTickCount * yStep)) * (h - marginTop - marginBottom);
          ctx.beginPath();
          ctx.moveTo(marginLeft - 3, yPos);
          ctx.lineTo(marginLeft, yPos);
          ctx.stroke();
          ctx.textAlign = 'right';
          ctx.fillStyle = '#333';
          ctx.fillText(val.toString(), marginLeft - 6, yPos + 3);
        }
        // Bars
        const barWidth = (w - marginLeft - marginRight) / categories.length * 0.6;
        categories.forEach((cat, idx) => {
          const val = riskCounts[cat] || 0;
          const barHeight = maxVal ? (val / (yTickCount * yStep)) * (h - marginTop - marginBottom) * (yTickCount / (yTickCount)) : 1;
          const xPos = marginLeft + (idx + 0.2) * ((w - marginLeft - marginRight) / categories.length);
          const yPos = h - marginBottom - barHeight;
          ctx.fillStyle = colours[cat];
          ctx.fillRect(xPos, yPos, barWidth, barHeight);
          ctx.fillStyle = '#333';
          ctx.textAlign = 'center';
          ctx.fillText(cat, xPos + barWidth/2, h - marginBottom + 12);
          ctx.fillText(val.toString(), xPos + barWidth/2, yPos - 4);
        });
      }
      // Toggle summary button
      const btnToggle = document.getElementById('toggleSummary');
      btnToggle.addEventListener('click', () => {
        const summary = document.getElementById('summaryView');
        const dataView = document.getElementById('dataView');
        // Toggle the visibility of the summary and data views. Store the
        // visibility state so it can be restored when switching plants.
        if (summary.classList.contains('hidden')) {
          // Show summary
          generateSummary();
          summary.classList.remove('hidden');
          dataView.classList.add('hidden');
          btnToggle.textContent = 'Show Full Data';
          summaryVisible = true;
        } else {
          // Show full data
          summary.classList.add('hidden');
          dataView.classList.remove('hidden');
          btnToggle.textContent = 'Show Summary';
          summaryVisible = false;
        }
      });
      // Download CSV
      function downloadCSV() {
        const mill = document.getElementById('inputMill').value || '';
        // Removed username field; adjust CSV header accordingly
        // Export detailed capability dimensions so that consolidation can
        // correctly average each sub capability.  Including individual
        // capability scores (technical knowledge, experience, crisis
        // management, leadership/communication, safety) ensures that
        // downstream merging reflects the full detail of each assessment.
        const header = [
          'Department','Cluster','Role Area','Criticality',
          'Technical Knowledge','Experience','Crisis Management','Leadership/Communication','Safety',
          'Capability (avg)','Retention Risk','Overall Risk',
          'Capability Comment','Retention Comment','Comments',
          'Preferred Method','Gap Method Comment','Mill'
        ];
        // Before exporting values to CSV we need to sanitise any fields that
        // may already include quotes from a prior import.  Some CSV tools
        // automatically wrap fields containing commas or quotes in a pair
        // of double quotes and escape internal quotes by doubling them.
        // When our parser reads such values it preserves the quotes, so
        // comments like "Very capable..." may actually be stored as
        // '"Very capable..."'.  If we call escapeCsv on such a string
        // without first removing the outer quotes, we end up adding an
        // additional layer of quoting which can cause the entire row to
        // start with an extra double quote.  The following helper will
        // strip a single pair of surrounding quotes and unescape doubled
        // quotes if present.  It intentionally does not strip nested
        // quotes in the middle of the string so legitimate quoted phrases
        // (e.g. in free-form comments) are preserved.
        function sanitiseValue(val) {
          if (val === null || val === undefined) return '';
          let str = String(val).trim();
          // If the string is wrapped in a single pair of quotes, remove them
          // and unescape any doubled quotes inside.  Only do this if both
          // the first and last characters are quotes and the string
          // contains at least one additional quote or comma inside, which
          // indicates that the outer quotes were added for CSV encoding.
          if (str.length > 1 && str.startsWith('"') && str.endsWith('"')) {
            // Remove the outer quotes
            str = str.slice(1, -1);
            // Unescape doubled quotes
            str = str.replace(/""/g, '"');
          }
          return str;
        }
        // Helper to escape a value for CSV.  If a field contains a comma,
        // newline or double quote, wrap it in quotes and escape existing
        // quotes by doubling them.  Null or undefined values become an
        // empty string.  This ensures that role areas containing commas
        // (e.g. "Production / Area Manager  Paper Machine, Finishing & Converting")
        // are safely exported without shifting columns.  The pipe (|)
        // separators remain as-is; they will be converted back to newlines
        // when processing uploaded CSVs.  Before escaping we sanitise the
        // value to strip any prior CSV quoting left over from imported data.
        function escapeCsv(val) {
          if (val === null || val === undefined) return '';
          // First sanitise the value to remove any surrounding quotes that
          // may already exist due to previous CSV imports.
          let str = sanitiseValue(val);
          // Replace any CR/LF with pipe separators for multiline fields.
          // These replacements are handled for comment fields separately
          // before this helper is invoked.
          if (str.includes('\n') || str.includes('\r')) {
            str = str.replace(/\r?\n/g, ' | ');
          }
          // If the value contains a comma or a quote, wrap it in quotes and
          // escape internal quotes by doubling them.  This protects
          // multi-word fields and ensures the CSV columns remain aligned.
          if (str.includes(',') || str.includes('"') ) {
            str = '"' + str.replace(/"/g, '""') + '"';
          }
          return str;
        }
        const lines = [];
        lines.push(header.join(','));
        rows.forEach(r => {
          const crit = r.criticality != null ? r.criticality : '';
          const capTech = r.capTech != null ? r.capTech : '';
          const capExp  = r.capExperience != null ? r.capExperience : '';
          const capCri  = r.capCrisis != null ? r.capCrisis : '';
          const capLead = r.capLeadComm != null ? r.capLeadComm : '';
          const capSafe = r.capSafety != null ? r.capSafety : '';
          const capAvg = r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '';
          const ret = r.retentionRisk || '';
          const overall = r.overallRisk || '';
          // Pre-sanitise comment fields: replace newline with pipe separators.
          const capCom = (r.capabilityComment || '').replace(/\r?\n/g, ' | ');
          const retCom = (r.retentionComment || '').replace(/\r?\n/g, ' | ');
          // Replace both LF and CRLF with pipe separators in the combined comments.
          // Using \r?\n ensures both Windows (\r\n) and Unix (\n) newlines are
          // converted consistently.  Without handling carriage returns, stray
          // \r characters can lead to malformed CSV rows when opened in other tools.
          const commentsCombined = displayComments(r).replace(/\r?\n/g, ' | ');
          const pref = r.preferredMethod || '';
          const gap = (r.gapMethodComment || '').replace(/\r?\n/g, ' | ');
          const values = [
            escapeCsv(r.department || ''),
            escapeCsv(r.cluster || ''),
            escapeCsv(r.roleArea || ''),
            escapeCsv(crit),
            escapeCsv(capTech),
            escapeCsv(capExp),
            escapeCsv(capCri),
            escapeCsv(capLead),
            escapeCsv(capSafe),
            escapeCsv(capAvg),
            escapeCsv(ret),
            escapeCsv(overall),
            escapeCsv(capCom),
            escapeCsv(retCom),
            escapeCsv(commentsCombined || ''),
            escapeCsv(pref),
            escapeCsv(gap || ''),
            escapeCsv(mill)
          ];
          lines.push(values.join(','));
        });
        const csvContent = '\uFEFF' + lines.join('\n');
        const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
        const date = new Date();
        const pad = n => n.toString().padStart(2,'0');
        // Update output filename to reflect paper mill
        // Use a more generic filename for the unified plant assessment
        const filename = `plant-skills_${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}_${pad(date.getHours())}${pad(date.getMinutes())}.csv`;
        if (navigator.msSaveBlob) { // IE 10+
          navigator.msSaveBlob(blob, filename);
        } else {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      // Save the current state of the application as a downloadable HTML file.
      // This function encodes the current data for all available sites
      // into base64 strings, injects them into copies of the default data
      // scripts, updates the storage key prefixes to a unique timestamped
      // version to avoid conflicts with other pages, and triggers a file
      // download. The resulting file contains all edits made up to the
      // moment of saving and will restore them when opened.
      function saveCurrentVersion() {
        try {
          // Clone defaults and apply the current site's rows into its array
          const allDefaults = {};
          siteNames.forEach(name => {
            allDefaults[name] = defaultData[name].map(r => ({...r}));
          });
          if (currentSite && allDefaults[currentSite]) {
            for (let i = 0; i < rows.length; i++) {
              allDefaults[currentSite][i] = {...rows[i]};
            }
          }
          // Base64 encode once for all sites. Use encodeURIComponent to properly handle Unicode.
          // Include the lock state in the exported data.  Persist structureLocked under a 'lock' key.
          const exportObj = Object.assign({}, allDefaults);
          exportObj.lock = { structureLocked: structureLocked };
          // Persist edited role definitions in the export so tooltips are preserved
          exportObj.definitions = roleDefinitions;
          const jsonStr = JSON.stringify(exportObj);
          const allB64 = btoa(unescape(encodeURIComponent(jsonStr)));
          // Capture the current HTML
          let html = document.documentElement.outerHTML;
          // Inject or replace a <script id="site-defaults"> block with the base64 payload.
          if (/<script[^>]+id="site-defaults"[^>]*>/.test(html)) {
            html = html.replace(/(<script[^>]+id="site-defaults"[^>]*>)([\s\S]*?)(<\/script>)/,
                                `$1\n  ${allB64}\n$3`);
          } else {
            // If no site-defaults script exists, insert one just before </body>
            html = html.replace(/<\/body>/,
              `<script id="site-defaults" type="application/json">\n  ${allB64}\n<\/script>\n</body>`);
          }
          // Generate a unique timestamp and update storage key prefixes
          const now = new Date();
          const timestamp = now.toISOString().replace(/[:T.-]/g, '').slice(0, 14);
          const storagePrefix = STORAGE_KEY_PREFIX + timestamp + '_';
          const escapedPrefix = STORAGE_KEY_PREFIX.replace(/[.*+?^${}()|[\]\\]/g, '\$&');
          html = html.replace(new RegExp(escapedPrefix, 'g'), storagePrefix);
          // Construct file name
          const fileName = `paper_mill_skills_${currentSite}_${timestamp}.html`;
          // Create blob and initiate download
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          alert('Error saving version: ' + err.message);
        }
      }
      const ZIP_JS_SOURCES = [
        'zip-full.min.js',
        'https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.32/dist/zip-full.min.js',
        'https://unpkg.com/@zip.js/zip.js@2.7.32/dist/zip-full.min.js'
      ];

      function loadZipJsFromUrl(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error('Failed to load ' + url));
          document.head.appendChild(script);
        });
      }

      async function ensureZipJsLoaded() {
        if (typeof zip !== 'undefined' && zip.ZipWriter && zip.BlobWriter) {
          if (typeof zip.configure === 'function') {
            zip.configure({ useWebWorkers: false });
          }
          return;
        }
        if (window.__zipLoadingPromise) {
          await window.__zipLoadingPromise;
          return;
        }
        window.__zipLoadingPromise = (async () => {
          let lastError = null;
          for (const url of ZIP_JS_SOURCES) {
            try {
              await loadZipJsFromUrl(url);
              if (typeof zip !== 'undefined' && zip.ZipWriter && zip.BlobWriter) {
                if (typeof zip.configure === 'function') {
                  zip.configure({ useWebWorkers: false });
                }
                return;
              }
            } catch (err) {
              lastError = err;
            }
          }
          throw lastError || new Error('zip.js library failed to load from configured sources.');
        })();
        try {
          await window.__zipLoadingPromise;
        } catch (err) {
          window.__zipLoadingPromise = null;
          throw err;
        }
      }

      /*
       * Consolidation view support
       *
       * The following functions enable uploading multiple CSV responses,
       * averaging their numeric scores, concatenating comments, and
       * optionally updating the main assessment data with the results. A
       * separate view (consolidationView) is defined in the HTML to host
       * the upload controls and the consolidated table. The navigation bar
       * remains visible when scrolling to mirror the behaviour of the main
       * worksheet.
       */

      // Show the consolidation view and hide the start and site views
      window.showConsolidation = function() {
        // If editing, commit any changes first
        if (typeof commitEditing === 'function') {
          commitEditing();
        }
        const startDiv = document.getElementById('startView');
        const siteDiv = document.getElementById('siteContent');
        const consDiv = document.getElementById('consolidationView');
        if (startDiv) startDiv.style.display = 'none';
        if (siteDiv) siteDiv.style.display = 'none';
        if (consDiv) consDiv.style.display = '';
      };

      // Start the assessment by capturing the user's name and plant name.
      // The plant name entered on the start page is used to populate the mill
      // field on the worksheet. After setting the name and plant, the
      // unified "Plant" site is loaded. This function is called by the
      // Start button on the welcome page.
      window.startAssessment = function() {
        // Capture entered values
        const userNameInput = document.getElementById('startUserName');
        const plantNameInput = document.getElementById('startPlantName');
        const userName = userNameInput ? userNameInput.value.trim() : '';
        const plantName = plantNameInput ? plantNameInput.value.trim() : '';
        // Require both the user's name and the plant name.  If either field
        // is empty, alert the user and do not proceed.  This prevents the
        // assessment from loading without the mandatory context requested.
        if (!userName || !plantName) {
          alert('Please enter your name and plant name before starting the assessment.');
          return;
        }
        // Load the single site named "Plant"; this will hide the start view and show the table.
        loadSite('Plant');
        // After the site loads, update the mill field.  Updating after the call
        // ensures that any default population performed by loadSite is
        // overwritten by the user-provided name.
        const millInputEl = document.getElementById('inputMill');
        if (millInputEl) {
          millInputEl.value = plantName;
        }
      };

      // Trigger the hidden file input when the Upload button is clicked
      const uploadBtn = document.getElementById('uploadBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
          const inp = document.getElementById('uploadInput');
          if (inp) inp.click();
        });
      }
      // Listen for file selections on the hidden input
      let selectedFiles = [];
      const uploadInputEl = document.getElementById('uploadInput');
      if (uploadInputEl) {
        uploadInputEl.addEventListener('change', function(e) {
          const files = Array.from(e.target.files || []);
          if (!selectedFiles) selectedFiles = [];
          // Append all selected files to the list without deduplication.  Different
          // respondents may produce files with identical names or timestamps;
          // treating them as separate inputs ensures that all responses are
          // included.  After processing, the file input value is reset so that
          // the same file can be selected again if needed.
          files.forEach(file => {
            selectedFiles.push(file);
          });
          // Clear previous consolidated output when new files are selected
          const out = document.getElementById('consolidatedOutput');
          if (out) out.innerHTML = '';
          // Reset the file input value so that selecting the same file again
          // will trigger a change event.
          e.target.value = '';
        });
      }

      // Helper: split a CSV line on commas, respecting quoted fields
      function splitCsvLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          const nextCh = i + 1 < line.length ? line[i + 1] : '';
          
          if (ch === '"') {
            if (inQuotes && nextCh === '"') {
              // Escaped quote within quoted field
              current += '"';
              i++; // Skip next quote
            } else {
              // Toggle quote mode
              inQuotes = !inQuotes;
            }
          } else if (ch === ',' && !inQuotes) {
            result.push(current);
            current = '';
          } else {
            current += ch;
          }
        }
        result.push(current);
        return result;
      }

      // Parse CSV content into an array of objects keyed by header names
      function parseCsv(content) {
        // Don't split by newlines first - parse the whole content as CSV
        const rows = [];
        let currentRow = '';
        let inQuotes = false;
        
        // Parse character by character to handle quoted fields with newlines
        for (let i = 0; i < content.length; i++) {
          const ch = content[i];
          const nextCh = i + 1 < content.length ? content[i + 1] : '';
          
          if (ch === '"') {
            if (inQuotes && nextCh === '"') {
              // Escaped quote
              currentRow += '""';
              i++;
            } else {
              // Toggle quote mode
              inQuotes = !inQuotes;
              currentRow += ch;
            }
          } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
            // End of row (only if not in quotes)
            if (ch === '\r' && nextCh === '\n') {
              i++; // Skip LF in CRLF
            }
            if (currentRow.trim()) {
              rows.push(currentRow);
            }
            currentRow = '';
          } else {
            currentRow += ch;
          }
        }
        
        // Don't forget last row
        if (currentRow.trim()) {
          rows.push(currentRow);
        }
        
        if (rows.length === 0) return [];
        
        // Parse header
        const header = splitCsvLine(rows[0]).map(h => h.trim());
        const rowsList = [];
        
        // Parse data rows
        for (let i = 1; i < rows.length; i++) {
          let rowStr = rows[i];
          // Some rows exported from the tool (or edited in other tools) may be wrapped
          // in an extra pair of quotes when the first two columns are empty and
          // the comments contain quotes.  For example:
          // ",,Supervisor (Shift/Area),3,3,...,".  In these cases, remove
          // the leading quote and any trailing quote so the split logic works
          // correctly.  Only apply this when the row starts with '"' followed
          // by a comma, indicating an empty Department field preceded by an
          // extraneous quote.
          if (rowStr && rowStr.startsWith('",')) {
            // Drop the first character (the extraneous quote)
            rowStr = rowStr.substring(1);
            // If the row ends with an unescaped quote, drop it as well
            if (rowStr.endsWith('"')) {
              rowStr = rowStr.substring(0, rowStr.length - 1);
            }
          }
          const vals = splitCsvLine(rowStr);
          const obj = {};
          for (let j = 0; j < header.length; j++) {
            obj[header[j]] = vals[j] !== undefined ? vals[j] : '';
          }
          rowsList.push(obj);
        }
        
        return rowsList;
      }

      // Compute averages and combine comments across all selected files
      function processFiles() {
        if (!selectedFiles || selectedFiles.length === 0) {
          alert('Please select one or more CSV files to process.');
          return;
        }
        const promises = selectedFiles.map(file => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(evt) {
              try {
                const rowsList = parseCsv(evt.target.result);
                resolve(rowsList);
              } catch (err) {
                reject(err);
              }
            };
            reader.onerror = function() {
              reject(reader.error);
            };
            reader.readAsText(file);
          });
        });
        Promise.all(promises).then(allData => {
          // Aggregate by role area
          const agg = {};
          allData.forEach(dataRows => {
            dataRows.forEach(r => {
              // Determine the role/role area field name
              const role = r['Role Area'] || r['Role'] || r['roleArea'] || r['RoleArea'] || '';
              if (!role) return;
              if (!agg[role]) {
                // Initialise aggregation object with sums and counts for each metric.  Missing values will be
                // ignored by incrementing the corresponding count only when a numeric value is present.
                agg[role] = {
                  count: 0,
                  roleArea: role,
                  // criticality
                  critSum: 0,
                  critCount: 0,
                  // overall capability average
                  capSum: 0,
                  capCount: 0,
                  // retention risk
                  retSum: 0,
                  retCount: 0,
                  // subcapability sums and counts
                  capTechSum: 0,
                  capTechCount: 0,
                  capExperienceSum: 0,
                  capExperienceCount: 0,
                  capCrisisSum: 0,
                  capCrisisCount: 0,
                  capLeadCommSum: 0,
                  capLeadCommCount: 0,
                  capSafetySum: 0,
                  capSafetyCount: 0,
                  capComments: [],
                  retComments: [],
                  extraComments: []
                };
              }
              const entry = agg[role];
              // Count each response as one entry.  We still track the total number of rows for reference.
              entry.count++;
              // Criticality: only accumulate and count if a valid number is provided
              {
                const valRaw = r['Criticality'];
                const critVal = valRaw === undefined || valRaw === null || valRaw.trim() === '' ? NaN : parseFloat(valRaw);
                if (!isNaN(critVal)) {
                  entry.critSum += critVal;
                  entry.critCount++;
                }
              }
              // Capability average: accumulate only when provided
              {
                const capRaw = r['Capability (avg)'] || r['Capability Average'] || r['Capability'];
                const capVal = capRaw === undefined || capRaw === null || capRaw.trim() === '' ? NaN : parseFloat(capRaw);
                if (!isNaN(capVal)) {
                  entry.capSum += capVal;
                  entry.capCount++;
                }
              }
              // Sub capability dimensions.  Accept multiple possible column names.  Accumulate sums and counts only when values are present.
              {
                const techRaw = r['Technical Knowledge'] || r['Technical knowledge'] || r['capTech'];
                const techVal = techRaw === undefined || techRaw === null || techRaw.trim() === '' ? NaN : parseFloat(techRaw);
                if (!isNaN(techVal)) {
                  entry.capTechSum += techVal;
                  entry.capTechCount++;
                }
              }
              {
                const expRaw = r['Experience'] || r['capExperience'];
                const expVal = expRaw === undefined || expRaw === null || expRaw.trim() === '' ? NaN : parseFloat(expRaw);
                if (!isNaN(expVal)) {
                  entry.capExperienceSum += expVal;
                  entry.capExperienceCount++;
                }
              }
              {
                const criRaw = r['Crisis Management'] || r['capCrisis'];
                const criVal = criRaw === undefined || criRaw === null || criRaw.trim() === '' ? NaN : parseFloat(criRaw);
                if (!isNaN(criVal)) {
                  entry.capCrisisSum += criVal;
                  entry.capCrisisCount++;
                }
              }
              {
                const leadRaw = r['Leadership/Communication'] || r['Leadership / Communication'] || r['capLeadComm'];
                const leadVal = leadRaw === undefined || leadRaw === null || leadRaw.trim() === '' ? NaN : parseFloat(leadRaw);
                if (!isNaN(leadVal)) {
                  entry.capLeadCommSum += leadVal;
                  entry.capLeadCommCount++;
                }
              }
              {
                const safetyRaw = r['Safety'] || r['capSafety'];
                const safetyVal = safetyRaw === undefined || safetyRaw === null || safetyRaw.trim() === '' ? NaN : parseFloat(safetyRaw);
                if (!isNaN(safetyVal)) {
                  entry.capSafetySum += safetyVal;
                  entry.capSafetyCount++;
                }
              }
              // Retention risk numeric mapping.  Use uppercase for letters.  Only include in sums if a letter or valid string is provided.
              {
                const ret = (r['Retention Risk'] || r['Retention'] || '').trim();
                let retNum = 0;
                if (/^[lL]/.test(ret) || ret.toLowerCase() === 'low') retNum = 1;
                else if (/^[mM]/.test(ret) || ret.toLowerCase() === 'medium') retNum = 2;
                else if (/^[hH]/.test(ret) || ret.toLowerCase() === 'high') retNum = 3;
                if (retNum > 0) {
                  entry.retSum += retNum;
                  entry.retCount++;
                }
              }
              // Collect comments.  Support consolidated "Comments" field and separate fields.
              let rawComments = (r['Comments'] || r['Comment'] || '').trim();
              if (rawComments) {
                // Convert pipe separators to real newlines. This prevents the '|' character
                // from appearing in consolidated output while still allowing CSV to carry
                // multi-line comments.
                rawComments = rawComments.replace(/\s*\|\s*/g, '\n');
                // Attempt to parse combined comments with headings.  Allow case-insensitive search.
                const lower = rawComments.toLowerCase();
                const capIdx = lower.indexOf('capability:');
                const retIdx = lower.indexOf('retention:');
                const addIdx = lower.indexOf('additional:');
                if (capIdx >= 0 && retIdx >= 0) {
                  const capPart = rawComments.substring(capIdx + 'Capability:'.length, retIdx).trim();
                  let retPart = '';
                  let addPart = '';
                  if (addIdx >= 0) {
                    retPart = rawComments.substring(retIdx + 'Retention:'.length, addIdx).trim();
                    addPart = rawComments.substring(addIdx + 'Additional:'.length).trim();
                  } else {
                    retPart = rawComments.substring(retIdx + 'Retention:'.length).trim();
                  }
                  if (capPart) entry.capComments.push(capPart);
                  if (retPart) entry.retComments.push(retPart);
                  if (addPart) entry.extraComments.push(addPart);
                } else {
                  // Without headings, treat the field as additional comments
                  entry.extraComments.push(rawComments);
                }
              }
              // Separate capability and retention comment fields.  Convert pipe to newline.
              const capComField = ((r['Capability Comment'] || r['CapabilityComment'] || r['capabilityComment'] || '').replace(/\s*\|\s*/g,'\n')).trim();
              if (capComField) {
                entry.capComments.push(capComField);
              }
              // Retrieve retention comments from dedicated columns.  Support
              // multiple possible header names (singular or plural with/without
              // spaces/camelCase) and convert pipe separators back to
              // newlines.  Aggregate them into the retention comments list.
              const retComFieldRaw = (
                r['Retention Comment'] ||
                r['RetentionComment'] ||
                r['retentionComment'] ||
                r['Retention Comments'] ||
                r['RetentionComments'] ||
                r['retentionComments'] ||
                ''
              );
              const retComField = retComFieldRaw.replace(/\s*\|\s*/g, '\n').trim();
              if (retComField) {
                entry.retComments.push(retComField);
              }
            });
          });
          // Reset consolidatedData and build new list
          consolidatedData = [];
          Object.values(agg).forEach(item => {
            // Compute averages using the specific count of entries for each metric.
            // Do not use the overall item.count for these values because missing
            // values should be disregarded rather than averaged with zeros.
            const avgCrit = item.critCount ? item.critSum / item.critCount : null;
            // Compute averages for each capability dimension.  If no entries exist,
            // leave the value null so the downstream logic can handle missing data.
            // Compute raw averages for each capability dimension.  Apply the
            // roundDownHalf function to ensure .5 values are floored.  Leave
            // values null if no entries exist so downstream logic can detect
            // missing data.
            // Average each capability sub-dimension based on its specific count.
            let avgTech  = item.capTechCount    ? (item.capTechSum      / item.capTechCount)    : null;
            let avgExp   = item.capExperienceCount ? (item.capExperienceSum / item.capExperienceCount) : null;
            let avgCri   = item.capCrisisCount  ? (item.capCrisisSum    / item.capCrisisCount)  : null;
            let avgLead  = item.capLeadCommCount? (item.capLeadCommSum  / item.capLeadCommCount): null;
            let avgSafe  = item.capSafetyCount  ? (item.capSafetySum    / item.capSafetyCount)  : null;
            // Convert each capability dimension to the nearest whole number,
            // rounding .5 values down.  This ensures that subdimension averages
            // map cleanly onto the discrete 03 scale used in the assessment.
            avgTech = avgTech != null ? roundNearestWholeHalfDown(avgTech) : null;
            avgExp  = avgExp  != null ? roundNearestWholeHalfDown(avgExp ) : null;
            avgCri  = avgCri  != null ? roundNearestWholeHalfDown(avgCri ) : null;
            avgLead = avgLead != null ? roundNearestWholeHalfDown(avgLead) : null;
            avgSafe = avgSafe != null ? roundNearestWholeHalfDown(avgSafe) : null;
            // Recompute overall capability average from sub dimensions when at least one dimension is provided.
            let avgCap = null;
            const subVals = [avgTech, avgExp, avgCri, avgLead, avgSafe].filter(v => v != null);
            if (subVals.length > 0) {
              const sum = subVals.reduce((a,b) => a + b, 0);
              avgCap = sum / subVals.length;
            } else {
              // Fallback to the provided capability average if sub dimensions are missing.
              // Use the specific capCount instead of overall count to ignore blanks.
              avgCap = item.capCount ? item.capSum / item.capCount : null;
            }
            // Floor .5 values for the overall capability average as well
            if (avgCap != null) {
              avgCap = roundDownHalf(avgCap);
            }
            // Average retention risk only over provided retention entries.  If no retention
            // data was provided, treat the average as 0 so the risk letter will be blank.
            const avgRet = item.retCount ? item.retSum / item.retCount : 0;
            let retLetter = '';
            const roundRet = Math.round(avgRet);
            if (roundRet === 1) retLetter = 'L';
            else if (roundRet === 2) retLetter = 'M';
            else if (roundRet === 3) retLetter = 'H';
            // Deduplicate comments
            const uniq = arr => {
              // Better deduplication that handles multiline entries
              const seen = new Set();
              const unique = [];
              arr.filter(s => s).forEach(comment => {
                // Normalize whitespace for comparison
                const normalized = comment.trim().replace(/\s+/g, ' ');
                if (!seen.has(normalized)) {
                  seen.add(normalized);
                  unique.push(comment); // Keep original formatting
                }
              });
              return unique;
            };
            // Deduplicate capability and retention comments.  Join them with
            // newlines to preserve separate entries.  Additional/general
            // comments are intentionally discarded here to simplify
            // consolidation; any remarks not explicitly associated with
            // capability or retention will not appear in the consolidated
            // dataset.  This addresses user feedback about unexpected
            // "Additional Comments" showing up in consolidated results.
            const capCom = uniq(item.capComments).join('\n');
            const retCom = uniq(item.retComments).join('\n');
            consolidatedData.push({
              roleArea: item.roleArea,
              criticality: avgCrit != null ? parseFloat(avgCrit.toFixed(1)) : null,
              // store each dimension average; round to one decimal if present
              capTech: avgTech != null ? parseFloat(avgTech.toFixed(1)) : null,
              capExperience: avgExp != null ? parseFloat(avgExp.toFixed(1)) : null,
              capCrisis: avgCri != null ? parseFloat(avgCri.toFixed(1)) : null,
              capLeadComm: avgLead != null ? parseFloat(avgLead.toFixed(1)) : null,
              capSafety: avgSafe != null ? parseFloat(avgSafe.toFixed(1)) : null,
              capabilityAvg: avgCap != null ? parseFloat(avgCap.toFixed(1)) : null,
              retentionRisk: retLetter,
              capabilityComment: capCom,
              retentionComment: retCom
            });
          });
          renderConsolidatedTable();
        }).catch(err => {
          console.error('Error processing files', err);
          alert('Error processing files: ' + err.message);
        });
      }

      // Clear any selected files and consolidated output.  This allows the user to
      // reset the consolidation view without reloading the page.  It also
      // empties the file input so the same file can be selected again if needed.
      function clearConsolidated() {
        selectedFiles = [];
        consolidatedData = [];
        const inputEl = document.getElementById('uploadInput');
        if (inputEl) {
          inputEl.value = '';
        }
        const out = document.getElementById('consolidatedOutput');
        if (out) out.innerHTML = '';
      }

      // Render the consolidated data into an HTML table within the consolidation view
      function renderConsolidatedTable() {
        const outEl = document.getElementById('consolidatedOutput');
        if (!outEl) return;
        if (!consolidatedData || !consolidatedData.length) {
          outEl.innerHTML = '<p>No data to display.</p>';
          return;
        }
        let html = '<table style="width:100%; border-collapse:collapse; font-size:0.8rem;">';
        html += '<thead><tr>' +
          '<th style="border:1px solid #ccc; padding:4px;">Role Area</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Criticality</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Technical knowledge</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Experience</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Crisis management</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Leadership &amp; Communication</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Safety mindset</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Capability Avg</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Retention Risk</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Capability Comments</th>' +
          '<th style="border:1px solid #ccc; padding:4px;">Retention Comments</th>' +
          '</tr></thead>';
        html += '<tbody>';
        consolidatedData.forEach(r => {
          // Determine RAG classes based on average scores and retention risk. Use
          // bucketCapability for each numeric capability dimension. Null or
          // missing values result in no class being applied.
          const critClass = (r.criticality != null ? ('crit-' + Math.round(r.criticality)) : '');
          const techClass = (r.capTech != null ? ('cap-' + bucketCapability(r.capTech)) : '');
          const expClass  = (r.capExperience != null ? ('cap-' + bucketCapability(r.capExperience)) : '');
          const criClass  = (r.capCrisis != null ? ('cap-' + bucketCapability(r.capCrisis)) : '');
          const leadClass = (r.capLeadComm != null ? ('cap-' + bucketCapability(r.capLeadComm)) : '');
          const safeClass = (r.capSafety != null ? ('cap-' + bucketCapability(r.capSafety)) : '');
          const capBucket = (r.capabilityAvg != null ? bucketCapability(r.capabilityAvg) : null);
          const capClass  = (capBucket != null ? ('cap-' + capBucket) : '');
          const retVal    = (r.retentionRisk || '').toString().trim();
          const retClass  = retVal ? ('ret-' + retVal) : '';
          html += '<tr>' +
            '<td style="border:1px solid #ccc; padding:4px;">' + (r.roleArea || '') + '</td>' +
            '<td class="' + critClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.criticality != null ? r.criticality.toFixed(1) : '') + '</td>' +
            '<td class="' + techClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capTech != null ? r.capTech.toFixed(1) : '') + '</td>' +
            '<td class="' + expClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capExperience != null ? r.capExperience.toFixed(1) : '') + '</td>' +
            '<td class="' + criClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capCrisis != null ? r.capCrisis.toFixed(1) : '') + '</td>' +
            '<td class="' + leadClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capLeadComm != null ? r.capLeadComm.toFixed(1) : '') + '</td>' +
            '<td class="' + safeClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capSafety != null ? r.capSafety.toFixed(1) : '') + '</td>' +
            '<td class="' + capClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '') + '</td>' +
            '<td class="' + retClass + '" style="border:1px solid #ccc; padding:4px; text-align:center;">' + (retVal || '') + '</td>' +
            '<td style="border:1px solid #ccc; padding:4px; white-space:pre-wrap;">' + (r.capabilityComment || '') + '</td>' +
            '<td style="border:1px solid #ccc; padding:4px; white-space:pre-wrap;">' + (r.retentionComment || '') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        outEl.innerHTML = html;
      }

      // Export the consolidated data to a CSV file
      function downloadConsolidated() {
        if (!consolidatedData || !consolidatedData.length) {
          alert('No consolidated data to download.');
          return;
        }
        // Construct header with each sub-dimension and overall capability average.
        const header = [
          'Role Area',
          'Criticality',
          'Technical knowledge (avg)',
          'Experience (avg)',
          'Crisis management (avg)',
          'Leadership & Communication (avg)',
          'Safety mindset (avg)',
          'Capability (avg)',
          'Retention Risk',
          'Capability Comment',
          'Retention Comment'
        ];
        const lines = [];
        lines.push(header.join(','));
        consolidatedData.forEach(r => {
          const values = [
            r.roleArea || '',
            r.criticality != null ? r.criticality.toFixed(1) : '',
            r.capTech != null ? r.capTech.toFixed(1) : '',
            r.capExperience != null ? r.capExperience.toFixed(1) : '',
            r.capCrisis != null ? r.capCrisis.toFixed(1) : '',
            r.capLeadComm != null ? r.capLeadComm.toFixed(1) : '',
            r.capSafety != null ? r.capSafety.toFixed(1) : '',
            r.capabilityAvg != null ? r.capabilityAvg.toFixed(1) : '',
            r.retentionRisk || '',
            '"' + (r.capabilityComment || '').replace(/"/g, '""') + '"',
            '"' + (r.retentionComment || '').replace(/"/g, '""') + '"'
          ];
          lines.push(values.join(','));
        });
        const csvContent = '\uFEFF' + lines.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const filename = 'consolidated_responses_' + now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + '.csv';
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Replace the current data rows with the consolidated dataset and redraw the table
      function updateToolData() {
        if (!consolidatedData || !consolidatedData.length) {
          alert('No consolidated data to update.');
          return;
        }
        // Map consolidated rows back into the format expected by the worksheet
        rows = consolidatedData.map((r, idx) => {
          const obj = {
            department: null,
            cluster: null,
            roleArea: r.roleArea,
            criticality: r.criticality != null ? r.criticality : null,
            // assign averaged capability dimensions if provided.  Round
            // each dimension to the nearest whole number (half values
            // round down) so they map onto the discrete rating scale used
            // in the worksheet. Without this, fractional values (e.g. 1.2)
            // appear as dashes when imported.
            capTech: r.capTech != null ? roundNearestWholeHalfDown(r.capTech) : null,
            capExperience: r.capExperience != null ? roundNearestWholeHalfDown(r.capExperience) : null,
            capCrisis: r.capCrisis != null ? roundNearestWholeHalfDown(r.capCrisis) : null,
            capLeadComm: r.capLeadComm != null ? roundNearestWholeHalfDown(r.capLeadComm) : null,
            capSafety: r.capSafety != null ? roundNearestWholeHalfDown(r.capSafety) : null,
            // Convert any pipe separators back to newlines to ensure
            // multiline comments display correctly in the tool.
            capabilityComment: (r.capabilityComment || '').replace(/\s*\|\s*/g, '\n'),
            retentionRisk: r.retentionRisk || '',
            retentionComment: (r.retentionComment || '').replace(/\s*\|\s*/g, '\n'),
            // Discard any consolidated general comments.  The tool no longer
            // stores a separate "Additional Comments" field when updating
            // from consolidated data.
            preferredMethod: '-',
            gapMethodComment: ''
          };
          obj.id = idx;
          // compute capabilityAvg from sub dimensions when available
          const subVals = [obj.capTech, obj.capExperience, obj.capCrisis, obj.capLeadComm, obj.capSafety].filter(v => v != null);
          if (subVals.length > 0) {
            const sum = subVals.reduce((a,b) => a + b, 0);
            // Compute raw average and floor any half values before rounding to
            // one decimal place.  Without this adjustment, an exact .5 average
            // (e.g. 0.5, 1.5, 2.5) would be rendered as a dash when imported
            // back into the main assessment view.
            let avg = sum / subVals.length;
            avg = roundDownHalf(avg);
            obj.capabilityAvg = parseFloat(avg.toFixed(1));
          } else {
            obj.capabilityAvg = (r.capabilityAvg != null ? r.capabilityAvg : null);
          }
          obj.capabilityBucket = bucketCapability(obj.capabilityAvg);
          obj.overallRisk = computeOverallRisk(obj);
          return obj;
        });
        // Persist changes
        saveData();
        // Re-render table to reflect new data
        renderTable();
        // Force comprehensive color reapplication after consolidation
        // Use a timeout to ensure DOM is fully updated
        setTimeout(() => {
          reapplyAllColors();
        }, 100);
        // Return to the site view
        const consDiv = document.getElementById('consolidationView');
        const siteDiv = document.getElementById('siteContent');
        if (consDiv) consDiv.style.display = 'none';
        if (siteDiv) siteDiv.style.display = '';
      }

      // Wire up process, download and update buttons on DOM ready
      document.addEventListener('DOMContentLoaded', function() {
        const processBtn = document.getElementById('processBtn');
        if (processBtn) processBtn.addEventListener('click', processFiles);
        const downloadBtn = document.getElementById('downloadConsolidatedBtn');
        if (downloadBtn) downloadBtn.addEventListener('click', downloadConsolidated);
        const updateBtn = document.getElementById('updateToolBtn');
        if (updateBtn) updateBtn.addEventListener('click', updateToolData);
        const clearBtn = document.getElementById('clearConsolidatedBtn');
        if (clearBtn) clearBtn.addEventListener('click', clearConsolidated);

        // Wire up start page actions: secure ZIP export, save, print, upload responses.  Some
        // buttons may not exist depending on the view.  When present, assign
        // appropriate handlers to mirror site view functionality.
        const saveStart = document.getElementById('saveVersionStartBtn');
        if (saveStart) saveStart.addEventListener('click', saveCurrentVersion);
        const printStart = document.getElementById('printStartBtn');
        if (printStart) printStart.addEventListener('click', () => { window.print(); });
        const uploadStart = document.getElementById('uploadResponsesStartBtn');
        if (uploadStart) uploadStart.addEventListener('click', showConsolidation);

        // Also wire the site-level upload button if present.  This button is
        // hidden by default and only displayed on the start page.
        const uploadSite = document.getElementById('uploadResponsesBtn');
        if (uploadSite) uploadSite.addEventListener('click', showConsolidation);
      });
      // Print
      document.getElementById('printBtn').addEventListener('click', () => {
        window.print();
      });
      // Save: allow downloading a copy of the tool with current data embedded
      document.getElementById('saveVersion').addEventListener('click', saveCurrentVersion);

    // Attach handlers for secure ZIP export buttons.  These buttons call
    // client-side functions that build a CSV from the assessment rows,
    // create a password-protected ZIP archive in the browser using the
    // zip.js library (AES256 encryption), and initiate a download.
    // The zip.js library is loaded on demand if it is not already present.
    const secureSiteBtn = document.getElementById('exportSecureBtn');
    if (secureSiteBtn) {
      secureSiteBtn.addEventListener('click', function() {
        prepareSecureZipCurrentSite();
      });
    }
    const secureStartBtn = document.getElementById('exportSecureStartBtn');
    if (secureStartBtn) {
      secureStartBtn.addEventListener('click', function() {
        prepareSecureZipAllSites();
      });
    }

      // Utility functions to toggle toolbar actions based on the current
      // view.  On the welcome page we hide worksheet-specific controls
      // (Manage Roles, Show Summary) and show the upload and start-specific
      // Save/Print buttons and toggle secure export.  When viewing a site, we perform the
      // opposite: hide upload/start controls and show Manage Roles and
      // Show Summary.
      window.updateTopActionsForStart = function() {
        // Hide site-specific buttons
        const manageBtn = document.getElementById('manageRolesBtn');
        if (manageBtn) manageBtn.style.display = 'none';
        const summaryBtn = document.getElementById('toggleSummary');
        if (summaryBtn) summaryBtn.style.display = 'none';
        // Show start-specific buttons
        const saveStart = document.getElementById('saveVersionStartBtn');
        if (saveStart) saveStart.style.display = '';
        const printStart = document.getElementById('printStartBtn');
        if (printStart) printStart.style.display = '';
        const uploadStart = document.getElementById('uploadResponsesStartBtn');
        if (uploadStart) uploadStart.style.display = '';
        // Hide site-specific export/save/print if present
        const saveSite = document.getElementById('saveVersion');
        if (saveSite) saveSite.style.display = 'none';
        const printSite = document.getElementById('printBtn');
        if (printSite) printSite.style.display = 'none';
        // Hide the site-level secure export
        const secureSite = document.getElementById('exportSecureBtn');
        if (secureSite) secureSite.style.display = 'none';
        // Show the start-level secure export
        const secureStart = document.getElementById('exportSecureStartBtn');
        if (secureStart) secureStart.style.display = '';
        // Also ensure upload button inside site toolbar is hidden
        const uploadSite = document.getElementById('uploadResponsesBtn');
        if (uploadSite) uploadSite.style.display = 'none';
      };

      window.updateTopActionsForSite = function() {
        // Show site-specific buttons
        const manageBtn = document.getElementById('manageRolesBtn');
        if (manageBtn) manageBtn.style.display = '';
        const summaryBtn = document.getElementById('toggleSummary');
        if (summaryBtn) summaryBtn.style.display = '';
        const saveSite = document.getElementById('saveVersion');
        if (saveSite) saveSite.style.display = '';
        const printSite = document.getElementById('printBtn');
        if (printSite) printSite.style.display = '';
        // Show site-level secure export
        const secureSite = document.getElementById('exportSecureBtn');
        if (secureSite) secureSite.style.display = '';
        // Hide start-level secure export
        const secureStart = document.getElementById('exportSecureStartBtn');
        if (secureStart) secureStart.style.display = 'none';
        // Hide start-specific buttons
        const saveStart = document.getElementById('saveVersionStartBtn');
        if (saveStart) saveStart.style.display = 'none';
        const printStart = document.getElementById('printStartBtn');
        if (printStart) printStart.style.display = 'none';
        const uploadStart = document.getElementById('uploadResponsesStartBtn');
        if (uploadStart) uploadStart.style.display = 'none';
        // Show/hide upload button: hidden on site
        const uploadSite = document.getElementById('uploadResponsesBtn');
        if (uploadSite) uploadSite.style.display = 'none';
      };

      // ------------------------ Role Management & Lock Functionality ------------------------
      // Define a template for new rows with default values: criticality and all capability fields set to 1,
      // retention risk set to Low ("L"), and empty comments.  This helper ensures new roles start with the same baseline.
      function defaultRowTemplate(roleName) {
        return {
          roleArea: roleName || '',
          criticality: 1,
          capTech: 1,
          capExperience: 1,
          capCrisis: 1,
          capLeadComm: 1,
          capSafety: 1,
          retentionRisk: 'L',
          capabilityComment: '',
          retentionComment: '',
          comments: '',
          preferredMethod: '-',
          gapMethodComment: ''
        };
      }

      // Persist and restore lock state using localStorage with a dedicated key
      const LOCK_KEY = 'plant_skills_lock';

      function loadLock() {
        try {
          const val = localStorage.getItem(LOCK_KEY);
          structureLocked = (val === 'true');
        } catch (ex) {
          structureLocked = false;
        }
      }
      function saveLock() {
        try {
          localStorage.setItem(LOCK_KEY, structureLocked ? 'true' : 'false');
        } catch (ex) {}
      }

      // Update UI elements (manage roles button and toggle) based on lock state
      function updateLockUI() {
        const toggleEl = document.getElementById('lockStructureToggle');
        if (toggleEl) toggleEl.checked = !!structureLocked;
        const manageBtnEl = document.getElementById('manageRolesBtn');
        if (manageBtnEl) manageBtnEl.style.display = structureLocked ? 'none' : '';
      }

      // -------------------------------- Secure ZIP Export Functions --------------------------------
      /**
       * Export the current site's assessment data to a password-protected
       * ZIP archive via a server endpoint.  The server must be running
       * locally as described in server_zip_option.py.  This function
       * gathers the current rows array, prompts the user for a password,
       * and sends the data to the server.  On success it triggers a
       * download of the returned zip file.
       */
      /**
       * Build a CSV string from an array of row objects. The header
       * matches the column ordering of the assessment table. Values
       * containing commas, quotes, or newlines are safely quoted.
       *
       * @param {Array<Object>} rowsArray Rows with assessment data.
       * @returns {string} A CSV formatted string.
       */
      function buildCsvFromRows(rowsArray) {
        const header = [
          'Role Area','Criticality',
          'Technical knowledge','Experience','Crisis management',
          'Leadership & Communication','Safety mindset',
          'Capability (avg)','Retention Risk','Comments'
        ];
        const csvLines = [header.join(',')];
        (rowsArray || []).forEach(function(r) {
          // Collect comments into one cell, separate fields with pipe
          const commentsParts = [];
          if (r.capabilityComment) commentsParts.push('Capability: ' + String(r.capabilityComment).replace(/\r?\n/g, ' '));
          if (r.retentionComment)  commentsParts.push('Retention: ' + String(r.retentionComment).replace(/\r?\n/g, ' '));
          if (r.comments)          commentsParts.push('Additional: ' + String(r.comments).replace(/\r?\n/g, ' '));
          const row = [
            r.roleArea || '',
            r.criticality != null ? r.criticality : '',
            r.capTech != null ? r.capTech : '',
            r.capExperience != null ? r.capExperience : '',
            r.capCrisis != null ? r.capCrisis : '',
            r.capLeadComm != null ? r.capLeadComm : '',
            r.capSafety != null ? r.capSafety : '',
            (r.capabilityAvg != null ? parseFloat(r.capabilityAvg).toFixed(1) : ''),
            r.retentionRisk || '',
            commentsParts.join(' | ')
          ];
          csvLines.push(row.map(function(v) {
            const s = String(v == null ? '' : v);
            return /[",\n]/.test(s) ? ('"' + s.replace(/"/g, '""') + '"') : s;
          }).join(','));
        });
        return csvLines.join('\r\n');
      }

      /**
       * Provide a default plain text instructions file explaining how
       * to handle the exported data and how to reupload it to the tool.
       *
       * @returns {string} A plain text string with instructions.
       */
      function buildInstructionsText() {
        return [
          'DATA PROTECTION & HANDLING',
          '',
          'This archive contains sensitive assessment data in CSV format.',
          'It is protected with a password to open.',
          '',
          'Best practice:',
          ' Do not email this ZIP and its password in the same message.',
          ' Store only in approved locations (SharePoint/OneDrive/Drive).',
          ' Delete temporary CSVs after re-uploading into the tool.',
          ' Do not share the password outside the authorized group.',
          '',
          'How to re-upload:',
          '1) Extract the zip using the password.',
          '2) Open the CSV in Excel (or a text editor) to confirm the content.',
          '3) In the web tool, click Upload responses and select the CSV.',
          ''
        ].join('\r\n');
      }

      /**
       * Create a password-protected ZIP archive (AES-256) containing the
       * assessment data CSV and instructions text. Ensures the zip.js
       * library is available before creating the archive. Returns a Blob that can be
       * downloaded.  If the zip API is unavailable, throws an error.
       *
       * @param {string} password The password to encrypt the zip.
       * @param {string} csvText The CSV content.
       * @param {string} instructionsText The instructions content.
       * @param {string} millName Prefix used for the CSV filename inside the ZIP.
       * @returns {Promise<Blob>}
       */
      async function createSecureZipBlob(password, csvText, instructionsText, millName) {
        await ensureZipJsLoaded();
        if (typeof zip === 'undefined' || !zip.ZipWriter || !zip.BlobWriter) {
          throw new Error('zip.js library could not be initialised. Ensure zip-full.min.js is available or that the page can access the internet.');
        }
        const blobWriter = new zip.BlobWriter('application/zip');
        const writer = new zip.ZipWriter(blobWriter, {
          password: safePassword,
          encryptionStrength: 3,
          level: 0
        });
        const csvName = (millName || 'assessment') + '_assessment_data.csv';
        // Add CSV file - entry inherits AES-256 settings from the writer configuration.
        await writer.add(csvName,
          new zip.TextReader(csvText != null ? String(csvText) : ''),
          { lastModDate: new Date() });
        // Add instructions file using the same encryption settings.
        await writer.add('instructions.txt',
          new zip.TextReader(instructionsText != null ? String(instructionsText) : ''),
          { lastModDate: new Date() });
        const zipBlob = await writer.close();
        return zipBlob;
      }

      const secureExportModal = document.getElementById('secureExportModal');
      const secureExportContextText = document.getElementById('secureExportContext');
      const secureExportPasswordInput = document.getElementById('secureExportPassword');
      const secureExportPasswordConfirmInput = document.getElementById('secureExportPasswordConfirm');
      const secureExportErrorBox = document.getElementById('secureExportError');
      const secureExportToast = document.getElementById('secureExportToast');
      const secureExportSubmitBtn = document.getElementById('secureExportSubmit');
      const secureExportCancelBtn = document.getElementById('secureExportCancel');
      let secureExportConfirmHandler = null;
      let secureExportToastTimer = null;

      function hideSecureExportError() {
        if (secureExportErrorBox) {
          secureExportErrorBox.style.display = 'none';
          secureExportErrorBox.textContent = '';
        }
      }

      function showSecureExportError(message) {
        if (!secureExportErrorBox) return;
        if (message) {
          secureExportErrorBox.textContent = message;
          secureExportErrorBox.style.display = 'block';
        } else {
          hideSecureExportError();
        }
      }

      function resetSecureExportModal() {
        if (secureExportPasswordInput) secureExportPasswordInput.value = '';
        if (secureExportPasswordConfirmInput) secureExportPasswordConfirmInput.value = '';
        hideSecureExportError();
      }

      function validateSecureExportPassword(password, confirmation) {
        if (!password) {
          return 'Password is required.';
        }
        if (password.length < 8) {
          return 'Use at least 8 characters for the password.';
        }
        if (!/[A-Za-z]/.test(password) || !/[0-9]/.test(password)) {
          return 'Include both letters and numbers in the password.';
        }
        if (password !== confirmation) {
          return 'Passwords do not match. Please re-enter them.';
        }
        return '';
      }

      function openSecureExportModal(contextText, onConfirm) {
        if (!secureExportModal) {
          const fallback = prompt('Enter a password to protect the archive:');
          if (!fallback || !fallback.trim()) {
            showSecureExportToast('error', 'Password is required. Export cancelled.');
            return;
          }
          if (typeof onConfirm === 'function') {
            onConfirm(fallback.trim());
          }
          return;
        }
        secureExportConfirmHandler = onConfirm;
        if (secureExportContextText) {
          secureExportContextText.textContent = contextText || 'Create a secure ZIP export.';
        }
        resetSecureExportModal();
        secureExportModal.classList.add('active');
        setTimeout(() => {
          if (secureExportPasswordInput) secureExportPasswordInput.focus();
        }, 30);
      }

      function closeSecureExportModal() {
        if (!secureExportModal) return;
        secureExportModal.classList.remove('active');
        secureExportConfirmHandler = null;
        resetSecureExportModal();
      }

      function hideSecureExportToast() {
        if (!secureExportToast) return;
        secureExportToast.className = 'secure-export-toast';
        secureExportToast.textContent = '';
      }

      function showSecureExportToast(type, message) {
        if (!secureExportToast || !message) return;
        clearTimeout(secureExportToastTimer);
        secureExportToast.className = 'secure-export-toast show ' + (type || 'info');
        secureExportToast.textContent = message;
        secureExportToastTimer = setTimeout(() => {
          hideSecureExportToast();
        }, 5500);
      }

      function handleSecureExportSubmit() {
        if (!secureExportPasswordInput || !secureExportPasswordConfirmInput) return;
        const password = secureExportPasswordInput.value.trim();
        const confirmation = secureExportPasswordConfirmInput.value.trim();
        const validationMessage = validateSecureExportPassword(password, confirmation);
        if (validationMessage) {
          showSecureExportError(validationMessage);
          return;
        }
        hideSecureExportError();
        const handler = secureExportConfirmHandler;
        closeSecureExportModal();
        if (typeof handler === 'function') {
          try {
            const maybePromise = handler(password);
            if (maybePromise && typeof maybePromise.then === 'function') {
              maybePromise.catch(err => {
                showSecureExportToast('error', 'Failed to create ZIP: ' + (err && err.message ? err.message : 'Unknown error.'));
              });
            }
          } catch (err) {
            showSecureExportToast('error', 'Failed to create ZIP: ' + (err && err.message ? err.message : 'Unknown error.'));
          }
        }
      }

      if (secureExportSubmitBtn) {
        secureExportSubmitBtn.addEventListener('click', handleSecureExportSubmit);
      }
      if (secureExportCancelBtn) {
        secureExportCancelBtn.addEventListener('click', () => {
          closeSecureExportModal();
        });
      }
      if (secureExportModal) {
        secureExportModal.addEventListener('click', (event) => {
          if (event.target === secureExportModal) {
            closeSecureExportModal();
          }
        });
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && secureExportModal && secureExportModal.classList.contains('active')) {
          event.preventDefault();
          closeSecureExportModal();
        }
        if (event.key === 'Enter' && secureExportModal && secureExportModal.classList.contains('active')) {
          if (event.target === secureExportPasswordInput || event.target === secureExportPasswordConfirmInput) {
            event.preventDefault();
            handleSecureExportSubmit();
          }
        }
      });

      function gatherAllSiteRows() {
        const aggregated = [];
        if (typeof siteNames !== 'undefined' && Array.isArray(siteNames)) {
          siteNames.forEach(function(site) {
            try {
              const key = STORAGE_KEY_PREFIX + site;
              const stored = localStorage.getItem(key);
              let siteRows;
              if (stored) {
                siteRows = JSON.parse(stored);
              } else if (defaultData && Object.prototype.hasOwnProperty.call(defaultData, site)) {
                siteRows = defaultData[site];
              } else {
                siteRows = [];
              }
              if (Array.isArray(siteRows)) {
                siteRows.forEach(function(r) {
                  aggregated.push(r);
                });
              }
            } catch (err) {
              console.warn('Unable to include site in secure export', site, err);
            }
          });
        }
        return aggregated;
      }

      async function downloadSecureArchive(password, rowsForCsv, millName, successMessage) {
        if (!password) {
          showSecureExportToast('error', 'Password is required. Export cancelled.');
          return false;
        }
        if (!rowsForCsv || rowsForCsv.length === 0) {
          showSecureExportToast('error', 'No data available to export.');
          return false;
        }
        showSecureExportToast('info', 'Preparing secure archive');
        try {
          const csvText = buildCsvFromRows(rowsForCsv);
          const instrText = buildInstructionsText();
          const zipBlob = await createSecureZipBlob(password, csvText, instrText, millName);
          const safeName = (millName && millName.trim()) ? millName.trim() : 'assessment';
          const sanitized = safeName.replace(/[^a-z0-9]+/gi, '_').replace(/^_+|_+$/g, '').toLowerCase() || 'assessment';
          const filename = sanitized + '_assessment_' + (new Date().toISOString().slice(0,10)) + '.zip';
          const link = document.createElement('a');
          link.href = URL.createObjectURL(zipBlob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
          showSecureExportToast('success', successMessage || 'Secure ZIP downloaded successfully.');
          return true;
        } catch (err) {
          console.error('Secure ZIP export failed', err);
          showSecureExportToast('error', 'Failed to create ZIP: ' + (err && err.message ? err.message : 'Unknown error.'));
          return false;
        }
      }

      function prepareSecureZipCurrentSite() {
        if (!rows || rows.length === 0) {
          showSecureExportToast('error', 'No data to export. Please start an assessment first.');
          return;
        }
        let millName = '';
        const millInput = document.getElementById('inputMill');
        if (millInput && millInput.value) {
          millName = millInput.value.trim();
        } else if (typeof currentSite !== 'undefined' && currentSite) {
          millName = currentSite;
        }
        const contextLabel = millName ? `Create a secure archive for ${millName}.` : 'Create a secure archive for the current assessment.';
        openSecureExportModal(contextLabel, (password) => exportSecureZipCurrentSite(password, millName));
      }

      async function exportSecureZipCurrentSite(password, presetMillName) {
        let millName = (presetMillName && presetMillName.trim()) ? presetMillName.trim() : '';
        if (!millName) {
          const millInput = document.getElementById('inputMill');
          if (millInput && millInput.value) {
            millName = millInput.value.trim();
          } else if (typeof currentSite !== 'undefined' && currentSite) {
            millName = currentSite;
          }
        }
        if (!millName) {
          millName = 'assessment';
        }
        const messageName = (millName && millName !== 'assessment') ? `${millName}` : 'this assessment';
        await downloadSecureArchive(password, Array.isArray(rows) ? rows.slice() : [], millName, 'Secure ZIP for ' + messageName + ' downloaded.');
      }

      function prepareSecureZipAllSites() {
        const allRows = gatherAllSiteRows();
        if (allRows.length === 0) {
          showSecureExportToast('error', 'No data available to export. Please conduct assessments first.');
          return;
        }
        openSecureExportModal('Create a secure archive that includes every saved plant.', (password) => exportSecureZipAllSites(password));
      }

      async function exportSecureZipAllSites(password) {
        const allRows = gatherAllSiteRows();
        if (allRows.length === 0) {
          showSecureExportToast('error', 'No data available to export. Please conduct assessments first.');
          return;
        }
        await downloadSecureArchive(password, allRows, 'all_plants', 'Secure ZIP containing all plants downloaded.');
      }

      // Show Manage Roles modal, listing all roles with editable names and delete buttons
      function showManageRolesModal() {
        if (structureLocked) return;
        const modal = document.getElementById('manageRolesModal');
        const listDiv = document.getElementById('rolesList');
        if (!modal || !listDiv) return;
        listDiv.innerHTML = '';
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        // Add a Description column so definitions (tooltips) can be edited inline.
        thead.innerHTML = '<tr><th>Role Name</th><th>Description</th><th>Actions</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        rows.forEach((r, idx) => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const inp = document.createElement('input');
          inp.value = r.roleArea || '';
          inp.disabled = structureLocked;
          inp.addEventListener('change', () => {
            const newName = inp.value.trim();
            const oldName = r.roleArea || '';
            // Avoid empty names
            if (!newName) return;
            // When renaming a role, carry over its definition to the new name.
            if (roleDefinitions.hasOwnProperty(oldName)) {
              roleDefinitions[newName] = roleDefinitions[oldName];
              delete roleDefinitions[oldName];
            } else if (!roleDefinitions.hasOwnProperty(newName)) {
              // Initialise blank description if no existing definition exists
              roleDefinitions[newName] = '';
            }
            saveDefinitions();
            r.roleArea = newName;
            saveData();
            renderTable();
            // Reopen modal to reflect updated keys
            showManageRolesModal();
          });
          tdName.appendChild(inp);
          // Description column for editing tooltip text
          const tdDesc = document.createElement('td');
          const descInput = document.createElement('input');
          descInput.type = 'text';
          descInput.value = roleDefinitions[r.roleArea] || '';
          descInput.disabled = structureLocked;
          descInput.addEventListener('change', () => {
            roleDefinitions[r.roleArea] = descInput.value;
            saveDefinitions();
            // Re-render to update tooltips
            renderTable();
          });
          tdDesc.appendChild(descInput);
          // Actions column
          const tdAct = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.disabled = structureLocked;
          delBtn.addEventListener('click', () => {
            if (structureLocked) return;
            rows.splice(idx, 1);
            // Remove definition associated with this role
            if (roleDefinitions.hasOwnProperty(r.roleArea)) {
              delete roleDefinitions[r.roleArea];
              saveDefinitions();
            }
            // Recompute IDs and derived metrics
            rows.forEach((row, i) => {
              row.id = i;
              row.capabilityAvg = computeCapabilityAvg(row);
              row.capabilityBucket = bucketCapability(row.capabilityAvg);
              row.overallRisk = computeOverallRisk(row);
            });
            saveData();
            renderTable();
            showManageRolesModal();
          });
          tdAct.appendChild(delBtn);
          tr.appendChild(tdName);
          tr.appendChild(tdDesc);
          tr.appendChild(tdAct);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        listDiv.appendChild(table);
        modal.style.display = 'block';
      }

      function closeManageRolesModal() {
        const modal = document.getElementById('manageRolesModal');
        if (modal) modal.style.display = 'none';
      }

      // Attach event listeners for Manage Roles and modal controls after DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        // Restore lock state from localStorage or saved defaults
        loadLock();
        // Load any persisted role definitions from localStorage
        loadDefinitions();
        updateLockUI();
        // Check expiry countdown on load and start interval to update banner
        if (typeof checkExpiry === 'function') {
          checkExpiry();
          setInterval(checkExpiry, 60000);
        }
        // Manage Roles button
        const manageBtnEl = document.getElementById('manageRolesBtn');
        if (manageBtnEl) {
          manageBtnEl.addEventListener('click', function() {
            if (!structureLocked) {
              showManageRolesModal();
            }
          });
        }
        // Add Role button inside modal
        const addRoleBtnModal = document.getElementById('addRoleBtnModal');
        if (addRoleBtnModal) {
          addRoleBtnModal.addEventListener('click', function() {
            if (structureLocked) return;
            // Generate a unique default name for new role
            let baseName = 'New Role';
            let newName = baseName;
            let counter = 1;
            const existingNames = rows.map(r => (r.roleArea || '').toLowerCase());
            while (existingNames.includes(newName.toLowerCase())) {
              newName = baseName + ' ' + counter;
              counter++;
            }
            const newRow = defaultRowTemplate(newName);
            rows.push(newRow);
            // Initialise blank description for the new role
            roleDefinitions[newName] = '';
            saveDefinitions();
            // Recompute derived fields and assign IDs
            rows.forEach((row, i) => {
              row.id = i;
              row.capabilityAvg = computeCapabilityAvg(row);
              row.capabilityBucket = bucketCapability(row.capabilityAvg);
              row.overallRisk = computeOverallRisk(row);
            });
            saveData();
            renderTable();
            showManageRolesModal();
          });
        }

        // Close modal button
        const closeModalBtn = document.getElementById('closeRolesModalBtn');
        if (closeModalBtn) {
          closeModalBtn.addEventListener('click', function() {
            closeManageRolesModal();
          });
        }
        // Lock toggle on start page
        const lockToggle = document.getElementById('lockStructureToggle');
        if (lockToggle) {
          lockToggle.addEventListener('change', function() {
            structureLocked = !!lockToggle.checked;
            saveLock();
            updateLockUI();
          });
        }
      });

    })();
  </script>
</body></html>
